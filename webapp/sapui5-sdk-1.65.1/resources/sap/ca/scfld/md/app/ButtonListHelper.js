/*
 * Copyright (C) 2009-2016 SAP SE or an SAP affiliate company. All rights reserved
 */
jQuery.sap.declare("sap.ca.scfld.md.app.ButtonListHelper");jQuery.sap.require("sap.ca.ui.dialog.Dialog");jQuery.sap.require("sap.ca.scfld.md.app.BarOverflow");jQuery.sap.require("sap.ca.scfld.md.app.BarOverflowLayoutData");jQuery.sap.require("sap.m.ButtonType");(function(){var D=jQuery.sap.log.isLoggable(jQuery.sap.log.Level.DEBUG),C="sap.ca.scfld.md.app.ButtonListHelper";function f(e,o){var i,O;for(i=e.length-1;i>=0;i-=1){O=e[i];if(O.oButton===o||O.oSelect===o){return O;}}return null;}function a(e,o){var h,i,m,I=o.id,j,t,T;for(i=0,m=e.length;i<m;i++){h=e[i];if(I===h.getId()){return h;}if(o.icon===h.getIcon()){j=h.getMetadata().getName()==="sap.m.Button";T=h.getTooltip()||h._sTooltip||(j?h.getText():undefined);t=j?h.getText()||h._sTextInActionSheet:o.text;if(o.tooltip===T&&o.text===t){return h;}}}}function g(F,e,A){var o,i,I,m;for(i=0,m=e.length;i<m;i++){o=e[i];if(o.getId()===F){I=o.getMetadata().getName()==="sap.m.Button";return{area:A,pos:i,controlInfo:{icon:o.getIcon(),id:o.getId(),text:(I?o.getText():"")||o._sTextInActionSheet,tooltip:o.getTooltip()||o._sTooltip||(I?o.getText():"")}};}}}function b(e){var i,B,l;for(i=e.length-1;i>=0;i-=1){B=e[i];l=B.getLayoutData();if(l instanceof sap.ca.scfld.md.app.BarOverflowLayoutData&&l.getOverflowButton()){return i;}}}function c(e,s){var i=s,m=e.length,R;while(i<m){R=e[i];if(R.getVisible()){return R;}i++;}i=s-1;while(i>=0){R=e[i];if(R.getVisible()){return R;}i--;}return undefined;}function d(B,A){var t;if(B.sI18nBtnTxt){var o=A.AppI18nModel.getResourceBundle();t=o.getText(B.sI18nBtnTxt);}else{t=B.sBtnTxt;}return t;}function r(e){var B=this.oBar,A=false,o=this.oOverflowList.oActionSheet,h,i,j,I,k;if(e===undefined){h=o.getButtons();I=b(this.oBar.getContentRight());for(i=0;i<h.length;i+=1){j=f(this.aButtons,h[i]);if(j.oSelect){k=j.oSelect;k.setVisible(true);if(j.oButton){j.oButton.setVisible(false);}o.removeButton(h[i]);}else{k=j.oButton;if(k._sTextInBar!==undefined){k.setText(k._sTextInBar);}if(k._sTypeInBar!==undefined){k.setType(k._sTypeInBar);}if(k._sTooltip!==undefined){k.setTooltip(k._sTooltip);}}B.insertContentRight(k,I);I++;}B.getContentRight()[I].setVisible(false);if(o.isOpen()){o.attachEventOnce("afterClose",function(){o.$().remove();});}else{o.$().remove();}}else{e.forEach(function(k){j=f(this.aButtons,k);if(!j){jQuery.sap.log.error("Unsupported control - "+k.toString());}if(j.oSelect){B.removeContentRight(j.oSelect);}if(j.oButton){k=j.oButton;if(k._sTextInActionSheet!==undefined){k.setText(k._sTextInActionSheet);if(k._sTextInActionSheet===k._sTooltip){k.setTooltip("");}}if(k._sTypeInActionSheet!==undefined){k.setType(k._sTypeInActionSheet);}k.setVisible(true);if(j.oSelect){j.oSelect.setVisible(false);}o.addButton(k);A=true;}else{jQuery.sap.log.error("No button representation for control - "+k.toString());}},this);if(A){B.getContentRight()[b(this.oBar.getContentRight())].setVisible(true);}}}sap.ui.base.Object.extend("sap.ca.scfld.md.app.ButtonListHelper",{constructor:function(A,m,e,h,o){this.oApplicationImplementation=A;this.bAutomaticOverflow=h;this.sOverflowId=o;this.oOverflowButton=undefined;this.iMode=m;if(this.iMode==20){this.oBar=new sap.m.Bar();}else if(this.iMode>=10){this.oActionSheet=new sap.m.ActionSheet();this.oActionSheet.setPlacement(sap.m.PlacementType.Top);this.oActionSheet.setShowCancelButton(true);}this.aButtons=[];this.bAllDisabled=e;this.startBuild();if(this.iMode==25){this.sDirection="Left";}else{this.sDirection="Right";}this.mSelections={};},addButtonListHelper:function(B){if(this.oChild){this.oChild.addButtonListHelper(B);}else{this.oChild=B;B.bAllDisabled=this.bAllDisabled;delete B.oModifications;}},findFocusedElement:function(F){var e,E;if(!F){return undefined;}if(F.area==="left"){e=this.oBar&&this.oBar.getContentLeft()||[];E=a(e,F.controlInfo);}else if(F.area==="right"){e=this.oBar&&this.oBar.getContentRight()||[];E=a(e,F.controlInfo);}else if(F.area==="overflow"){e=this.oBar&&this.oBar.getContentRight()||[];E=a(e,F.controlInfo);if(!E&&this.oOverflowList&&this.oOverflowList.oActionSheet){E=a(this.oOverflowList.oActionSheet.getButtons()||[],F.controlInfo);}}if(E){return E;}if(e.length>0){E=c(e,Math.min(F.pos,e.length-1));if(E){return E;}}if(F.area==="left"){e=this.oBar&&this.oBar.getContentRight()||[];return c(e,0);}else{e=this.oBar&&this.oBar.getContentLeft()||[];return c(e,Math.max(0,e.length-1));}},getFocusInfo:function(s){var B=this.oBar,F=sap.ui.getCore().getCurrentFocusedControlId(),o;if(this._focusInfo){o=this._focusInfo;this._focusInfo=undefined;return o;}if(!F){return undefined;}if(this.oOverflowList){o=this.oOverflowList.getFocusInfo();if(o){o.area="overflow";return o;}}return B&&g(F,B.getContentLeft()||[],"left")||B&&g(F,B.getContentRight()||[],"right")||s&&g(F,s.getButtons()||[],"share")||this.oActionSheet&&g(F,this.oActionSheet.getButtons()||[],"action")||this.oClient&&this.oClient.getFocusInfo();},startBuild:function(k){this.mButtons={};this.aCallBacks=[];this.oPositions={iActive:0,iControlPosition:0};this.bHasOverflow=false;if(this.oChild){this.oChild.startBuild(true);}if(this.oOverflowList){this.oOverflowList.startBuild(true);}if(!k){this.oModifications={mChangedEnablements:{},mChangedTexts:{}};}this.aButtons=[];if(this.oActionSheet){this.oActionSheet.destroyButtons();}if(this.oBar){this.oBar.destroyContentRight();this.oBar.destroyContentLeft();}if(this.oBarOverflow){this.oBarOverflow.destroy();delete this.oBarOverflow;}if(this.oOverflowList){this.oOverflowList.destroy();delete this.oOverflowList;}},endBuild:function(){var I;for(var i=this.oPositions.iActive;i<this.aButtons.length;i++){var o=this.aButtons[i];if(o.oButton){o.oButton.setVisible(false);}if(o.oSelect){o.oSelect.setVisible(false);}}if(this.oChild){this.oChild.endBuild();}if(this.oOverflowList){this.oOverflowList.endBuild();}this.bIsOverflowReplaced=false;if(this.oModifications){for(I in this.oModifications.mChangedEnablements){this.setBtnEnabled(I,this.oModifications.mChangedEnablements[I],true);}for(I in this.oModifications.mChangedTexts){this.setBtnText(I,this.oModifications.mChangedTexts[I],true);}}if(this.oBarOverflow){this.oBarOverflow.buttonTextChanged();}},destroy:function(){for(var i=0;i<this.aButtons.length;i++){var o=this.aButtons[i];if(o.oButton){o.oButton.destroy(true);}if(o.oSelect){o.oSelect.destroy(true);}}if(this.oBar){this.oBar.destroy();delete this.oBar;}if(this.oActionSheet){this.oActionSheet.destroy();delete this.oActionSheet;}if(this.oChild){this.oChild.destroy();delete this.oChild;}if(this.oBarOverflow){this.oBarOverflow.destroy();delete this.oBarOverflow;}if(this.oOverflowList){this.oOverflowList.destroy();delete this.oOverflowList;}},addOverflowButton:function(){var A,o,t=this;if(!this.oOverflowList){this.oOverflowList=new sap.ca.scfld.md.app.ButtonListHelper(this.oApplicationImplementation,10);this.oOverflowList.bAllDisabled=this.bAllDisabled;this.oOverflowList.oBarList=this;}this.iOverflowPosition=this.oPositions.iActive;o=this.ensureButton(sap.ca.scfld.md.app.ButtonListHelper.getOverflowMeta(this),"b");this.oOverflowButton=o;this.oOverflowList.oOverflowButton=o;o.setEnabled(true);o.setLayoutData(new sap.ca.scfld.md.app.BarOverflowLayoutData({moveToOverflow:false,stayInOverflow:false,overflowButton:true}));A=this.oOverflowList.oActionSheet;if(this.bAutomaticOverflow&&!this.oBarOverflow){o.setVisible(false);this.oBarOverflow=new sap.ca.scfld.md.app.BarOverflow(this.oBar,A,r.bind(t));}return A;},ensureButton:function(B,t,m){var o;if(m&&this.oPositions.iActive>=m){if(!this.bHasOverflow){this.addOverflowButton();this.bHasOverflow=true;}return this.oOverflowList.ensureButton(B,t);}var i=this.oPositions.iActive;if(i==this.aButtons.length){this.aButtons.push({});}o=this.ensureControlAtPosition(B,t,i,this.oPositions);if(this.bAutomaticOverflow){o.setLayoutData(new sap.ca.scfld.md.app.BarOverflowLayoutData());if(!m){o.getLayoutData().setMoveToOverflow(false);}}return o;},setBtnEnabled:function(i,e,n){if(this.bAllDisabled){return;}var B=this.mButtons[i],o;if(B){B.setEnabled(e);if(B.getMetadata().getName()==="sap.m.Select"){o=f(this.aButtons,B);B=o.oButton;if(B){B.setEnabled(e);}}}else{if(this.oChild){this.oChild.setBtnEnabled(i,e,true);}if(this.oOverflowList){this.oOverflowList.setBtnEnabled(i,e,true);}}if(!n){this.oModifications.mChangedEnablements[i]=e;}},ensureControlAtPosition:function(B,t,e,p){var o=this.aButtons[e],T,s,h,R;if(t=="b"||this.iMode<20){if(o.oSelect){p.iControlPosition=this.oBar["indexOfContent"+this.sDirection](o.oSelect);o.oSelect.setVisible(false);}if(o.oButton){o.oButton.setVisible(true);if(this.oBar){h=this.oBar["indexOfContent"+this.sDirection](o.oButton);if(h>p.iControlPosition){p.iControlPosition=h;}}}else{o.oButton=new sap.m.Button({id:B.sControlId});o.oButton.attachPress(jQuery.proxy(function(E){if(this.aCallBacks[e]){this.aCallBacks[e](E);}},this));p.iControlPosition++;if(this.iMode>=20){this.oBar["insertContent"+this.sDirection](o.oButton,p.iControlPosition);}else if(this.iMode>=10){this.oActionSheet.addButton(o.oButton);}else if(this.iMode==5){this.oBar.insertContentLeft(o.oButton,p.iControlPosition);}}T=d(B,this.oApplicationImplementation);s=T;if(!(this.iMode<20||!B.sIcon)){o.oButton._sTooltip=B.sTooltip||T;o.oButton.setTooltip(o.oButton._sTooltip);T="";}else if(B.sTooltip&&B.sTooltip!==T){o.oButton._sTooltip=B.sTooltip;o.oButton.setTooltip(o.oButton._sTooltip);}o.oButton._sTextInActionSheet=s;o.oButton._sTextInBar=T;if(T!=o.oButton.getText()){o.oButton.setText(T);}o.oButton._sTypeInActionSheet=sap.m.ButtonType.Default;if(this.iMode==20){if(o.oButton.getType()!=B.style){o.oButton.setType(B.style);o.oButton._sTypeInBar=B.style;}}if(t=="b"){this.aCallBacks[e]=B.onBtnPressed;}else{this.aCallBacks[e]=this.getSelectReplacement(B);}R=o.oButton;}else{if(o.oButton){p.iControlPosition=this.oBar["indexOfContent"+this.sDirection](o.oButton);o.oButton.setVisible(false);}if(o.oSelect){o.oSelect.setVisible(true);h=this.oBar["indexOfContent"+this.sDirection](o.oSelect);if(h>p.iControlPosition){p.iControlPosition=h;}var j=o.oSelect.getSelectedKey();o.oSelect.destroyItems();o.oSelect.setSelectedKey(j);}else{o.oSelect=new sap.m.Select({id:B.sControlId?B.sControlId+"_SELECT":undefined});o.oSelect.setType(sap.m.SelectType.IconOnly);o.oSelect.setAutoAdjustWidth(true);o.oSelect.setTooltip(B.sTooltip);p.iControlPosition++;this.oBar["insertContent"+this.sDirection](o.oSelect,p.iControlPosition);o.oSelect.attachChange(jQuery.proxy(function(E){var k=E.getSource().getSelectedKey();if(this.aCallBacks[e]){this.aCallBacks[e](k);}},this));if(this.bAutomaticOverflow&&!o.oButton){o.oButton=new sap.m.Button();o.oButton.setText(d(B,this.oApplicationImplementation));if(B.sIcon){o.oButton.setIcon(B.sIcon);}o.oButton.attachPress(jQuery.proxy(function(E){var k=this.getSelectReplacement(B);if(k){k(E);}},this));o.oButton.setEnabled(!B.bDisabled&&!this.bAllDisabled);}}if(B.sSelectedItemKey){o.oSelect.setSelectedItem(B.sSelectedItemKey);}for(var i=0;i<B.aItems.length;i++){var S=B.aItems[i],I;if(!S.id&&B.sControlId){S.id=o.oSelect.getId()+"_"+i;}I=new sap.ui.core.Item(S);o.oSelect.addItem(I);}if(B.sSelectedItemKey){o.oSelect.setSelectedKey(B.sSelectedItemKey);}this.aCallBacks[e]=B.onChange;R=o.oSelect;}if(B.sIcon!=R.getIcon()){R.setIcon(B.sIcon);}if(B.sId){this.mButtons[B.sId]=R;}R.setEnabled(!B.bDisabled&&!this.bAllDisabled);p.iActive++;return R;},getSelectReplacement:function(B){var s=B.sSelectedItemKey,t=this;return function(e){var I=[];var S=0;for(var i=0;i<B.aItems.length;i++){I.push({itemContent:B.aItems[i].text});if(B.aItems[i].key==s){S=i;}}s=B.aItems[S].key;sap.ca.ui.dialog.selectItem.open({title:e.getSource().getText(),items:I,defaultIndex:S},function(R){var h=t.oActionSheet&&t.oActionSheet.getButtons()||[],F,j=a(h,{icon:B.sIcon,text:B.sBtnTxt,tooltip:B.sTooltip});if(D){jQuery.sap.log.debug("Closed item selection for "+B.sBtnTxt,C);}if(t.oOverflowButton){if(j&&t.oBarList){F=g(j.getId(),h,"overflow");if(F){F.pos=1000;t.oBarList._focusInfo=F;if(D){jQuery.sap.log.debug("Save focus information",JSON.stringify(F),C);}}}t.oOverflowButton.focus();}if(R.selectedIndex>=0){var k=B.aItems[R.selectedIndex].key;if(k!=s){s=k;B.sSelectedItemKey=s;B.onChange(s);}}});};},revertOverflowReplacement:function(){if(this.bIsOverflowReplaced){this.ensureControlAtPosition(sap.ca.scfld.md.app.ButtonListHelper.getOverflowMeta(this),"b",this.iOverflowPosition,{});this.bIsOverflowReplaced=false;}},setBtnText:function(i,t,n){var B=this.mButtons[i],o;if(B){if(B.getMetadata().getName()==="sap.m.Select"){B.setTooltip(t);B._sTooltip=t;o=f(this.aButtons,B);B=o.oButton;}if(B){B.setText(t);B.setTooltip("");B._sTooltip="";if(B._sTextInBar){B._sTextInBar=t;}if(B._sTextInActionSheet){B._sTextInActionSheet=t;}if(this.oBarOverflow){this.oBarOverflow.buttonTextChanged();}}}else{if(this.oChild){this.oChild.setBtnText(i,t,true);}if(this.oOverflowList){this.oOverflowList.setBtnText(i,t,true);}}if(!n){this.oModifications.mChangedTexts[i]=t;}},_getCurrentSelection:function(t,s){if(!this.mSelections[t]){this.mSelections[t]=s;}return this.mSelections[t];},_updateCurrentSelection:function(t,s){this.mSelections[t]=s;}});sap.ca.scfld.md.app.ButtonListHelper.getOverflowMeta=function(o){return{sIcon:"sap-icon://overflow",sControlId:o.sOverflowId,sTooltip:o.oApplicationImplementation.UilibI18nModel.getResourceBundle().getText("MORE"),onBtnPressed:function(e){o.oOverflowList.oActionSheet.openBy(e.getSource());}};};})();
