/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2017 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/core/util/MockServer','sap/apf/utils/utils','sap/apf/utils/parseTextPropertyFile'],function(U,A){'use strict';jQuery.sap.require("jquery.sap.storage");var S=jQuery.sap.storage;return c;function c(b){var m=[];var l=S(S.Type.session);var s={setupConstants:function(_){this.constants={LOCAL_STORAGE_CONFIGURATION:"ApfConfiguration",LOCAL_STORAGE_TEXTS:"ApfTexts",CONFIGURATION_ENTITYSET:"AnalyticalConfigurationQueryResults",TEXTS_ENTITYSET:"TextElementQueryResults",RUNTIME_DATA_PATH:_+"model/apf/",RUNTIME_SERVICE_URL:"/sap/hba/r/apf/core/odata/apf.xsodata/",RUNTIME_SERVICE_METADATA:_+"model/apf/AnalysisPath.xml",PATH_ENTITYSET:"AnalysisPathQueryResults",MODELER_DATA_PATH:_+"model/apf/",CONFIGURATION_SERVICE:"/sap/hba/r/apf/core/odata/modeler/AnalyticalConfiguration.xsodata/",CONFIGURATION_SERVICE_METADATA:_+"model/apf/AnalyticalConfiguration.xml",DEMOKIT_SERVICE_URL:"/tmp/demokit/demokit.xsodata/",DEMOKIT_METADATA:_+"model/data/Demokit.xml",DEMOKIT_DATA_PATH:_+"model/data/",DEMOKIT_HIERARCHY_SERVICE_URL:"/tmp/demokit/hierarchy.xsodata/",DEMOKIT_HIERARCHY_METADATA:_+"model/data/hierarchyMetadata.xml",HIERARCHY_SERVICE_SPEC:{levelProperty:"Customer_Level",hierarchyNode:"Customer_NodeID",parentNode:"Customer_ParentID",measureName:"Revenue"}};},teardownMockserver:function(){m.forEach(function(_){_.stop();_.destroy();});},_getStorage:function(){return l;},getConfigurationId:function(n){var i;var a=n.indexOf(s.constants.LOCAL_STORAGE_CONFIGURATION);if(a!==-1){i=n.slice(a+s.constants.LOCAL_STORAGE_CONFIGURATION.length);}return i;},getAllConfigurationIdsInStorage:function(){var i=[];Object.keys(sessionStorage).forEach(function(n){var a=s.getConfigurationId(n);if(a){i.push(a);}});return i;},getConfigurationFromLocalStorage:function(a){return l.get(s.constants.LOCAL_STORAGE_CONFIGURATION+a);},idIsContained:function(e,i){return e.reduce(function(a,C){return a||C.AnalyticalConfiguration===i;},false);},importTextsFromFile:function(f,a,o){o=o||function(){};jQuery.ajax({url:f,method:"GET",dataType:"text"}).done(function(d){var t=sap.apf.utils.parseTextPropertyFile(d,{instances:{messageHandler:function(){}}});var e=[];t.TextElements.forEach(function(i){e.push(i);});a.setEntitySetData(s.constants.TEXTS_ENTITYSET,e);o(e);}).fail(function(j,t,e){var d="while importing \""+f+"\" jQuery.ajax fails with "+t+",  "+e;jQuery.sap.log.error(e);o({errorText:d,filePath:f});});},mockDemokitService:function(){var a=new sap.ui.core.util.MockServer({rootUri:s.constants.DEMOKIT_SERVICE_URL});a.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,s._postProcessDemokitData);a.simulate(s.constants.DEMOKIT_METADATA,s.constants.DEMOKIT_DATA_PATH);a.start();m.push(a);return a;},_loadAnalyticalConfiguration:function(r){function a(C){var d=C.AnalyticalConfiguration;C.SerializedAnalyticalConfiguration=s.getConfigurationFromLocalStorage(d);C.AnalyticalConfigurationName=JSON.parse(C.SerializedAnalyticalConfiguration).analyticalConfigurationName;}var C=r.mParameters.oEntry;if(C){if(C.SerializedAnalyticalConfiguration&&C.AnalyticalConfigurationName){a(C);}}else if(jQuery.isArray(r.mParameters.oFilteredData.results)){var e=r.mParameters.oFilteredData.results;e.forEach(function(C){a(C);});}},_initialLoadConfigurationsToMockServer:function(a,d){function i(_,g){for(var h in _){if(_.hasOwnProperty(h)){g(_[h]);}}}var r=[];s.getAllConfigurationIdsInStorage().forEach(function(g){var h=s.getConfigurationFromLocalStorage(g);var C=JSON.parse(h);f(C);});i(d,f);i(d,e);a.setEntitySetData("AnalyticalConfigurationQueryResults",r);function e(C){var g=C.configHeader.AnalyticalConfiguration;if(!s.getConfigurationFromLocalStorage(g)){var h=JSON.stringify(C);l.put(s.constants.LOCAL_STORAGE_CONFIGURATION+g,h);}}function f(C){var g=C.configHeader.AnalyticalConfiguration;if(s.idIsContained(r,g)){return;}var h=JSON.stringify(C);var j={AnalyticalConfiguration:g,Application:C.configHeader.Application,AnalyticalConfigurationName:C.configHeader.AnalyticalConfigurationName,SerializedAnalyticalConfiguration:h,CreationUTCDateTime:"/Date(1478533989544)/",LastChangeUTCDateTime:"/Date(1478533989544)/",CreatedByUser:"demokit engine",LastChangedByUser:null};r.push(j);}},savePath:function(r){var B=r.mParameters.oXhr.requestBody;var o=JSON.parse(B);if(!o.AnalysisPath){o.AnalysisPath=sap.apf.utils.createPseudoGuid();}if(!o.CreationUTCDateTime){o.CreationUTCDateTime="/Date("+new Date().getTime()+")/";}if(!o.LastChangeUTCDateTime){o.LastChangeUTCDateTime="/Date("+new Date().getTime()+")/";}r.mParameters.oXhr.requestBody=JSON.stringify(o);},mockRuntimeService:function(a){var d=new U({rootUri:s.constants.RUNTIME_SERVICE_URL});d.attachBefore(sap.ui.core.util.MockServer.HTTPMETHOD.PUT,s.savePath,s.constants.PATH_ENTITYSET);d.attachBefore(sap.ui.core.util.MockServer.HTTPMETHOD.POST,s.savePath,s.constants.PATH_ENTITYSET);d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,s._loadAnalyticalConfiguration,s.constants.CONFIGURATION_ENTITYSET);d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,s.loadTexts,s.constants.TEXTS_ENTITYSET);d.simulate(s.constants.RUNTIME_SERVICE_METADATA,s.constants.RUNTIME_DATA_PATH);m.push(d);d.start();s._initialLoadConfigurationsToMockServer(d,a);return d;},mockConfigurationService:function(a){var d=new U({rootUri:s.constants.CONFIGURATION_SERVICE});d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,s._loadAnalyticalConfiguration,s.constants.CONFIGURATION_ENTITYSET);d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.PUT,s.saveAnalyticalConfiguration.bind(null,"PUT"),s.constants.CONFIGURATION_ENTITYSET);d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.POST,s.saveAnalyticalConfiguration.bind(null,"POST"),s.constants.CONFIGURATION_ENTITYSET);d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.POST,s.saveText,s.constants.TEXTS_ENTITYSET);d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.PUT,s.saveText,s.constants.TEXTS_ENTITYSET);d.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,s.loadTexts,s.constants.TEXTS_ENTITYSET);d.simulate(s.constants.CONFIGURATION_SERVICE_METADATA,s.constants.MODELER_DATA_PATH);m.push(d);d.start();s._initialLoadConfigurationsToMockServer(d,a);return d;},saveAnalyticalConfiguration:function(a,r){var d=r.mParameters.oEntity.SerializedAnalyticalConfiguration;var C;var e=r.mParameters.oEntity.AnalyticalConfiguration;if(a==="POST"){e=sap.apf.utils.createPseudoGuid();r.mParameters.oEntity.AnalyticalConfiguration=e;C=JSON.parse(d);C.configHeader.AnalyticalConfiguration=e;d=JSON.stringify(C);r.mParameters.oEntity.SerializedAnalyticalConfiguration=d;}l.put(s.constants.LOCAL_STORAGE_CONFIGURATION+e,d);},saveText:function(r){r.mParameters.oEntity=r.mParameters.oEntity||{};if(!sap.apf.utils.isValidGuid(r.mParameters.oEntity.TextElement)){r.mParameters.oEntity.TextElement=sap.apf.utils.createPseudoGuid();}var t=l.get(s.constants.LOCAL_STORAGE_TEXTS);if(!t){t=[];}else{t=JSON.parse(t);}t.push({TextElement:r.mParameters.oEntity.TextElement,TextElementDescription:r.mParameters.oEntity.TextElementDescription,MaximumLength:r.mParameters.oEntity.MaximumLength,TextElementType:r.mParameters.oEntity.TextElementType});l.put(s.constants.LOCAL_STORAGE_TEXTS,JSON.stringify(t));},loadTexts:function(r){var t=l.get(s.constants.LOCAL_STORAGE_TEXTS);if(t){r.mParameters.oFilteredData=r.mParameters.oFilteredData||{};r.mParameters.oFilteredData.results=r.mParameters.oFilteredData.results||[];t=JSON.parse(t);t.forEach(function(a){r.mParameters.oFilteredData.results.push(a);});}},mockHierarchyService:function(){var h=jQuery.sap.sjax({url:s.constants.DEMOKIT_DATA_PATH+"RevenueHryQueryResults.json",dataType:"json"}).data;var a=new sap.ui.core.util.MockServer({rootUri:s.constants.DEMOKIT_HIERARCHY_SERVICE_URL});a.attachAfter(sap.ui.core.util.MockServer.HTTPMETHOD.GET,r);a.simulate(s.constants.DEMOKIT_HIERARCHY_METADATA,s.constants.DEMOKIT_DATA_PATH);a.start();m.push(a);return a;function r(q){var t;var u=q.getParameters().oFilteredData;var v=q.getParameters().oXhr.url;var w=v.indexOf("P_Currency")+14;var x=v.indexOf("%27",w);var y=v.slice(w,x);var z=o(JSON.parse(JSON.stringify(h)),"Currency",[y],true);z=o(z,"Country",i(v,"Country"),true);z=o(z,"Customer",i(v,"Customer"),true);t=z;var B=i(v,"Customer_NodeID");if(B.length>0){z=f(z,B);}var C=v.indexOf("Customer_ParentID%20eq")+28;if(C>=28){var D=v.indexOf("%27",C);var E=v.slice(C,D);z=o(z,"Customer_ParentID",[n(E)],false);}if(v.indexOf("Customer_Level%20eq%200")>-1){z=g(z);}j(z,t);p(z);z=d(z);e(z,v);var F=s._parseUrl(v);u.results=s._sortData(s._aggregateData(z),F.parameters.$orderby);}function d(q){var t=[];q.forEach(function(u){if(u.Revenue===undefined||u.Revenue>0){t.push(u);}});return t;}function g(q){var t=[];var u=[];q.forEach(function(v){u.push(v.Customer_NodeID);});q.forEach(function(v){if(u.indexOf(v.Customer_ParentID)===-1){t.push(v);}});return t;}function f(q,t){var u=[];var v=false;var w=[];t.forEach(function(y){w.push(n(y));});q.forEach(function(y){if(w.indexOf(y.Customer_NodeID)>-1){u.push(y);v=true;}});function x(y){if(w.indexOf(y.Customer_ParentID)>-1&&w.indexOf(y.Customer_NodeID)===-1){u.push(y);w.push(y.Customer_NodeID);v=true;}}while(v){v=false;q.forEach(x);}return u;}function e(q,u){u=n(u);var t=u.indexOf("$select");if(t>-1&&q.length>0){var v=u.indexOf("$",t+1);Object.keys(q[0]).forEach(function(w){if(w!=="__metadata"){var x=u.indexOf(w+"&",t);var y=u.indexOf(w+",",t);var z=x===-1?y:x;if(z<0||(v>-1&&z>v)){q.forEach(function(B){delete B[w];});}}});}}function i(u,q){var t=0;var v=[];v[t]=[];var w=u.indexOf(q+"%20eq%20%27")+q.length+11;while(w>=q.length+11){if(y&&y>-1&&y<w){t++;v[t]=[];}var x=u.indexOf("%27",w);v[t].push(u.slice(w,x));var y=u.indexOf("%20and%20",x);w=u.indexOf(q+"%20eq%20%27",x)+q.length+11;}if(t>0){var z=v[0];var B=[];v.forEach(function(C){z.forEach(function(D){if(C.indexOf(D)>=0){B.push(D);}});z=B;});return B;}return v[t];}function j(q,t){q.forEach(function(u){if(u.Revenue===null){u.Revenue=k(u,t);}});}function k(q,t){var u=q.Customer_NodeID;var v=0;t.forEach(function(w){if(w.Customer_ParentID===u){if(w.Revenue===null){v+=k(w,t);}else{v+=w.Revenue;}}});return v;}function n(q){return q.replace(new RegExp("%3a","g"),":").replace(new RegExp("%20","g")," ").replace(new RegExp("%2c","g"),",");}function o(q,t,v,E){if(v.length===0){return q;}var u=[];q.forEach(function(w){if((w[t]===null&&E)||v.indexOf(w[t])>=0){u.push(w);}});return u;}function p(q){q.forEach(function(t){t.__metadata={"id":"/tmp/demokit/hierarchy.xsodata/RevenueHryQueryResults('"+t.GenID+"')","type":"tmp.demokit.demokit.RevenueHryQueryResultsType","uri":"/tmp/demokit/hierarchy.xsodata/RevenueHryQueryResults('"+t.GenID+"')"};});}},_postProcessDemokitData:function(e){var x=e.getParameter("oXhr");var f=e.getParameter("oFilteredData");if(x&&f){var p=s._parseUrl(x.url);var a=p.couldParse&&(p.parameters.$top!==undefined||p.parameters.$skip!==undefined);if(a){var u=jQuery.extend({},p.parameters);delete u.$top;delete u.$skip;var d=s._generateUrlString(p.path,u);var r=jQuery.sap.sjax({url:d,dataType:"json"}).data.d;var $=p.parameters.$skip||0;var g=p.parameters.$top;var h;if(g){h=r.results.slice($,Number($)+Number(g));}else{h=r.results.slice($);}f.results=h;f.__count=r.__count;}else{f.results=s._attachGUIDs(s._sortData(s._aggregateData(f.results||[]),p.parameters.$orderby));f.__count=f.results.length;}}},_aggregateData:function(r){var a=["Revenue","ShippingCosts","Discount","NumberOfOrders"];var d=[];if(r.length>0){var h={};var p=Object.getOwnPropertyNames(r[0]);var e=[];var f=[];p.forEach(function(i){if(i!=="__metadata"){if(a.indexOf(i)>-1){f.push(i);}else{e.push(i);}}});if(f.length>0){r.forEach(function(i){var j="";var n=false;e.forEach(function(k){if(i[k]===null){n=true;}j=j+i[k];});if(n){return;}if(!h[j]){h[j]=jQuery.extend(true,{},i);f.forEach(function(k){h[j][k]=Number(i[k]);});}else{f.forEach(function(k){h[j][k]=Number(h[j][k])+Number(i[k]);});}});d=jQuery.map(h,function(v){return v;});if(d.length>0){return d;}}else if(e.length===1||e.length===2){var g=[];r.forEach(function(i){if(jQuery.inArray(i[e[0]],g)===-1){g.push(i[e[0]]);d.push(i);}});if(d.length>0){return d;}}}return r;},_sortData:function(a,$){var d=s._parseOrderBy($);if(d.length===0){return a;}var e=a.slice().sort(function(r,f){var g=d.filter(function(o){return r[o.attr]!==f[o.attr];})[0];if(!g){return 0;}if(r[g.attr]>f[g.attr]){return g.direction;}return-g.direction;});return e;},_parseOrderBy:function(o){if(typeof o!=="string"||o.trim()===""){return[];}var O=o.split(",").map(function(i){var I=i.trim().split("%20");if(I[1]&&I[1].toLowerCase().trim()==="desc"){return{attr:I[0].trim(),direction:-1};}return{attr:I[0].trim(),direction:1};});return O;},_parseUrl:function(u){if(typeof u!=="string"){return{couldParse:false};}var q=u.split("?");if(q.length<1||q.length>2){return{couldParse:false};}else if(q.length==1){return{couldParse:true,path:q[0],parameters:{}};}var p={};q[1].split("&").map(function(a){var d=a.split("=");var e=d[0];var r=d[1];return{lhs:e,rhs:r};}).forEach(function(a){p[a.lhs]=a.rhs;});return{couldParse:true,path:q[0],parameters:p};},_generateUrlString:function(p,a){var d=Object.keys(a).map(function(k){return k+"="+a[k];}).join("&");return p+"?"+d;},_attachGUIDs:function(r){return r.map(function(d){if(d.__metadata){var g="('"+sap.apf.utils.createPseudoGuid()+"')";var n=jQuery.extend(true,{},d);n.__metadata.uri=d.__metadata.uri.replace("('undefined')",g);n.__metadata.id=d.__metadata.id.replace("('undefined')",g);return n;}return d;});}};s.setupConstants(b);return s;}});
