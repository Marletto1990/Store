/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.apf.ui.representations.utils.chartDataSetHelper");jQuery.sap.require("sap.apf.ui.representations.utils.displayOptionHandler");(function(){"use strict";sap.apf.ui.representations.utils.ChartDataSetHelper=function(f,t){this.oFormatter=f;this.aDataResponseWithDisplayValue=[];this.oDisplayOptionHandler=new sap.apf.ui.representations.utils.DisplayOptionHandler();this.oTimeAxisDateConverter=t;this.oChartDataSet={};};sap.apf.ui.representations.utils.ChartDataSetHelper.getFieldNameForOriginalContentOfProperty=function(p){return"original_"+p;};function _(p,r){var P=p.map(function(s){return s.fieldName;});return P.indexOf(r)===-1?true:false;}function a(f){var p=f.dimensions.concat(f.measures),P;p.forEach(function(o){for(P in o){if((P!=='name')&&(P!=='value')&&(P!=='dataType')&&(P!=='displayValue')&&(P!=='identity')){delete o[P];}}});}function b(c,p,m,d){var D=jQuery.extend(true,[],d);var C,e={};c.oTimeAxisDateConverter.createPropertyInfo(p.dimensions);var P=p.dimensions.concat(p.requiredFilters);P.forEach(function(f,n){var l=p.requiredFilterOptions?p.requiredFilterOptions.labelDisplayOption:undefined;var L=f.labelDisplayOption?f.labelDisplayOption:l;var s=f.fieldName?f.fieldName:f;if(L===undefined||L===sap.apf.core.constants.representationMetadata.labelDisplayOptions.TEXT){return D;}D.forEach(function(g,h){g[s]=(g[s]===null||g[s]===undefined)?g[s]:g[s].toString();if(L===sap.apf.core.constants.representationMetadata.labelDisplayOptions.KEY){C="formatted_"+s;if(!D[h][C]){D[h][C]=c.oFormatter.getFormattedValue(s,D[h][s]);}}if(L===sap.apf.core.constants.representationMetadata.labelDisplayOptions.KEY_AND_TEXT){var i=m.getPropertyMetadata(s).text;C=s+"_"+i;var t={text:D[h][i],key:D[h][s]};D[h][C]=c.oFormatter.getFormattedValueForTextProperty(s,t);}if(c.oTimeAxisDateConverter.bIsConversionToDateRequired(f.fieldName,m)){var o=g[s];var j=sap.apf.ui.representations.utils.ChartDataSetHelper.getFieldNameForOriginalContentOfProperty(s);if(g[j]){e[o]=g[j];}else{var k=sap.apf.utils.convertFiscalYearMonthDayToDateString(o)+"";e[k]=o;g[s]=k;g[j]=o;}}});});c.oTimeAxisDateConverter.setConvertedDateLookUp(e);return D;}sap.apf.ui.representations.utils.ChartDataSetHelper.prototype.constructor=sap.apf.ui.representations.utils.ChartDataSetHelper;sap.apf.ui.representations.utils.ChartDataSetHelper.prototype.createFlattenDataSet=function(p,m,d,A){var s=this;this.aDataResponseWithDisplayValue=b(this,p,m,d);p.dimensions.forEach(function(e,i){e.name=s.oDisplayOptionHandler.getDisplayNameForDimension(e,m,A);e.value='{'+e.fieldName+'}';e.identity=e.fieldName;e.displayValue='{'+s.oDisplayOptionHandler.getColumnNameBasedOnDisplayOption(e.fieldName,e.labelDisplayOption,m)+'}';});p.measures.forEach(function(e){e.name=s.oDisplayOptionHandler.getDisplayNameForMeasure(e,m,d,A);e.value='{'+e.fieldName+'}';e.identity=e.fieldName;});var c={dimensions:p.dimensions,measures:p.measures};var r=p.requiredFilters[0];this.oChartDataSet=jQuery.extend(true,{},c);this.oChartDataSet.context=[];a(this.oChartDataSet);if(r&&_(p.dimensions,r)){this.oChartDataSet.context.push(r);this.oChartDataSet.dimensions.push({name:r,value:"{"+r+"}",identity:r});}this.oChartDataSet.data={path:"/data"};};sap.apf.ui.representations.utils.ChartDataSetHelper.prototype.addUnusedDimensionsToChartContext=function(m,d){if(d.length===0){return;}var u=[];this.oChartDataSet.dimensions.forEach(function(e){var f=e.identity;u.push(f);var t=m.getPropertyMetadata(f).text;if(t){u.push(t);}});this.oChartDataSet.measures.forEach(function(e){u.push(e.identity);});var c=Object.keys(d[0]);c.forEach(function(e){if(u.indexOf(e)>=0||e==="__metadata"){return;}var p=m.getPropertyMetadata(e);if(p&&p["aggregation-role"]==="measure"){return;}this.addPropertyToContext(e,p);}.bind(this));};sap.apf.ui.representations.utils.ChartDataSetHelper.prototype.addPropertyToContext=function(p,c){var d=c&&c.label?c.label:p;this.oChartDataSet.context.push(p);this.oChartDataSet.dimensions.push({name:d,value:"{"+p+"}",identity:p});};sap.apf.ui.representations.utils.ChartDataSetHelper.prototype.getFlattenDataSet=function(){return new sap.viz.ui5.data.FlattenedDataset(this.oChartDataSet);};sap.apf.ui.representations.utils.ChartDataSetHelper.prototype.getModel=function(){var m=new sap.ui.model.json.JSONModel({data:this.aDataResponseWithDisplayValue});return m;};}());
