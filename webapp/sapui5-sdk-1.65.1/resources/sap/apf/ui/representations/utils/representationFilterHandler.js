/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.ui.representations.utils.representationFilterHandler");jQuery.sap.require("sap.apf.ui.representations.utils.displayOptionHandler");jQuery.sap.require("sap.apf.utils.utils");jQuery.sap.require("sap.apf.core.metadataProperty");(function(){'use strict';function _(f){return f.filter(function(i,n,F){return F.indexOf(i)===n;});}function a(r,m,M){var n,s;var R=r.oParameter.requiredFilters[0];if(R){var l=r.oParameter.requiredFilterOptions?r.oParameter.requiredFilterOptions.labelDisplayOption:undefined;var b=r.oDisplayOptionHandler.getColumnNameBasedOnDisplayOption(R,l,m);var p=new sap.apf.core.MetadataProperty(m.getPropertyMetadata(b));r.aFilterValues.forEach(function(f){for(n=0;n<M.length;n++){if(M[n][R]===f){if(M[n]["formatted_"+b]){s=M[n]["formatted_"+b];}else{s=sap.apf.utils.convertToExternalFormat(M[n][b],p);}break;}}r.filterValueLookup[f]=s;});}}sap.apf.ui.representations.utils.RepresentationFilterHandler=function(A,p,t){this.oApi=A;this.aFilterValues=[];this.oParameter=p;this.sRequiredFilter=this.oParameter.requiredFilters[0];this.oDisplayOptionHandler=new sap.apf.ui.representations.utils.DisplayOptionHandler();this.filterValueLookup={};this.oTimeAxisDateConverter=t;};sap.apf.ui.representations.utils.RepresentationFilterHandler.prototype.constructor=sap.apf.ui.representations.utils.RepresentationFilterHandler;sap.apf.ui.representations.utils.RepresentationFilterHandler.prototype.setMetadataAndDataResponse=function(m,d){this.oMetadata=m;this.aDataResponse=d;};sap.apf.ui.representations.utils.RepresentationFilterHandler.prototype.validateFiltersWithDataset=function(){var v=[];var A=this.aDataResponse.map(function(d){return d[this.sRequiredFilter];}.bind(this));v=this.aFilterValues.filter(function(f){return A.indexOf(f)!==-1;});this.aFilterValues=v;};sap.apf.ui.representations.utils.RepresentationFilterHandler.prototype.createFilterFromSelectedValues=function(n){var f=this,i=false,v;var F=this.oApi.createFilter();if(n&&n.length>0){this.aFilterValues=_(n.concat(this.aFilterValues));}var A=F.getTopAnd().addOr('exprssionOr');var E=F.getOperators().EQ;i=f.oTimeAxisDateConverter.bIsConversionToDateRequired(this.oParameter.requiredFilters[0],this.oMetadata);this.aFilterValues.forEach(function(r){if(i){v=f.oTimeAxisDateConverter.getConvertedDateLookUp()[r]||r;}else{v=r;}var o={id:r,name:f.sRequiredFilter,operator:E,value:v};A.addExpression(o);});return F;};sap.apf.ui.representations.utils.RepresentationFilterHandler.prototype.updateFilterFromSelection=function(f){var u=_(f);this.aFilterValues=u.slice(0);};sap.apf.ui.representations.utils.RepresentationFilterHandler.prototype.clearFilters=function(){this.aFilterValues=[];};sap.apf.ui.representations.utils.RepresentationFilterHandler.prototype.getDisplayInfoForFilters=function(m,M){var f=[],r=this;a(r,m,M);r.aFilterValues.forEach(function(b){var F={id:b,text:r.filterValueLookup[b]};f.push(F);});return f;};sap.apf.ui.representations.utils.RepresentationFilterHandler.prototype.getFilterValues=function(){return this.aFilterValues;};sap.apf.ui.representations.utils.RepresentationFilterHandler.prototype.getIfSelectedFilterChanged=function(n){var i=(jQuery(this.aFilterValues).not(n).length===0)&&(jQuery(n).not(this.aFilterValues).length===0);return!i;};}());
