/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.ui.controls.draggableCarousel.DraggableCarousel");(function(u){"use strict";var a,b;(function(){var i=navigator.maxTouchPoints;var c='ontouchstart'in window?true:false;a=c||i;if('onclick'in window){b=true;}})();sap.apf.ui.controls.draggableCarousel.DraggableCarousel=function(o){var c=o||{};this.eleRefs={blocks:[],containerEle:o.containerEle};this._editState=c.editable===u?true:c.editable;this._dragState=this._editState;this._removeState=this._editState;this.styles={containerHeight:c.containerHeight,containerWidth:c.containerWidth,blockHeight:c.blockHeight,blockWidth:c.blockWidth,blockMargin:c.blockMargin,separatorHeight:c.separatorHeight,removeIconHeight:c.removeIconHeight};this.elems={separator:c.separator,removeIcon:c.removeIcon,ariaTextForCarouselBlock:c.ariaTextForCarouselBlock};this.callbacks={onBeforeDrag:c.onBeforeDrag,onAfterDrop:c.onAfterDrop,onAfterRemove:c.onAfterRemove,onAfterSelect:c.onAfterSelect,setAriaTextWhenEnterPressOnBlock:c.setAriaTextWhenEnterPressOnBlock,setAriaTextwhenDeleteKeyPressOnBlock:c.setAriaTextwhenDeleteKeyPressOnBlock,setAriaTextWhenFocusOnBlock:c.setAriaTextWhenFocusOnBlock};this.eleRefs.containerEle=this._drawSkeleton();this._initDimensions();this._isMouseDown=false;};sap.apf.ui.controls.draggableCarousel.DraggableCarousel.prototype={_initDimensions:function(){var m=this.styles.blockMargin;this._blockMargin=parseInt(m.replace("px"),10);var B=this.styles.blockHeight;this._blockHeight=parseInt(B.replace("px"),10);this._blockTotalHeight=this._blockHeight+(2*this._blockMargin);this._separatorHeight=0;if(this.elems.separator!==u){var s=this.styles.separatorHeight;this._separatorHeight=parseInt(s.replace("px"),10);}this._mFactor=this._blockTotalHeight+this._separatorHeight;},_drawSkeleton:function(){var c;if(this.eleRefs.containerEle===u){c=document.createElement('div');}else{c=this.eleRefs.containerEle;}c.style.cssText+=this._getContainerStyles();c.classList.add('DnD-container');var s=this;var t=function(e){s._onMouseUp(e,s);};if(a){document.addEventListener("touchend",t);}if(b){document.addEventListener("mouseup",t);}return c;},_getBlockWrapper:function(c){var d=c.blockElement;var f=this.eleRefs.blocks;var g=c.dragState===u?true:c.dragState;var h=c.dropState===u?true:c.dropState;var r=c.removable===u?true:c.removable;var j=document.createElement('div');j.style.cssText+=this._getBlockStyles();j.setAttribute('class','DnD-block');j.setAttribute('drag-state',g);j.setAttribute('drop-state',h);if(r){var k=this._getRemoveIconEle();j.appendChild(k);}var s=this;var t=function(e){s._onMouseDown(e,s,this);};if(a){j.addEventListener("touchstart",t);}if(b){j.addEventListener("mousedown",t);}var l=function(e){window.clearTimeout(s._TIMEOUTID);};if(a){j.addEventListener("touchmove",l);}if(b){j.addEventListener("mousemove",l);}this._keypress(j,13,function(i,e){var m=f.indexOf(i);s.callbacks.onAfterSelect.apply(i,[m]);jQuery('.DnD-block').parent().find("[tabindex='0'][drag-state='true']").attr('aria-labelledby',s.elems.ariaTextForCarouselBlock);sap.ui.getCore().byId(s.elems.ariaTextForCarouselBlock).setText(s.callbacks.setAriaTextWhenEnterPressOnBlock.apply(i,[jQuery('.activeStepTitle').text()]));});this._keypress(j,32,function(i,e){var m=f.indexOf(i);s.callbacks.onAfterSelect.apply(i,[m]);});this._keypress(j,36,function(i,e){jQuery(f).removeAttr("tabindex");jQuery(f).attr("tabindex",-1);jQuery(f[0]).attr("tabindex",0);jQuery(f[0]).focus();});this._keypress(j,35,function(i,e){jQuery(f).removeAttr("tabindex");jQuery(f).attr("tabindex",-1);jQuery(f[f.length-1]).attr("tabindex",0);jQuery(f[f.length-1]).focus();});if(r===true){this._keypress(j,46,function(m,e){var n=f.indexOf(m),i;s.removeBlock(n,s.callbacks.onAfterRemove);s._grouping(f);jQuery('.DnD-block').parent().find("[tabindex='0'][drag-state='true']").attr('aria-labelledby',s.elems.ariaTextForCarouselBlock);sap.ui.getCore().byId(s.elems.ariaTextForCarouselBlock).setText(s.callbacks.setAriaTextwhenDeleteKeyPressOnBlock.apply(m,[jQuery('.activeStepTitle').text()]));for(i=0;i<jQuery('.DnD-block').parent().find("[drag-state='true']").length;i++){if(jQuery('.DnD-block').parent().find("[drag-state='true']")[i].getElementsByClassName('activeStepTitle')[0]!==undefined){var A=jQuery('.DnD-block').parent().find("[drag-state='true']")[i];setTimeout(function(){A.focus();},10);}}});}j.appendChild(d);return j;},_getSeparatorEle:function(){var s=document.createElement('div');s.style.cssText+=this._getSeparatorStyles();s.setAttribute('class','DnD-separator');s.innerHTML=this.elems.separator.outerHTML;return s;},_getRemoveIconEle:function(){var r=this.elems.removeIcon;var c=document.createElement('div');c.style.cssText+=this._getRemoveIconStyles();c.setAttribute('class','DnD-removeIconWrapper');c.innerHTML=r.outerHTML;var s=this;var t=function(e){s._onRemoveBlock(e,s,this);};if(a){c.addEventListener("touchstart",t);}if(b){c.addEventListener("mousedown",t);}return c;},addBlock:function(c){if(c instanceof Array){var i;for(i=0;i<c.length;i++){this.addBlock(c[i]);}return;}var d=this._getBlockWrapper(c);var e=this.eleRefs.blocks.length;var f=this.eleRefs.blocks;var y=e*this._mFactor;d.style.cssText=d.style.cssText+this._getTransformCss(y);this.eleRefs.blocks.push(d);var g=this.eleRefs.containerEle;g.appendChild(d);this._setHorizontalBlockMargin();if(this.elems.separator!==u){var s=this._getSeparatorEle();var h=y+this._blockHeight+2*this._blockMargin;s.style.cssText=s.style.cssText+this._getTransformCss(h);g.appendChild(s);}this._grouping(f);},swapBlocks:function(f,t){var c=this.eleRefs.blocks[f];var d=this.eleRefs.blocks[t];if((c.getAttribute('drag-state')!=="true"&&c.getAttribute('drop-state')!=="true")||(d.getAttribute('drag-state')!=="true"&&d.getAttribute('drop-state')!=="true")){return false;}var e=f*this._mFactor;var g=t*this._mFactor;var h=g;var i=h+this._blockHeight+(2*this._blockMargin);var j=document.getElementsByClassName('scrollContainerEle')[0]?document.getElementsByClassName('scrollContainerEle')[0]:this.eleRefs.containerEle;var s=j.scrollTop;if((f>t)&&h<j.scrollTop){s=h;}if((f<t)&&i-j.offsetHeight>j.scrollTop){s=i-j.offsetHeight;}var p;var k=40;var l=window.setInterval(function(){j.scrollTop+=(s-j.scrollTop)/k;if(j.scrollTop===p){window.clearInterval(l);}p=j.scrollTop;},1000/60);this._setTransformYValue(c,g);this._setTransformYValue(d,e);this._swapArray(this.eleRefs.blocks,f,t);return true;},insertBlock:function(c,d){var s=this,i;var f=this.eleRefs.blocks;f.push({});for(i=f.length-1;i>d;i--){f[i]=f[i-1];var g=i*this._mFactor;this._setTransformYValue(f[i],g);}var h=this._getBlockWrapper(c);f[i]=h;var y=d*this._mFactor;h.style.cssText=h.style.cssText+this._getTransformCss(y);var j=this.eleRefs.containerEle;j.appendChild(h);jQuery('.DnD-block').parent().find("[tabindex='0'][drag-state='true']").attr('aria-labelledby',s.elems.ariaTextForCarouselBlock);for(i=0;i<jQuery('.DnD-block').parent().find("[drag-state='true']").length;i++){jQuery('.DnD-block').parent().find("[drag-state='true']")[i].onkeydown=function(e){if(e.which==13){setTimeout(function(){jQuery('.DnD-block').parent().find("[tabindex='0'][drag-state='true']").focus();},10);}};}this._setHorizontalBlockMargin();if(this.elems.separator!==u){var k=this._getSeparatorEle();var l=y+this._blockHeight+2*this._blockMargin;k.style.cssText=k.style.cssText+this._getTransformCss(l);j.appendChild(k);}this._grouping(f);},removeBlock:function(c,d){var e=this.eleRefs.blocks;var f=this.eleRefs.containerEle;var i;var r=e[c];f.removeChild(r);for(i=c;i<e.length-1;i++){e[i]=e[i+1];var y=i*this._mFactor;this._setTransformYValue(e[i],y);}e.pop();if(this.elems.separator!==u){var s=f.querySelectorAll('.DnD-separator');var l=s[s.length-1];f.removeChild(l);}d.apply(f,[c]);this._grouping(e);},placeAt:function(i){var e=document.getElementById(i);e.appendChild(this.eleRefs.containerEle);this._setHorizontalBlockMargin();},getEditable:function(){return this._editState;},setEditable:function(e){this._editState=e;this._setDragState(e);this._setRemoveState(e);},_setDragState:function(d){this._dragState=d;},_setRemoveState:function(r){this._removeState=r;var c=this.eleRefs.containerEle.querySelectorAll('.DnD-removeIconWrapper');var d;if(r){d="display : block";}else{d="display : none";}var i;for(i=0;i<c.length;i++){c[i].style.cssText+=d;}},_getContainerStyles:function(){var s=["height : ",this.styles.containerHeight,";width : ",this.styles.containerWidth,"; position : relative"].join("");return s;},_getBlockStyles:function(){if(this.styles.horizontalBlockMargin===u){var c=this.eleRefs.containerEle.clientWidth;var d=this.eleRefs.blocks[0]===u?0:this.eleRefs.blocks[0].clientWidth;this.styles.horizontalBlockMargin=((c-d)/2)+"px";}var s=["height : ",this.styles.blockHeight,";width : ",this.styles.blockWidth,";margin : ",this.styles.blockMargin," ",this.styles.horizontalBlockMargin,";position : absolute"].join("");return s;},_getSeparatorStyles:function(){var s=["height : ",this.styles.separatorHeight,";width : 100%",";position : absolute"].join("");return s;},_getRemoveIconStyles:function(){var s=["height : ",this.styles.removeIconHeight,";width : ",this.styles.removeIconHeight,";float : right",";margin : -10px -13px -10px 0",";z-index : 2",";position : relative",";cursor : pointer"].join("");if(this._removeState){s+=";display : block";}else{s+=";display : none";}return s;},_getTransformCss:function(y){var Y=y+"px";var t=["transform","-webkit-transform","-moz-transform","-ms-transform","-o-transform"];var c="";var i;for(i=0;i<t.length;i++){c+=t[i]+": translate3d(0px,"+Y+", 0px); ";}return c;},_setTransformYValue:function(e,y){var v=[{"WebkitTransform":"-webkit-transform"},{"MozTransform":"-moz-transform"},{"MsTransform":"-ms-transform"},{"OTransform":"-o-transform"}];var t="transform";var i;for(i=0;i<v.length;i++){if(e.style.hasOwnProperty(Object.keys(v[i])[0])){t=v[i][Object.keys(v[i])[0]];}}var Y=y+'px';e.style.cssText=e.style.cssText+" "+t+": translate3d(0px,"+Y+", 0px);";},_setHorizontalBlockMargin:function(){var c=this.eleRefs.blocks;var d=this.eleRefs.containerEle;var e=c[0]===u?0:jQuery(c[0]).width();var f=jQuery(d).width();this.styles.horizontalBlockMargin=((f-e)/2)+"px";var m=this.styles.horizontalBlockMargin;[].forEach.call(c,function(g){g.style.cssText+="margin-right : "+m+";margin-left : "+m;});},_onMouseDown:function(e,c,d){c._isMouseDown=true;c._TIMEOUTID=window.setTimeout(function(){if(c._isMouseDown){c._onDragStart(e,c,d);}},500);},_onMouseUp:function(e,c){c._isMouseDown=false;if(c._dragEle!==u&&c._dragEle.ele!==u){c._onDrop(e,c);}},_onDragStart:function(e,c,d){if(!c._dragState||d.getAttribute('drag-state')!=='true'){return;}c._dragIndex=c.eleRefs.blocks.indexOf(d);var y=c._dragIndex*c._mFactor;var f=document.getElementsByClassName('scrollContainerEle')[0]?document.getElementsByClassName('scrollContainerEle')[0]:c.eleRefs.containerEle;c._containerEleOffsetHeight=f.offsetHeight;c._containerEleScrollHeight=f.scrollHeight;c._blockEleOffsetHeight=d.offsetHeight;c._containerEleScrollTop=f.scrollTop;var g=y+c._blockMargin;var h=g+c._blockHeight;if(g<c._containerEleScrollTop){f.scrollTop=g;c._containerEleScrollTop=Math.max(0,g);}if(h-c._containerEleOffsetHeight>f.scrollTop){f.scrollTop=h-c._containerEleOffsetHeight;c._containerEleScrollTop=Math.min(c._containerEleScrollHeight-c._containerEleOffsetHeight,h-c._containerEleOffsetHeight);}c._diffTop=e.pageY-y+c._containerEleScrollTop;c._dragEle={ele:d,pos:{y:y}};c.callbacks.onBeforeDrag.apply(d,[c._dragIndex]);c._dragEle.ele.className=c._dragEle.ele.className+" "+"DnD-drag";var t=function(e){if(c._dragEle.ele!==u){e.preventDefault();c._onDrag(e,c);e.stopPropagation();}};if(a){document.addEventListener("touchmove",t);}if(b){document.addEventListener("mousemove",t);}},_onDrag:function(e,c){var d=document.getElementsByClassName('scrollContainerEle')[0]?document.getElementsByClassName('scrollContainerEle')[0]:c.eleRefs.containerEle;var y=e.pageY-c._diffTop+c._containerEleScrollTop;var f=y+c._blockMargin;var g=f+c._blockHeight;var h=((e.pageY-c._diffTop)>c._prevPageY);var j=((e.pageY-c._diffTop)<c._prevPageY);c._prevPageY=(e.pageY-c._diffTop);if(j&&(f<c._containerEleScrollTop)){d.scrollTop=f;c._containerEleScrollTop=Math.max(0,f);y=e.pageY-c._diffTop+c._containerEleScrollTop;}if(h&&((g-c._containerEleOffsetHeight)>c._containerEleScrollTop)){d.scrollTop=g-c._containerEleOffsetHeight;c._containerEleScrollTop=Math.min(c._containerEleScrollHeight-c._containerEleOffsetHeight,g-c._containerEleOffsetHeight);y=e.pageY-c._diffTop+c._containerEleScrollTop;}c._setTransformYValue(c._dragEle.ele,y);var k=y;var l=y+c._blockEleOffsetHeight;var m=c._dragEle.pos.y-(c._mFactor-(c._blockHeight/2));var n=(c._dragEle.pos.y+c._blockEleOffsetHeight)+(c._mFactor-(c._blockHeight/2));var o=c._dragEle.pos.y;var p=o/(c._mFactor);var q=c.eleRefs.blocks;var r=-1,s=q.length;var i,t;for(i=p-1;i>=0;i--){t=q[i];if(t.getAttribute('drop-state')==='true'){r=i;break;}}for(i=p+1;i<q.length;i++){t=q[i];if(t.getAttribute('drop-state')==='true'){s=i;break;}}m=c._dragEle.pos.y-((p-r)*c._mFactor-(c._blockHeight/2));n=(c._dragEle.pos.y+c._blockEleOffsetHeight)+((s-p)*c._mFactor-(c._blockHeight/2));var v;var S=false;if(k<m){S=true;v=r;}else if(l>n){S=true;v=s;}if(S&&(v>=0)&&(v<=q.length-1)){c._dragEle.pos.y=v*(c._mFactor);var w=q[v];if(w!==u){c._setTransformYValue(w,o);c._swapArray(q,p,v);}}},_onDrop:function(e,c){c._dragEle.ele.className=c._dragEle.ele.className.replace(" DnD-drag","");var d=c.eleRefs.containerEle.querySelectorAll('.DnD-drag');var i;for(i=0;i<d.length;i++){d[i].className=d[i].className.replace(" DnD-drag","");}var f=c._dragEle.pos.y;c._dropIndex=f/(c._mFactor);c._setTransformYValue(c._dragEle.ele,f);c.callbacks.onAfterDrop.apply(c._dragEle.ele,[c._dragIndex,c._dropIndex]);c._dragEle={};},_onRemoveBlock:function(e,c,r){e.stopPropagation();window.setTimeout(function(){var d=r.parentElement;var f=c.eleRefs.blocks.indexOf(d);c.removeBlock(f,c.callbacks.onAfterRemove);},100);},_swapArray:function(c,f,t){var d=c[f];c[f]=c[t];c[t]=d;return c;},_grouping:function(c){var s=this;var d=c;var f=(c.length>2)?c.length-2:0;jQuery(d).removeAttr("tabindex");jQuery(d).attr("tabindex",-1);jQuery(d[f]).attr("tabindex",0);this._keypress(d,38,function(g,e){var i=d.indexOf(g);if(i===0){return;}if(jQuery('.stepTitle')[i-1]){sap.ui.getCore().byId(s.elems.ariaTextForCarouselBlock).setText(s.callbacks.setAriaTextWhenFocusOnBlock.apply(g,[jQuery('.stepTitle')[i-1].textContent]));}jQuery(d).removeAttr("tabindex");jQuery(d).attr("tabindex",-1);jQuery(d[i-1]).attr("tabindex",0);jQuery(d[i-1]).focus();});this._keypress(d,40,function(g,e){var i=d.indexOf(g);if(i===d.length-1){return;}if(jQuery('.stepTitle')[i+1]){sap.ui.getCore().byId(s.elems.ariaTextForCarouselBlock).setText(s.callbacks.setAriaTextWhenFocusOnBlock.apply(g,[jQuery('.stepTitle')[i+1].textContent]));}jQuery(d).removeAttr("tabindex");jQuery(d).attr("tabindex",-1);jQuery(d[i+1]).attr("tabindex",0);jQuery(d[i+1]).focus();});},_keypress:function(c,k,d){jQuery(c).keydown(function(e){var f=e.keyCode||e.which;if(f===k){d(this,e);return false;}});}};}(undefined));
