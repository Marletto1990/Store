/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2015 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/utils/filter","sap/apf/core/utils/filterTerm","sap/apf/core/constants"],function(F,a,c){var E=function(b){'use strict';var d=jQuery.Deferred();var s=b.instances.startParameter.getEvaluationId();var x=b.instances.startParameter.getXappStateId();var m=b.instances.messageHandler;var e=this;var f=b.functions.ajax;this.getCombinedContext=function(){if(x){r();}else if(s){g();}else{d.resolve(new F(m));}return d.promise();function n(h){if(h.levelOperator===c.BooleFilterOperators.OR){return new F(m,h);}return h;}function r(){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(b.instances.component,x).done(function(h){var i=h.getData();if(i&&i.sapApfCumulativeFilter){d.resolve(n(F.transformUI5FilterToInternal(m,i.sapApfCumulativeFilter)));}else if(i&&i.selectionVariant){d.resolve(n(e.convertSelectionVariantToFilter(i.selectionVariant)));}else{d.resolve(new F(m));}}).fail(function(){var h=m.createMessageObject({code:5045,aParameters:[x]});m.putMessage(h);});}function g(){b.functions.getConfigurationProperties().done(function(h){var i=h&&h.smartBusiness&&h.smartBusiness.runtime;if(i&&i.service){var j=i.service+"/EVALUATIONS('"+s+"')/FILTERS?$format=json";f({url:j,success:function(l){var p;var o;var q=new F(m);var t=[];var u={};l.d.results.forEach(v);for(p in u){if(u.hasOwnProperty(p)){o=new F(m);u[p].forEach(w);t.push(o);}}t.forEach(y);d.resolve(n(q));function v(z){if(!u[z.NAME]){u[z.NAME]=[];}u[z.NAME].push(new F(m,z.NAME,z.OPERATOR,z.VALUE_1,z.VALUE_2));}function w(z){o.addOr(z);}function y(z){q.addAnd(z);}},error:function(l,t,o,p){var k=m.createMessageObject({code:5043,aParameters:[s,t]});if(p){k.setPrevious(p);}m.putMessage(k);}});}else{var k=m.createMessageObject({code:5044,aParameters:[s]});m.putMessage(k);}});}};this.convertParameterObject=function(p){var g;if(!p.PropertyName||p.PropertyValue===undefined||p.PropertyValue===null){if(!p.PropertyName){g=m.createMessageObject({code:5046,aParameters:[x]});}else{g=m.createMessageObject({code:5047,aParameters:[x,p.PropertyName]});}m.putMessage(g);}return new a(m,p.PropertyName,c.FilterOperators.EQ,p.PropertyValue);};this.convertSelectOption=function(g){var e=this;var h=null;var i;var j;if(!g.PropertyName||!g.Ranges||!(jQuery.isArray(g.Ranges))){if(!g.PropertyName){j=m.createMessageObject({code:5048,aParameters:[x]});}else{j=m.createMessageObject({code:5049,aParameters:[x,g.PropertyName]});}m.putMessage(j);}h=new F(m);for(i=0;i<g.Ranges.length;i++){var k=e.convertRange(g.Ranges[i],g.PropertyName);h.addOr(k);}return h;};this.convertRange=function(r,p){var g,l,o,h;if(r.Sign!='I'){g=m.createMessageObject({code:5050,aParameters:[x,p]});m.putMessage(g);}if(r.Option==='BT'&&(r.High===undefined||r.High===null)){g=m.createMessageObject({code:5051,aParameters:[x,p]});m.putMessage(g);}if(r.Option==='CP'){h=r.Low.split("\*");if(h.length>3||(h.length===3&&(h[0].length!==0||h[2].length!==0))||h.length===1){g=m.createMessageObject({code:5069,aParameters:[x,p]});m.putMessage(g);}if(r.Low.indexOf("*")===0&&r.Low.lastIndexOf("*")===r.Low.length-1){l=r.Low.substr(1,r.Low.lastIndexOf("*")-1);o='Contains';}else if(r.Low.indexOf("*")===0){l=r.Low.substr(1,r.Low.length-1);o='EndsWith';}else if(r.Low.lastIndexOf("*")===r.Low.length-1){l=r.Low.substring(0,r.Low.indexOf("*"));o='StartsWith';}return new a(m,p,o,l,r.High);}return new a(m,p,r.Option,r.Low,r.High);};this.convertSelectionVariantToFilter=function(g){var e=this;var h=new F(m);var i;if(!g){return h;}if(g.Parameters&&!(jQuery.isArray(g.Parameters))){return h;}if(g.SelectOptions&&!(jQuery.isArray(g.SelectOptions))){return h;}if(g.Parameters){for(i=0;i<g.Parameters.length;i++){var j=e.convertParameterObject(g.Parameters[i]);h.addAnd(j);}}if(g.SelectOptions){for(i=0;i<g.SelectOptions.length;i++){var k=e.convertSelectOption(g.SelectOptions[i]);h.addAnd(k);}}return h;};};sap.apf.utils.ExternalContext=E;return E;},true);
