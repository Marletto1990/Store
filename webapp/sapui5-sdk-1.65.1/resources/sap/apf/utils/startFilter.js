/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/utils/filter"],function(F){'use strict';var S=function(a,c,b){var d;var e;var r=new F(a.instances.messageHandler);var f;var g;var h=0;var j=0;var k=jQuery.extend(true,[],b);var p;if(c.preselectionDefaults&&c.preselectionDefaults.length>0){p=jQuery.extend(true,[],c.preselectionDefaults);}else if(jQuery.isFunction(c.preselectionFunction)){p=jQuery.extend(true,[],c.preselectionFunction());}var v=false;if(c.valueHelpRequest||(jQuery.isArray(c.valueList)&&c.valueList.length>0)){v=true;}var l=false;var m={};var n={};var o;u=u.bind(this);A=A.bind(this);B=B.bind(this);x=x.bind(this);w=w.bind(this);t=t.bind(this);this.hasValueHelpRequest=function(){return!!c.valueHelpRequest;};this.setContext=function(i){if(c.notConfigured===true){b=i;}else{a.instances.messageHandler.putMessage(a.instances.messageHandler.createMessageObject({code:'5100',aParameters:['Context of configured Startfilter cannot be changed']}));}};this.getPropertyName=function(){return c.property;};this.getLabel=function(){return c.label;};this.getAliasNameIfExistsElsePropertyName=function(){return c.alias||c.property;};this.isMultiSelection=function(){if(c.multiSelection==='true'||c.multiSelection===true){return true;}return false;};this.isVisible=function(){if(b&&b.type==='internalFilter'&&!c.filterResolutionRequest){return false;}return!c.invisible;};this.setRestriction=function(i){r=i.copy();if(!g){g=jQuery.Deferred();}s(++j);};this.setSelectedValues=function(i,C){if(!g){g=jQuery.Deferred();}if(!d){d=jQuery.Deferred();if(!C){w().done(function(D){if(d){d.resolve(D);}});}else{d.resolve(i);}}if(i.type==='internalFilter'){e=i;}else{e=jQuery.extend(true,[],i);}if(!C){s(++j);}};this.getSelectedValues=function(){var i;if(!g){g=jQuery.Deferred();i=g;s(++j);}else if(g.state()==='pending'){i=g;if(d){d.done(function(){s(++j);});}else{s(++j);}}return i.promise();};this.getValues=function(){var i;if(!f||f.state()!=='pending'){f=jQuery.Deferred();}i=f;q(++h);return i.promise();};this.getMetadata=function(){if(c.metadataProperty){return jQuery.Deferred().resolve(c.metadataProperty);}return jQuery.Deferred().resolve({});};this.serialize=function(i,C){var D=jQuery.Deferred();var E={propertyName:this.getPropertyName()};w().done(function(G){if(G&&G.type==='internalFilter'){G=G.mapToSapUI5FilterExpression();}E.selectedValues=G;if(d){d.done(function(G){if(i===true){E.initiallySelectedValues=G;}if(C!==true){d=null;}D.resolve(E);});}else{D.resolve(E);}});return D;};this.deserialize=function(i){if(i.selectedValues&&(i.selectedValues.aFilters||i.selectedValues.sPath)){i.selectedValues=F.transformUI5FilterToInternal(a.instances.messageHandler,i.selectedValues);}e=null;if(i.initiallySelectedValues){d=jQuery.Deferred().resolve(i.initiallySelectedValues);}else{d=null;}if(jQuery.isArray(i.selectedValues)){k=jQuery.extend(true,[],i.selectedValues);b=jQuery.extend(true,[],i.selectedValues);}else{k=i.selectedValues;b=i.selectedValues;}l=false;};this.reset=function(){if(d){d.done(function(i){e=i;});}};function q(i){t(i,h).done(function(C){if(i===h){f.resolve(C);}});}function s(i){w(i).done(function(C){if(i===j){var D=g;g=jQuery.Deferred();D.resolve(C,g.promise());}});}function t(C,D){var E=jQuery.Deferred();var G=[];H=H.bind(this);if(v&&jQuery.isArray(b)){y(C,D).then(function(i){var G=i.data;var o=u(k,G);E.resolve(o);});}else if(b&&b.type==='internalFilter'&&v&&c.filterResolutionRequest){jQuery.when(y(C,D),x(C,D)).then(function(i,I){var G=i.data;H(I.data,G);E.resolve(G);});}else if(v&&((c.preselectionDefaults&&c.preselectionDefaults.length>0)||jQuery.isFunction(c.preselectionFunction))){y(C,D).then(function(i){var G=i.data;o=u(p,G);E.resolve(o);});}else if(v){y(C,D).then(function(i){E.resolve(i.data);});}else if(b&&b.type==='internalFilter'&&c.filterResolutionRequest){x(C,D).then(function(i){E.resolve(i.data);});}else if(jQuery.isArray(b)&&c.filterResolutionRequest&&!v){x(C,D).then(function(i){E.resolve(i.data);});}else if(jQuery.isArray(b)){G=u(k,G);E.resolve(G);}else if(((c.preselectionDefaults&&c.preselectionDefaults.length>0)||jQuery.isFunction(c.preselectionFunction))&&!v&&!c.filterResolutionRequest&&!b){if(this.isMultiSelection()){o=u(p,G);}else if(p.length>0){o=u([p[0]],G);}E.resolve(o);}else if(((c.preselectionDefaults&&c.preselectionDefaults.length>0)||jQuery.isFunction(c.preselectionFunction))&&c.filterResolutionRequest&&!b){if(this.isMultiSelection()){o=u(p,G);}else if(p.length>0){o=u([p[0]],G);}E.resolve(o);}else if(b&&b.type==='internalFilter'||!b){E.resolve(null);}return E.promise();function H(I,J){var K=B(J);for(var i=I.length-1;i>=0;i--){if(!K[I[i][this.getAliasNameIfExistsElsePropertyName()]]){J.unshift(I[i]);}}}}function u(C,D){var E=jQuery.extend(true,[],D);var G=B(D);var H;for(var i=C.length-1;i>=0;i--){if(!G[C[i]]){H={};H[this.getAliasNameIfExistsElsePropertyName()]=C[i];E.unshift(H);}else if(!l){C.splice(i,1);}}l=true;return E;}function w(i){var C=jQuery.Deferred();var D;var E;var G;var H=this;if(e){if(!c.invisible){J(jQuery.extend(true,[],e),i);}else{D=e;I();}}else if(jQuery.isFunction(c.preselectionFunction)&&!v){D=c.preselectionFunction();I();}else if(b&&b.type==='internalFilter'&&!c.filterResolutionRequest){C.resolve(b);}else if(c.preselectionDefaults===null&&!b){C.resolve([]);}else if(c.filterResolutionRequest&&!b&&!v&&!(c.preselectionDefaults&&c.preselectionDefaults.length>0)){C.resolve(null);}else if(b&&b.type==='internalFilter'&&c.filterResolutionRequest){x(i,j).then(function(K){var L=A(K);J(jQuery.extend(true,[],L),i);});}else if(v&&!jQuery.isArray(b)&&!(c.preselectionDefaults&&c.preselectionDefaults.length>0)&&!c.preselectionFunction){y(i,j).then(function(K){var L=A(K);if(this.isMultiSelection()){D=L;}else{D=[L[0]];}I();}.bind(this));}else if(v&&!jQuery.isArray(b)&&((c.preselectionDefaults&&c.preselectionDefaults.length>0)||c.preselectionFunction)){if(jQuery.isFunction(c.preselectionFunction)){E=c.preselectionFunction();}else{E=c.preselectionDefaults;}J(jQuery.extend(true,[],E),i);}else if(jQuery.isArray(b)){J(b,i);}else if(c.preselectionDefaults&&c.preselectionDefaults.length>0){D=c.preselectionDefaults;J(D,i);}else{C.resolve(null);}return C.promise();function I(){if(D&&D.type==='internalFilter'){C.resolve(D);}else{C.resolve(jQuery.extend(true,[],D));}}function J(K,i){t(i,j).done(function(L){if(L!==null){D=[];G=B(L);K.forEach(function(M){if(G[M]){D.push(M);}});if(K.length!==0&&D.length===0&&c.preselectionDefaults!==null){D=A({data:L});}if(!H.isMultiSelection()){D=[D[0]];}if(e!==null){e=D;}}else{D=null;}I();});}}function x(i,C){var D;var E=jQuery.Deferred();if(i&&i!==C){return E.promise();}var G;if(jQuery.isArray(b)){G=new F(a.instances.messageHandler);b.forEach(function(I){G.addOr(this.getAliasNameIfExistsElsePropertyName(),'eq',I);}.bind(this));}else if(b instanceof F){G=b;}else{G=new F(a.instances.messageHandler);}if(!r.isEmpty()){D=new F(a.instances.messageHandler);D.addAnd(r).addAnd(G);}else{D=G;}if(m.lastMergedFilter&&m.lastMergedFilter.isEqual(D)){m.lastFilterResolutionPromise.done(function(I){E.resolve(I);});}else{m.lastMergedFilter=D.copy();m.lastFilterResolutionPromise=E;a.functions.createRequest(c.filterResolutionRequest).sendGetInBatch(D,H,undefined);}return E.promise();function H(I){E.resolve(I);}}function y(i,C){var D;if(c.valueHelpRequest){return z(i,C);}else if(c.valueList){D={data:u(c.valueList,[])};return jQuery.Deferred().resolve(D);}}function z(i,C){var D=jQuery.Deferred();if(i&&C!==i){return D.promise();}if(n.lastRestriction&&n.lastRestriction.isEqual(r)){n.lastValueHelpPromise.done(function(G){D.resolve(G);});}else{n.lastRestriction=r.copy();n.lastValueHelpPromise=D;a.functions.createRequest(c.valueHelpRequest).sendGetInBatch(r,E,undefined);}return D.promise();function E(G){D.resolve(G);}}function A(i){var C=[];i.data.forEach(function(D){C.push(D[this.getAliasNameIfExistsElsePropertyName()]);}.bind(this));return C;}function B(i){var C={};i.forEach(function(D){var E=D[this.getAliasNameIfExistsElsePropertyName()];C[E]=true;}.bind(this));return C;}};sap.apf.utils.StartFilter=S;return S;},true);
