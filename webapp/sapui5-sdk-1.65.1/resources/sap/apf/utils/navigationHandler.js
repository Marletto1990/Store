/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/utils/filterSimplify","sap/apf/utils/utils","sap/apf/utils/executeFilterMapping","sap/ui/core/routing/HashChanger"],function(f,u,e,H){'use strict';var N=function(I){var c;var a;var l;var m=I.instances.messageHandler;var n=this;var F=I.constructors&&I.constructors.FilterReduction||f.FilterReduction;var b;var d=false;this.getNavigationTargets=function(){var i,q;var r=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(!r){if(!d){q=m.createMessageObject({code:5074});m.putMessage(q);d=true;}a={global:[],stepSpecific:[]};return u.createPromise(a);}i=jQuery.Deferred();I.functions.getCumulativeFilterUpToActiveStep().done(function(C){if(a&&C.isEqual(l)){i.resolve(k(a));return i.promise();}l=C;if(!c){g();}a=jQuery.extend(true,[],c);a.forEach(function(t){t.text="";});s(C).done(function(t){a=t;i.resolve(k(a));});});return i.promise();function s(t){var i=jQuery.Deferred();var v=[];var D=[];var w;a.forEach(function(x){var y;if(x.useDynamicParameters){w=w||o(t);x.parameters=p(x.parameters,w);}y=jQuery.Deferred();D.push(y);r.getLinks({semanticObject:x.semanticObject,action:x.action,params:j(x.parameters),ignoreFormFactor:false,ui5Component:I.instances.component}).then(function(z){z.forEach(function(A){var B=A.intent.split("-");var C=B[1].split("?");C=C[0].split("~");if(A.text!==""&&C[0]===x.action){x.text=A.text;v.push(x);}});y.resolve();},function(){y.resolve();});});jQuery.when.apply(jQuery,D).done(function(){i.resolve(v);});return i.promise();}};this.navigateToApp=function(i){if(!c){g();}var q=h(i);if(!q){return;}var r=H&&H.getInstance();I.functions.getCumulativeFilterUpToActiveStep().done(function(C){if(I.functions.isFilterReductionActive&&I.functions.isFilterReductionActive()){b=b||new F();var s=b.reduceFilter(m,C);if(s===null){m.putMessage(m.createMessageObject({code:5235}));}else{C=s;}}if(!q.filterMapping||!q.filterMapping.requestForMappedFilter){t(null,null);}else{var M=I.functions.createRequest(q.filterMapping.requestForMappedFilter);e(C,M,q.filterMapping.target,t,m);}function t(v,w){var x;if(w){return;}if(v){C=C.addAnd(v);}var y=sap.ushell&&sap.ushell.Container&&sap.ushell.Container.getService("CrossApplicationNavigation");if(y){I.instances.serializationMediator.serialize(true).done(function(z){n.generateSelectionVariant(C).done(function(A){var B;var D={};if(q.useDynamicParameters){B=o(C);}D.sapApfState=z;D.sapApfCumulativeFilter=C.mapToSapUI5FilterExpression();D.selectionVariant=A;x=y.createEmptyAppState(I.instances.component);x.setData(D);x.save();if(r){r.replaceHash("sap-iapp-state="+x.getKey());}var E=q.parameters;if(q.useDynamicParameters){E=p(E,B);}y.toExternal({target:{semanticObject:q.semanticObject,action:q.action},appStateKey:x.getKey(),params:j(E)},I.instances.component);});});}}});};this.checkMode=function(){var i=jQuery.Deferred();var q=H&&H.getInstance&&H.getInstance();var r=/(?:sap-iapp-state=)([^&=]+)/;var s,t,v,w;if(q){v=r.exec(q.getHash());if(v){s=v[1];}}t=I.functions.getXappStateId();if(s){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,s).done(function(x){w=x.getData();if(w.sapApfState){I.instances.serializationMediator.deserialize(w.sapApfState).done(function(){i.resolve({navigationMode:"backward"});});}});}else if(t){sap.ushell.Container.getService("CrossApplicationNavigation").getAppState(I.instances.component,t).done(function(x){w=x.getData();if(w&&w.sapApfCumulativeFilter){i.resolve({navigationMode:"forward",sapApfCumulativeFilter:w.sapApfCumulativeFilter});}else{i.resolve({navigationMode:"forward"});}});}else{i.resolve({navigationMode:"forward"});}if(q){q.replaceHash("");}return i.promise();};this.generateSelectionVariant=function(i){var q=jQuery.Deferred();if(!I.functions.isFilterReductionActive||!I.functions.isFilterReductionActive()){b=b||new F();i=b.reduceFilter(m,i);}if(!b||!b.isContradicted()){var s=i.mapToSelectOptions(I.functions.getAllParameterEntitySetKeyProperties);s.done(function(r){r.SelectionVariantID=jQuery.sap.uid();q.resolve(r);});}else{var r={};r={SelectionVariantID:jQuery.sap.uid(),Text:'Filter could not be converted to a selectionVariant'};q.resolve(r);}return q.promise();};function g(){c=I.functions.getNavigationTargets();}function h(q){for(var i=0,r=c.length;i<r;i++){if(c[i].id===q){return c[i];}}}function j(i){var q;if(i&&i.length>0){q={};i.forEach(function(r){q[r.key]=r.value;});}return q;}function k(t){var i=jQuery.extend(true,[],t);var r={global:[],stepSpecific:[]};i.forEach(function(s){if(s.isStepSpecific&&q(s.id)){delete s.isStepSpecific;r.stepSpecific.push(s);}else if(!s.isStepSpecific){delete s.isStepSpecific;r.global.push(s);}});return r;function q(s){var v=false;var w;var x=I.functions.getActiveStep();if(x&&x.getAssignedNavigationTargets){w=x.getAssignedNavigationTargets();if(w&&jQuery.isArray(w)){w.forEach(function(y){if(s===y.id){v=true;}});}}return v;}}function o(i){b=b||new F();var q=b.reduceFilter(m,i)||i;return q.getSingleValueTerms();}function p(i,t){t.forEach(function(q){i=i||[];i.push({'key':q.property,'value':q.value});});return i;}};sap.apf.utils.NavigationHandler=N;return N;},true);
