/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/utils/filter","sap/apf/core/utils/filter","sap/apf/utils/startFilter","sap/apf/utils/utils"],function(U,C,O,u){'use strict';var S=function(a){var s=[{isLevel:true}];var b=(a&&a.constructors&&a.constructors.StartFilter)||O;var r={};var c={};var d={};var e={};var m=a.instances.messageHandler;var f=jQuery.Deferred();var g=jQuery.Deferred();var h=false;var p=jQuery.Deferred();var n=0;var j=0;var k;var l=jQuery.Deferred();this.getStartFilters=function(){o().done(function(){f.resolve(w());});return f.promise();};this.setRestrictionByProperty=function(i){if(!k){k=jQuery.Deferred();}n++;var E=i.getInternalFilter();var F=E.getProperties()[0];r[F]=i;o();k.done(function(){var G=true;y().forEach(function(H){if(H.getPropertyName()===F){if(E.isDisjunctionOverEqualities()){var I=l.state()==="pending";H.setSelectedValues(t(E),I);}else{H.setContext(E);}G=false;}});if(G){s.unshift(new b(a,{multiSelection:true,property:F,invisible:true,notConfigured:true},E));}if(p.state()==='resolved'){p=jQuery.Deferred();}if(a.functions.getFacetFilterConfigurations().length===0){p.resolve(B(z()));}c[F]=i;delete r[F];if(!d[F]){d[F]=i.serialize();}j++;if(j===n){D();l.resolve();}});};this.getRestrictionByProperty=function(i){if(c[i]){return c[i];}else if(r[i]){return r[i];}return new U(m);};this.getCumulativeFilter=function(){var i=jQuery.Deferred();var E=new C(m);var F;o().done(function(){F=y().length;if(F===0){i.resolve(new C(m));}p.done(function(G,H,I){var J;J=new C(m);if(G&&G.type==='internalFilter'){J=G;}if(jQuery.isArray(G)){G.forEach(function(K){J.addOr(new C(m,I,'eq',K));});}if(H){E.addAnd(H).addAnd(J);}else{E=J;}i.resolve(E);});});return i.promise();};this.serialize=function(i,E){var F=jQuery.Deferred();var G;var H;var I={};I.startFilters=[];I.restrictionsSetByApplication={};for(H in c){I.restrictionsSetByApplication[H]=c[H].serialize();}G=y().length;if(y().length>0){y().forEach(function(J){J.serialize(i,E).done(function(K){I.startFilters.push(K);G--;if(G===0){F.resolve(I);}});});}else{F.resolve(I);}return F.promise();};this.deserialize=function(E){var F=jQuery.Deferred();p.done(function(){var s=y();var G;var H;c={};E.startFilters.forEach(function(I){for(var i=0,J=s.length;i<J;i++){if(I.propertyName===s[i].getPropertyName()){s[i].deserialize(I);}}});for(G in E.restrictionsSetByApplication){H=new U(m);H.deserialize(E.restrictionsSetByApplication[G]);c[G]=H;}p=jQuery.Deferred();D();p.done(function(){F.resolve();});});return F;};this.resetAll=function(){var i;y().forEach(function(E){E.reset();});c={};for(i in d){c[i]=new U(m).deserialize(d[i]);}D();};this.resetVisibleStartFilters=function(){w().forEach(function(G){G.reset();});var E=0;var F=s.length;for(var i=0;i<F;i++){if(s[i].isLevel){E=i+1;break;}}if(s[E]){s[E].setRestriction(e[s[E].getPropertyName()]);}};function o(){if(!h){h=true;a.instances.onBeforeApfStartupPromise.done(function(){a.functions.getReducedCombinedContext().done(function(E){var F=a.functions.getFacetFilterConfigurations();var G=E.getProperties();var H=G.length;var I=null;F.forEach(function(J){for(var i=0;i<H;i++){if(J.property===G[i]){I=G[i];break;}}if(I){var K=v(E,I);if(u.isPropertyTypeWithDateSemantics(J.metadataProperty)){K=u.convertDateListToInternalFormat(K,J.metadataProperty);}s.push(new b(a,J,K));G.splice(G.indexOf(I),1);I=null;}else{s.push(new b(a,J));}});G.forEach(function(i){s.unshift(new b(a,{property:i,invisible:true,multiSelection:true},v(E,i)));});if(!k){k=jQuery.Deferred();l.resolve();}k.resolve();l.done(function(){A().done(function(){q();g.resolve();});});});});}return g;}function q(){var s=x();s.forEach(function(E){E.getSelectedValues().done(F);function F(G,H){var I;var J=new C(m);var K;H.done(F);for(var i=0;i<s.length;i++){if(s[i]===E){I=i;break;}}if(I===s.length-1){if(p.state()==='resolved'){p=jQuery.Deferred();}p.resolve(G,e[E.getPropertyName()],E.getPropertyName());return;}else if(p.state()==='resolved'){p=jQuery.Deferred();}if(G&&G.type==='internalFilter'){J=G;}else if(jQuery.isArray(G)){G.forEach(function(L){J.addOr(E.getPropertyName(),'eq',L);});}if(e[E.getPropertyName()]){if(J.isEmpty()){K=e[E.getPropertyName()].copy();}else{if(e[E.getPropertyName()].isOr()){K=new C(m);K.addAnd(e[E.getPropertyName()]).addAnd(J);}else{K=e[E.getPropertyName()].copy().addAnd(J);}}}else{K=J;}e[s[I+1].getPropertyName()]=K;s[I+1].setRestriction(K);}});}function t(i){var E=[];i.getFilterTerms().forEach(function(F){E.push(F.getValue());});return E;}function v(E,F){var G=[];var H=E.getFilterTermsForProperty(F);var I=E.restrictToProperties([F]);if(I.toUrlParam().indexOf('%20and%20')>-1){return I;}for(var i=0,J=H.length;i<J;i++){if(H[i].getOp()!=='EQ'){return I;}G.push(H[i].getValue());}return G;}function w(){var i=[];y().forEach(function(E){if(E.isVisible()){i.push(E);}});return i;}function x(){var i=false;var E=[];s.forEach(function(F){if(F.isLevel){i=true;}else if(i===true){E.push(F);}});return E;}function y(){var i=[];s.forEach(function(E){if(!E.isLevel){i.push(E);}});return i;}function z(){var E=[];for(var i=0,F=s.length;i<F;i++){if(!s[i].isLevel){E.push(s[i]);}else{break;}}return E;}function A(){var E=jQuery.Deferred();F(B(z()));return E;function F(G){var i;var H=s.length;var I=G;var J=0;for(i=0;i<H;i++){if(s[i].isLevel){J=i+1;break;}}if(s[J]){s[J].setRestriction(I);e[s[J].getPropertyName()]=I.copy();K(J);}else{p.resolve(B(z()));E.resolve();}function K(L){if(s[L+1]){s[L].getSelectedValues().done(function(M){var N=new C(m);if(M&&M.type==='internalFilter'){N.addOr(M);}else if(jQuery.isArray(M)){M.forEach(function(P){N.addOr(s[L].getPropertyName(),'eq',P);});}if(!N.isEmpty()){I.addAnd(N);}s[L+1].setRestriction(I);e[s[L+1].getPropertyName()]=I.copy();K(L+1);});}else{E.resolve();}}}}function B(i){var E=new C(m);i.forEach(function(F){var G=new C(m);F.getSelectedValues().done(function(H){if(H.type==='internalFilter'){G.addOr(H);}else{H.forEach(function(I){G.addOr(F.getPropertyName(),'eq',I);});}});E.addAnd(G);});return E;}function D(){var E=0;var F=s.length;for(var i=0;i<F;i++){if(s[i].isLevel){E=i+1;break;}}if(s[E]){var G=B(z());e[s[E].getPropertyName()]=G;s[E].setRestriction(G);}else{p.resolve(B(z()));}}};sap.apf.utils.StartFilterHandler=S;return S;},true);
