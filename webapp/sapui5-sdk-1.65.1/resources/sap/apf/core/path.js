/*!
/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define([],function(){'use strict';function P(I){this.type="path";var m=I.instances.messageHandler;var c=I.instances.coreApi;var s=[];var a=[];var n=0;this.destroy=function(){a=[];s.forEach(function(i){i.destroy();});s=[];};this.getFilterInformation=function(){var i=false;var p=[];var j=a[0];s.forEach(function(k,l){if(!i){if(this.stepIsActive(k)){i=true;}else{p.push(k.getFilterInformation(j,l));}}}.bind(this));return Promise.all(p).then(function(r){return[].concat.apply([],r);});};this.getSteps=function(){return jQuery.extend(true,[],s);};this.addStep=function(S,i){s.push(S);this.update(i);};this.makeStepActive=function(S){var i=this.stepIsInPath(S);m.check(i,"An unknown step can't be an active step.",sap.apf.core.constants.message.code.errorCheckWarning);if(i){if(this.stepIsActive(S)===false){a.push(S);}}};this.makeStepInactive=function(S){var i=this.stepIsActive(S);m.check(i,"Only an active step can be removed from the active steps.",sap.apf.core.constants.message.code.errorCheckWarning);if(i){var j=jQuery.inArray(S,a);a.splice(j,1);}};this.stepIsActive=function(S){var i=jQuery.inArray(S,a);return(i>=0);};this.stepIsInPath=function(S){var i=jQuery.inArray(S,s);return(i>=0);};this.getActiveSteps=function(){return jQuery.extend(true,[],a);};this.getCumulativeFilterUpToActiveStep=function(){var i=jQuery.Deferred();var t=this;f().done(function(C){if(s.length===0){i.resolve(C);}else{j(0,C,function(o){i.resolve(o);});}});return i.promise();function j(k,C,l){s[k].determineFilter(C.copy(),function(F,o){if(o){C=o;}C.addAnd(F);if(t.stepIsActive(s[k])||!s[k+1]){l(C);return;}j(++k,C,l);});}};this.moveStepToPosition=function(S,i,j){var k=jQuery.inArray(S,s);var t=i;m.check(typeof i==="number"&&i>=0&&i<s.length,"Path: moveStepToPosition invalid argument for nPosition");m.check(k>=0&&k<s.length,"Path: moveStepToPosition invalid step");if(k===i){return;}s.splice(k,1);s.splice(t,0,S);this.update(j);};this.removeStep=function(S,i){var j=this.stepIsInPath(S);var k=this.stepIsActive(S);var l=jQuery.inArray(S,s);m.check(j,"Path: remove step - invalid step");s.splice(l,1);if(k){this.makeStepInactive(S);}this.update(i);S.destroy();};this.update=function(S,u){if(!s[0]){if(u){u();}return;}var i;var C=s[0];f().done(function(o){n++;i=n;C.update(o,j);function j(r,l){var p=jQuery.inArray(C,s);var M;if(i===n){if(r instanceof Error){var q=p+1;M=m.createMessageObject({code:"5002",aParameters:[q],callingObject:C});M.setPrevious(r);m.putMessage(M);C.setData({data:[],metadata:undefined},o);S(C,true);p++;C=s[p];while(C){C.setData({data:[],metadata:undefined},o);S(C,true);p++;C=s[p];}return;}if(l){C.setData(r,o);}S(C,l);if(i!==n){return;}C.determineFilter(o.copy(),k);}}function k(F,l){if(l){o=l;}o=h(o,F,C.getContextInfo());var p=jQuery.inArray(C,s);o.addAnd(F);C=s[p+1];if(C){C.update(o,j);}else{c.storeApfState();o=undefined;if(u){u();}}}});};this.serialize=function(){return{path:{steps:b(),indicesOfActiveSteps:g()}};};this.deserialize=function(S){d(S.path.steps,this);e(S.path.indicesOfActiveSteps,this);};function g(){var k=[];for(var i=0;i<s.length;i++){for(var j=0;j<a.length;j++){if(s[i]===a[j]){k.push(i);}}}return k;}function b(){var S=[];for(var i=0;i<s.length;i++){S.push(s[i].serialize());}return S;}function d(S,p){var o=p.update;p.update=function(){};var i;for(i=0;i<S.length;i++){c.createStep(S[i].stepId);}for(i=0;i<s.length;i++){s[i].deserialize(S[i]);}p.update=o;}function e(j,C){for(var i=0;i<j.length;i++){var k=j[i];C.makeStepActive(s[k]);}}this.checkAddStep=function(i){var j=jQuery.Deferred();var k=c.getConfigurationObjectById(i);var r=c.getConfigurationObjectById(k.binding).requiredFilters;if(k.type==="hierarchicalStep"&&r&&r.length===1){var l=c.getConfigurationObjectById(k.request);c.getMetadata(l.service).done(function(o){var p=o.getPropertyMetadata(l.entityType,r[0]);if(p["hierarchy-node-for"]===k.hierarchyProperty){s.forEach(function(q){if(q.type==="hierarchicalStep"){var t=q.getBinding().getRequiredFilters();if(t.length===1&&t[0]===r[0]){j.resolve(false,m.createMessageObject({code:5234,aParameters:[k.hierarchyProperty,c.getTextNotHtmlEncoded(q.getAdditionalConfigurationProperties().title.key)],enrichInfoInMessageObject:true}));}}});}if(j.state()==="pending"){j.resolve(true);}});}else{j.resolve(true);}return j.promise();};function f(){var j=jQuery.Deferred();jQuery.when(c.getCumulativeFilter(),c.getSmartFilterBarAsPromise()).done(function(k,l){var o,i,p;var r=k.copy();if(l){o=l.getFilters();o.forEach(function(w){r.addAnd(sap.apf.core.utils.Filter.transformUI5FilterToInternal(m,w));});p=l.getAnalyticalParameters();if(p&&p.length>0){for(i=0;i<p.length;i++){var q=p[i].fieldName;var t=p[i].fieldNameOData;var u=l.getFilters([q]);if(u&&u.length){var v=u[0].oValue1;r.addAnd(new sap.apf.core.utils.Filter(m,t,"EQ",v));}}}}j.resolve(r);});return j;}function h(i,j,S){if(I.exits&&I.exits.path&&I.exits.path.beforeAddingToCumulatedFilter){return I.exits.path.beforeAddingToCumulatedFilter(i,j,S);}return i;}}sap.apf.core.Path=P;return{constructor:P};},true);
