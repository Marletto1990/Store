/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.hierarchicalStep");jQuery.sap.require("sap.apf.core.step");jQuery.sap.require("sap.apf.core.utils.uriGenerator");jQuery.sap.require("sap.ui.model.odata.v2.ODataModel");jQuery.sap.require("sap.ui.model.Sorter");(function(){'use strict';sap.apf.core.HierarchicalStep=function(m,s,f,r,c){sap.apf.core.Step.call(this,m,s,f,r,c);var a;var b;var d;this.type="hierarchicalStep";var e=f.getConfigurationById(s.request).service;var g=f.getConfigurationById(s.request).entityType;var h=c.getAnnotationsForService(e);var i=s.hierarchyProperty;var j=jQuery.Deferred();var k=f.getConfigurationById(s.binding).requiredFilters;var l=c.getStartParameterFacade().getSapSystem();if(l){e=sap.ui.model.odata.ODataUtils.setOrigin(e,{force:true,alias:l});}jQuery.when(c.getMetadata(e),c.getEntityTypeMetadata(e,g)).then(function(p,q){var t=p.getHierarchyAnnotationsForProperty(g,i);if(t.type==="messageObject"){m.putMessage(t);}else{b=o(i,t);}a=f.createRequest({service:e,entityType:g,selectProperties:n(k[0],p,t),type:"request",id:"SelectionValidationRequest"});j.resolve(p,t,q);});var M=new sap.ui.model.odata.v2.ODataModel(e,{annotationURI:h});function n(p,q,t){var u=[p];var v=q.getPropertyMetadata(g,p)["sap:text"];if(v){u.push(v);}if(t.hierarchyNodeExternalKeyFor){u.push(t.hierarchyNodeExternalKeyFor);}return u;}function o(i,p){var q=[i];for(var t in p){q.push(p[t]);}q=q.concat(f.getConfigurationById(s.request).selectProperties);return sap.apf.core.utils.uriGenerator.getSelectString(q);}this.update=function(p,q){j.done(function(t,u,v){var w=p.restrictToProperties(t.getFilterablePropertiesAndParameters(g));var F=!w.isEqual(d);d=w.copy();var x="/"+sap.apf.core.utils.uriGenerator.generateOdataPath(m,t,g,p,t.getUriComponents(g).navigationProperty);var y={};y.path=x;var z=p.restrictToProperties(t.getFilterableProperties(g));if(!z.isEmpty()){y.filters=[z.mapToSapUI5FilterExpression()];}y.parameters={select:b,operationMode:sap.ui.model.odata.OperationMode.Server,useServerSideApplicationFilters:true,treeAnnotationProperties:u};y.sorter=this.getSorter();this.getBinding().updateTreetable(y,M,v,F);if(!this.getFilter().isEmpty()&&F){var A=z.removeTermsByProperty(k[0]);a.sendGetInBatch(A.addAnd(this.getFilter()),function(B){var C=B.data;var D=this.getFilter().getFilterTerms();var E=[];D.forEach(function(G){C.forEach(function(H){if(H[k[0]]===G.getValue()){E.push(H);}});});this.getBinding().setFilterValues(E);q({},true);}.bind(this));}else{q({},F);}}.bind(this));};this.getSorter=function(){var p=[];var q=this.getBinding().getRequestOptions();if(q&&q.orderby&&q.orderby.length>0){q.orderby.forEach(function(t){p.push(new sap.ui.model.Sorter(t.property,!t.ascending));});}if(p.length===0){return;}return p;};this.setData=function(){};this.adjustCumulativeFilter=function(p){if(k[0]&&!this.getFilter().isEmpty()){return p.removeTermsByProperty(k[0]);}return p;};};})();
