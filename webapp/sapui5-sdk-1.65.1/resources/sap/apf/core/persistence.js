/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(['sap/apf/core/constants'],function(c){'use strict';function P(I){var l;this.createPath=function(n,C,h){var R;var S=b(h);f().then(function(l){R={data:{AnalysisPath:"",AnalysisPathName:n,LogicalSystem:l,ApplicationConfigurationURL:I.functions.getComponentName(),SerializedAnalysisPath:JSON.stringify(h),StructuredAnalysisPath:JSON.stringify(S)},method:"POST"};if(I.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){R.data.AnalyticalConfiguration=I.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId().configurationId;}s(R,i);},function(m){C({oResponse:undefined,status:"failed"},{},m);});function i(o,E,m){if(m){C({oResponse:o,status:"failed"},E,m);}else{I.instances.messageHandler.check(o&&o.data&&o.statusCode===201,"Persistence create Path - proper response");C({AnalysisPath:o.data.AnalysisPath,status:"successful"},E,m);}}};this.readPaths=function(C){var R={method:"GET"};s(R,h.bind(this));function h(o,E,m){if(!m&&o&&o.data&&o.data.results){for(var i in o.data.results){o.data.results[i].StructuredAnalysisPath=JSON.parse(o.data.results[i].StructuredAnalysisPath);}}else if(!m||o.statusCode!==200){m=I.instances.messageHandler.createMessageObject({code:'5211'});}if(m){C({oResponse:o,status:"failed"},E,m);}else{C({paths:o.data.results,status:"successful"},E,m);}}};this.deletePath=function(A,C){var R={method:"DELETE"};s(R,h.bind(this),A);function h(o,E,m){if((o.statusCode!==204)&&(!m)){m=I.instances.messageHandler.createMessageObject({code:5201});m.setPrevious(I.instances.messageHandler.createMessageObject({code:5200,aParameters:[o.statusCode,o.statusText]}));}if(m){C({oResponse:o,status:"failed"},E,m);}else{C({status:"successful"},E,m);}}};this.modifyPath=function(A,n,C,h){var S=b(h);f().then(function(l){var o={data:{AnalysisPath:A,AnalysisPathName:n,LogicalSystem:l,ApplicationConfigurationURL:I.functions.getComponentName(),SerializedAnalysisPath:JSON.stringify(h),StructuredAnalysisPath:JSON.stringify(S)},method:"PUT"};if(I.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){o.data.AnalyticalConfiguration=I.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId().configurationId;}s(o,R.bind(this),A);},function(m){C({oResponse:undefined,status:"failed"},{},m);});function R(o,E,m){if((o.statusCode!==204)&&(!m)){m=I.instances.messageHandler.createMessageObject({code:5201});m.setPrevious(I.instances.messageHandler.createMessageObject({code:5200,aParameters:[o.statusCode,o.statusText]}));}if(m){C({oResponse:o,status:"failed"},E,m);}else{C({AnalysisPath:A,status:"successful"},E,m);}}};this.openPath=function(A,C){var R={method:"GET"};s(R,h,A);function h(o,E,m){var i;if(!m&&o&&o.statusCode===200&&o.data&&o.data.SerializedAnalysisPath){o.data.SerializedAnalysisPath=JSON.parse(o.data.SerializedAnalysisPath);}if(m){i=I.instances.messageHandler.createMessageObject({code:'5210'});i.setPrevious(m);I.instances.messageHandler.putMessage(i);}C({path:o.data,status:"successful"},E);}};function s(R,L,A){var S=function(D,o){d().done(function(m){L(o,m,undefined);});};var E=function(o){var m;if(o.messageObject&&o.messageObject.getCode&&o.messageObject.getCode()===5021){d().done(function(i){L(o,i,o.messageObject);});return;}var h=a(o.response.body);if(h!==undefined){m=I.instances.messageHandler.createMessageObject({code:h});}if(o.response.body.match("274")){m=I.instances.messageHandler.createMessageObject({code:'5207'});}if(o.response.statusCode===400){m=I.instances.messageHandler.createMessageObject({code:'5203'});}if(o.response.statusCode===403){m=I.instances.messageHandler.createMessageObject({code:'5206'});}if(o.response.statusCode===405){m=I.instances.messageHandler.createMessageObject({code:'5202'});}if(o.response.statusCode===404){m=I.instances.messageHandler.createMessageObject({code:'5208'});}if(!m&&o.response.statusCode===500){m=I.instances.messageHandler.createMessageObject({code:'5200',aParameters:[o.response.statusCode,o.response.statusText]});}if(!m){m=I.instances.messageHandler.createMessageObject({code:'5201'});}I.instances.messageHandler.putMessage(m);d().done(function(i){L(o,i,m);});};I.instances.coreApi.getPersistenceConfiguration().done(function(p){var u=p.path.service+"/"+p.path.entitySet;I.instances.coreApi.getXsrfToken(p.path.service).done(function(x){R.headers={"x-csrf-token":x};switch(R.method){case"GET":if(!R.data&&A){R.requestUri=u+"('"+A+"')";I.instances.coreApi.odataRequest(R,S,E);}else if(!R.data&&!A){g().then(function(h){R.requestUri=u+h;I.instances.coreApi.odataRequest(R,S,E);},function(m){d().done(function(h){L({},h,m);});});}break;case"POST":if(R.data&&!A){R.requestUri=u;}I.instances.coreApi.odataRequest(R,S,E);break;case"DELETE":if(!R.data&&A){R.requestUri=u+"('"+A+"')";}I.instances.coreApi.odataRequest(R,S,E);break;case"PUT":if(R.data&&A){R.requestUri=u+"('"+A+"')";}I.instances.coreApi.odataRequest(R,S,E);break;default:I.instances.coreApi.odataRequest(R,S,E);break;}});});}function g(){var h=jQuery.Deferred();f().then(function(l){var i="";if(I.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId()){i="AnalyticalConfiguration%20eq%20'"+I.instances.coreApi.getStartParameterFacade().getAnalyticalConfigurationId().configurationId+"'%20and%20";}var u="?$select=AnalysisPath,AnalysisPathName,StructuredAnalysisPath,CreationUTCDateTime,LastChangeUTCDateTime&$filter=("+i+"LogicalSystem%20eq%20'"+l+"'%20and%20"+"ApplicationConfigurationURL%20eq%20'"+I.functions.getComponentName()+"')"+"&$orderby=LastChangeUTCDateTime%20desc";h.resolve(u);},function(m){h.fail(m);});return h.promise();}function a(E){var h=E.match("52[0-9]{2}");if(h){return h[0];}return undefined;}function b(S){var h=[];var j=S.path.steps;var k;for(var i in j){h.push({stepId:j[i].stepId,selectedRepresentationId:j[i].binding.selectedRepresentationId});}k={steps:h,indexOfActiveStep:S.path.indicesOfActiveSteps[0]};return k;}function d(){var h=jQuery.Deferred();I.instances.coreApi.getPersistenceConfiguration().done(function(i){I.instances.coreApi.getEntityTypeMetadata(i.path.service,i.path.entitySet).done(function(m){h.resolve(m);});});return h;}function e(C){var t=C&&C.getFilterTermsForProperty('SAPClient');if(t===undefined||t.length!==1){return undefined;}return t[0].getValue();}function r(h,i){I.instances.coreApi.getPersistenceConfiguration().done(function(p){var m=I.instances.messageHandler;var j=p.logicalSystem;if(!j){l=i;h.resolve(i);return h.promise();}var S=j.service;var E=j.entitySet||j.entityType;if(S===null){l=i;h.resolve(i);return h.promise();}if(E===undefined){E=c.entitySets.logicalSystem;}I.instances.coreApi.getMetadata(S).done(function(k){I.instances.coreApi.getXsrfToken(S).done(function(x){var F=new sap.apf.core.utils.Filter(m,"SAPClient",'eq',i);var u=I.instances.coreApi.getUriGenerator().getAbsolutePath(S);u=u+I.instances.coreApi.getUriGenerator().buildUri(m,E,['LogicalSystem'],F,undefined,undefined,undefined,undefined,undefined,'Results',k);var R={requestUri:u,method:"GET",headers:{"x-csrf-token":x}};var o=function(D){var q;if(D&&D.results&&D.results instanceof Array&&D.results.length===1&&D.results[0].LogicalSystem){l=D.results[0].LogicalSystem;h.resolve(l);}else{q=m.createMessageObject({code:"5026",aParameters:[i]});h.fail(q);}};var n=function(q){var t=m.createMessageObject({code:"5026",aParameters:[i]});if(q.messageObject!==undefined&&q.messageObject.type==="messageObject"){t.setPrevious(q.messageObject);}h.fail(t);};I.instances.coreApi.odataRequest(R,o,n);});});});}function f(){var h=jQuery.Deferred();if(l){h.resolve(l);return h.promise();}var i=I.instances.coreApi.getStartParameterFacade().getSapClient();if(i){r(h,i);return h.promise();}I.instances.coreApi.getCumulativeFilter().done(function(C){i=e(C);if(!i){h.resolve('');}else{r(h,i);}});return h.promise();}}sap.apf.core.Persistence=P;return{constructor:P};},true);
