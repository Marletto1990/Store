/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2018 SAP AG. All rights reserved
 */
sap.ui.define(['sap/apf/core/constants','sap/apf/utils/utils','sap/apf/core/messageObject','sap/apf/utils/hashtable','sap/apf/core/messageDefinition'],function(c,u,M,H){'use strict';function a(l){var b={initial:0,startup:1,running:2,shutdown:3};var t=this;var T;var L=[];var n=0;var d;var m;var e;var o=false;var f=false;var g=false;var D=false;var h=false;var U="";var j={code:c.message.code.errorUnknown,severity:c.message.severity.error,rawText:"Unknown Error occurred"};var k=b.initial;var C=[];this.setLifeTimePhaseStartup=function(i){k=b.startup;};this.setLifeTimePhaseRunning=function(){k=b.running;};this.setLifeTimePhaseShutdown=function(){k=b.shutdown;};this.fatalErrorOccurredAtStartup=function(){var i;if(k!==b.startup){return false;}for(i=0;i<C.length;i++){if(C[i].getSeverity()===c.message.severity.fatal){return true;}}return false;};this.createMessageObject=function(i){var E=new M(i);if(l){if(E.getCode()===undefined){E.setCode(c.message.code.errorUnknown);}w.bind(this)(E);x(E,1);}else if(i.enrichInfoInMessageObject===true){w.bind(this)(E);}return E;};this.activateOnErrorHandling=function(O){o=O;if(o===true){jQuery(window).on("error",A);}else{jQuery(window).off("error");}};this.setTextResourceHandler=function(i){T=i;};this.loadConfig=function(E,R){if(d===undefined||R){d=new H(t);}for(var i=0;i<E.length;i++){z(E[i]);}};this.setMessageCallback=function(i){if(i!==undefined&&typeof i==="function"){m=i;}else{m=undefined;}};this.setCallbackForTriggeringFatal=function(i){if(i!==undefined&&typeof i==="function"){e=i;}else{e=undefined;}};this.putMessage=function(i){var P;var E=0;var F;if(i.getCode()===undefined){i.setCode(c.message.code.errorUnknown);}w.bind(this)(i);if(i.getSeverity()===c.message.severity.fatal){F=t.createMessageObject({code:c.message.code.errorExitTriggered});w.bind(this)(F);F.setSeverity(c.message.severity.fatal);if(F.getMessage()===""){F.setMessage("The app has stopped working due to a technical error.");}}P=i.getPrevious();while(P!==undefined&&P.type&&P.type==="messageObject"&&E<10){if(P.getCode()===undefined){P.setCode(c.message.code.errorUnknown);}w.bind(this)(P);P=P.getPrevious();E++;}if(F!==undefined){F.setPrevious(i);i=F;}if(!l){x(i,10);}C.push(i);if(f){return;}if(i.getSeverity()===c.message.severity.technError){return;}if(m!==undefined){if(k===b.shutdown||(k===b.startup&&i.getSeverity()!==c.message.severity.fatal)){return;}f=true;m(i);f=false;}if(e!==undefined&&g===false){g=true;e(i);g=false;}if(i.getSeverity()===c.message.severity.fatal&&k!==b.shutdown){if(sap.ui.Device.browser.firefox){h=true;}throw new Error(U);}};this.check=function(i,E,F){var G=F||c.message.code.errorCheck;if(!i){var I=this.createMessageObject({code:G,aParameters:[E]});t.putMessage(I);}};this.getConfigurationByCode=function(E){if(d===undefined){return undefined;}return d.getItem(E);};this.getLogMessages=function(){return jQuery.extend(true,[],L);};this.reset=function(){d=undefined;m=undefined;L=[];C=[];};this.isOwnException=function(i){return(i&&i.message&&i.message.search(U)>-1);};function p(E){if(sap.ui.Device.browser.firefox){return h;}return(E.originalEvent&&E.originalEvent.message&&E.originalEvent.message.search(U)>-1);}function q(E){return(E.originalEvent&&E.originalEvent.message&&E.originalEvent.message.search(U)===-1&&E.originalEvent.message.search(c.message.code.suppressFurtherException)>-1);}function r(){var i=u.createPseudoGuid(32);return c.message.code.suppressFurtherException+i;}function s(i){var E=parseInt(i,10);return(E==c.message.code.errorExitTriggered||E==c.message.code.errorUnknown||E==c.message.code.errorInMessageDefinition);}function v(i){var E=parseInt(i,10);return(E==c.message.code.errorExitTriggered||E==c.message.code.errorInMessageDefinition);}function w(i){function E(K,N){var O=0;while(K.indexOf("{"+O+"}")>-1){if(typeof N[O]==="string"){K=K.replace("{"+O+"}",N[O]);}else{K=K.replace("{"+O+"}","undefined");}O++;}return K;}var F=i.getCode();var G=t.getConfigurationByCode(F);if(G===undefined){G=jQuery.extend(true,{},j);if(s(F)){if(i.hasRawText()){G.rawText=i.getRawText();}G.rawText+=' '+i.getParameters();if(v(F)){G.severity=c.message.severity.fatal;}}else{G.rawText="Message "+F+"  "+i.getParameters()+" (Message Code has no Configuration)";}if(!s(F)){i.setCode(G.code);}}if(G.severity!==undefined){i.setSeverity(G.severity);}else{i.setSeverity(c.message.severity.technError);}if(G.rawText){i.setMessage(G.rawText);}else{var P=i.getParameters();if(i.getSeverity()===c.message.severity.technError){var I=t.getConfigurationByCode(G.code).text;if(!I){I=t.getConfigurationByCode(G.code).description;}i.setMessage(E(I,P));}else{try{if(T&&G.key){i.setMessage(T.getMessageText(G.key,i.getParameters()));}else if(G.description){i.setMessage(E(G.description,P));}else{i.setMessage("Message Code: "+F+" "+P.toString());}}catch(J){if(G.description){i.setMessage(E(G.description,P));}else{i.setMessage("Message Code: "+F+" "+P.toString());}}}}}function x(i,E){var F="APF message ";var P="";var G=E-1;if(E===0){return;}var I=i.getPrevious();if(I!==undefined){x(I,G);P=" - (see previous message for more information)";}n++;var J=F+'('+n+'): '+i.getCode()+" - "+i.getMessage()+P;if(D){alert("Fatal Error during Log Writing "+J);return;}D=true;if(i.getSeverity()===c.message.severity.fatal){if(L.length<2){L.unshift(J);}}switch(i.getSeverity()){case c.message.severity.warning:jQuery.sap.log.warning(J);break;case c.message.severity.error:jQuery.sap.log.error(J);break;case c.message.severity.fatal:jQuery.sap.log.error(J);break;case c.message.severity.technError:jQuery.sap.log.error(J);break;default:jQuery.sap.log.info(J);}D=false;}function y(i){t.check(i!==undefined&&i.hasOwnProperty("code")!==false,"MessageHandler setItem: oItem is undefined or property 'code' is missing",c.message.code.errorInMessageDefinition);var E=d.setItem(i.code,i);t.check((E===undefined),"MessageHandler setItem: Configuration includes duplicated codes",c.message.code.errorInMessageDefinition);}function z(i){if(i.type===undefined){i.type="message";}y(i);}function A(E){var i;var F="";var G="";var I="";var J="";var K=true;if(sap.ui.Device.browser.firefox){K=false;}if(K&&E&&E.originalEvent){F=E.originalEvent.message;I=E.originalEvent.filename;G=E.originalEvent.lineno;}if(p(E)){E.stopImmediatePropagation();E.preventDefault();}else if(q(E)){return;}else if(f){J="";if(K){J=F+" (source: "+I+":"+G+")";}i=new M({code:"5070",aParameters:[J]});w.bind(this)(i);x(i,1);}else{J="";if(K){J=F+" (source: "+I+":"+G+")";}i=new M({code:"5070",aParameters:[J]});w.bind(this)(i);x(i,1);}}function B(){U=r();}B();}sap.apf=sap.apf||{};sap.apf.core=sap.apf.core||{};sap.apf.core.MessageHandler=a;return a;});
