/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(['sap/apf/utils/utils','sap/apf/utils/hashtable','sap/ui/model/odata/v2/ODataModel','sap/ui/model/odata/ODataUtils'],function(u,H,O,a){'use strict';var M=function(I,A){this.type="metadata";var t=this;var b=jQuery.Deferred();var c=[];var H=(I&&I.constructors&&I.constructors.Hashtable)||H;var h=new H(I.instances.messageHandler);var o=new H(I.instances.messageHandler);var d=new H(I.instances.messageHandler);var e=new H(I.instances.messageHandler);var f=new H(I.instances.messageHandler);var g=new H(I.instances.messageHandler);var j=new H(I.instances.messageHandler);var k=new H(I.instances.messageHandler);var l=new H(I.instances.messageHandler);var m=new H(I.instances.messageHandler);var n=new H(I.instances.messageHandler);var p=new H(I.instances.messageHandler);var O=I.constructors.ODataModel||sap.ui.model.odata.v2.ODataModel;var D=false;if(I.deactivateFatalError){D=true;}var q;var r;var E;var s;var v=w(A);function w(i){var T=I.functions.getSapSystem();if(T){return sap.ui.model.odata.ODataUtils.setOrigin(i,{force:true,alias:T});}return i;}function x(i){var T;function U(W){if(!T.dataType){T.dataType={};}T.dataType[W]=T[W];}function V(W,X){if(jQuery.isArray(T[X])===true){(T[X]).forEach(function(Y){T[Y.name]=Y.value;});}else if(X!=="dataType"&&typeof(T[X])==="object"){if(Object.keys(T[X]).length===0){T[W]="true";}if(X!==W){jQuery.each(T[X],function(Y,Z){T[W]=Z;});}}else{T[W]=T[X];}}if(i===null){return{};}T=jQuery.extend(true,{},i);jQuery.each(T,function(W){switch(W){case'type':U(W);break;case'maxLength':U(W);break;case'precision':U(W);break;default:var X=W.split(".").pop();if(X.search("ISO")===0){V(X,W);}else{V(X.replace(/^./,X[0].toLowerCase()),W);}break;}});return T;}function y(i,T){if(e.hasItem(i)!==true){var U;var V={};var W={allParameters:[],keyParameters:[]};if(J(i)){U=Q(i);if(U.key&&U.key.propertyRef){U.key.propertyRef.forEach(function(X){V[X.name]=null;});}U.property.forEach(function(X){var Y=x(X);Y.isKey=V.hasOwnProperty(Y.name);W.allParameters.push(Y);if(Y.isKey){W.keyParameters.push(Y);}});}e.setItem(i,W);}if(!T){return e.getItem(i).allParameters;}return e.getItem(i).keyParameters;}function z(i){var T=[];var U;if(J(i)){i=P(i);}U=Q(i);U.property.forEach(function(V){T.push(V.name);});return T;}function B(T){var i;if(d.hasItem(T)===true){return d.getItem(T);}var U;var V=[];var W=[];var X=P(T);if(X&&K(X)){var Y=Q(X);Y.property.forEach(function($){V.push($.name);});}var Z=y(T,false);for(i=0;i<Z.length;i++){W.push(Z[i].name);}U=V.concat(W);d.setItem(T,U);return U;}function C(i){return g.getItem(i);}function F(i){var T=C(i);T=T||C(i+"Results");if(!T&&Q(i)){T=i;}return T;}function G(i){if(o.hasItem(i)===false){var T=[];var U=Q(i);U.property.forEach(function(V){if(!(V["sap:filterable"]==="false"||V.filterable&&V.filterable==="true")){T.push(V.name);}});o.setItem(i,T);}return o.getItem(i);}function J(i){return L(i)==="parameters";}function K(i){return L(i)==="aggregate";}function L(i){if(!k.hasItem(i)){var T=Q(i);var U=T&&T["sap:semantics"]||"undefined";k.setItem(i,U);}return k.getItem(i);}function N(i,T){if(h.hasItem(i+T)===false){var U=J(i);var V=Q(i);var W=q.getODataProperty(V,T);if(!W&&U){var X=P(i);V=Q(X);W=q.getODataProperty(V,T);}h.setItem(i+T,x(W));}return h.getItem(i+T);}function P(i){var T=m.getItem(i);if(T){return C(T.toAggregateEntitySet);}return i;}function Q(i){if(!i){return undefined;}if(!p.hasItem(i)){var T=q.getODataEntityType(E+i);if(!T){return T;}p.setItem(i,T);}return p.getItem(i);}function R(){var i;r=X();r.attachMetadataLoaded(function(){q=r.getMetaModel();q.loaded().then(function(){if(!r.getServiceMetadata()){i="5018";if(D){i="11013";}I.instances.messageHandler.putMessage(I.instances.messageHandler.createMessageObject({code:i,aParameters:[A],oCallingObject:t}));b.reject();return;}T();U();V(r);W();b.resolve(this);}.bind(this));}.bind(this));r.attachMetadataFailed(function(){i="5018";if(D){i="11013";}I.instances.messageHandler.putMessage(I.instances.messageHandler.createMessageObject({code:i,aParameters:[A],oCallingObject:t}));b.reject();return;});function T(){var Y={};var Z=q.getODataEntityContainer()&&q.getODataEntityContainer().entitySet;if(!Z){I.instances.messageHandler.putMessage(I.instances.messageHandler.createMessageObject({code:"5041",aParameters:[A],oCallingObject:t}));return;}Z.forEach(function(Z){var $=Z.entityType.split(/[. ]+/).pop();g.setItem(Z.name,$);j.setItem($,Z.name);if(!Y.hasOwnProperty($)){Y[$]=true;c.push($);}});}function U(){var Y=q.getODataEntityContainer()&&q.getODataEntityContainer().entitySet;if(!Y){return;}var Z=Y[0].entityType.split(".");Z.pop();E=Z.join(".")+".";}function V(Y){var Z=Y&&Y.getServiceAnnotations();if(Z&&Z.aliasDefinitions&&Z.aliasDefinitions.Capabilities){s=Z.aliasDefinitions.Capabilities+".";}}function W(){var Y=q.getODataEntityContainer();if(!Y||!Y.associationSet){return;}Y.associationSet.forEach(function(Z){var $=Z.end[0].entitySet,_=Z.end[1].entitySet,a1,b1;if(J(C($))){a1=$;}else if(K(C($))){b1=$;}if(J(C(_))){a1=_;}else if(K(C(_))){b1=_;}if(!a1||!b1){return;}var c1;var d1=Q(C(a1));var e1;d1.navigationProperty.forEach(function(g1){if(!e1&&g1.relationship===Z.association){c1=g1.name;e1=true;}});if(!c1){return;}var f1={navigationProperty:c1,fromParameterEntitySet:a1,toAggregateEntitySet:b1,fromIsUnique:undefined,toIsUnique:undefined};if(l.hasItem(a1)){f1.fromIsUnique=false;l.getItem(a1).fromIsUnique=false;}else{f1.fromIsUnique=true;l.setItem(a1,f1);m.setItem(C(a1),f1);}if(n.hasItem(b1)){n.getItem(b1).toIsUnique=false;}else{f1.toIsUnique=true;n.setItem(b1,f1);}});}function X(){var Y=I.instances.annotationHandler.getAnnotationsForService(A);var Z={annotationURI:Y,json:true};return new O(v,Z);}}this.getEntityTypes=function(){return c;};this.getPropertyMetadata=function(i,T){I.instances.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect EntityType name or type");I.instances.messageHandler.check(T!==undefined&&typeof T==="string","sap.apf.core.Metadata:getPropertyMetadata incorrect sPropertyName name or type");var U=F(i);if(!U){return{};}return N(U,T);};this.getUriComponents=function(i){if(!C(i)){if(C(i+"Results")){return{entitySet:i+"Results",navigationProperty:""};}return null;}var T;switch(L(C(i))){case"undefined":return{entitySet:i,navigationProperty:""};case"parameters":T=l.getItem(i);if(!T||T.fromIsUnique===false){return{entitySet:i,navigationProperty:undefined};}return{entitySet:i,navigationProperty:T.navigationProperty};case"aggregate":T=n.getItem(i);if(!T){return{entitySet:i,navigationProperty:""};}if(T.toIsUnique===false){return{entitySet:undefined,navigationProperty:undefined};}return{entitySet:T.fromParameterEntitySet,navigationProperty:T.navigationProperty};default:I.instances.messageHandler.check(false,"metadata : getUriComponents - not handled return value for sap semantics");}};this.getFilterableProperties=function(i){I.instances.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getFilterableProperties incorrect EntityType name or type");var T=F(i);if(!T){return[];}T=P(T);return G(T);};this.getAllPropertiesOfEntitySet=function(i){I.instances.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getAllPropertiesOfEntitySet incorrect EntitySet name or type");var T=F(i);if(!T){return[];}return z(T);};this.getAllProperties=function(){var i=[];var T;this.getEntityTypes().forEach(function(U){T=B(U);if(T.length===0){T=z(U);}i=i.concat(T);});i=u.eliminateDuplicatesInArray(I.instances.messageHandler,i);return i;};this.getFilterablePropertiesAndParameters=function(){var i=[];var T;var U=this.getEntityTypes();U.forEach(function(V){var W=Q(V);W.property.forEach(function(X){if(!(X["sap:filterable"]==="false")&&(X["sap:aggregation-role"]==="dimension")){i.push(X.name);}});T=y(V,false);T.forEach(function(X){i.push(X.name);});});return u.eliminateDuplicatesInArray(I.instances.messageHandler,i);};this.getParameterEntitySetKeyPropertiesForService=function(){var i=[];this.getEntityTypes().forEach(function(T){y(T,true).forEach(function(U){i.push(U.name);});});i=u.eliminateDuplicatesInArray(I.instances.messageHandler,i);return i;};this.getAllKeys=function(){var i=[];var T=[];this.getEntityTypes().forEach(function(U){var V=Q(U);T=[];if(V.key&&V.key.propertyRef){V.key.propertyRef.forEach(function(W){T.push(W.name);});}i=i.concat(T);});i=u.eliminateDuplicatesInArray(I.instances.messageHandler,i);return i;};this.getAttributes=function(i){var T=false;var U={};this.getEntityTypes().forEach(function(V){if(!T){U=N(V,i);if(U.name){T=true;}}});return U;};this.getParameterEntitySetKeyProperties=function(i){I.instances.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getParameterEntitySetKeyProperties incorrect EntityType name or type");var T=F(i);if(!T){return[];}return y(T,true);};this.getEntityTypeAnnotations=function(i){var T=F(i);I.instances.messageHandler.check(i!==undefined&&typeof i==="string","sap.apf.core.Metadata:getEntityTypeAnnotations incorrect EntityType name or type");if(f.hasItem(T)===true){return f.getItem(T);}var U={};W(T,U);var V=P(T);if(V!==T){W(V,U);}f.setItem(T,U);return f.getItem(T);function W(T,X){var Y;var Z;var $;var _=Q(T);for(Y in _){if(_.hasOwnProperty(Y)){if(Y.indexOf(s)!==0){continue;}Z=Y.split(".").pop();Z=Z.replace(/^./,Z[0].toLowerCase());for($ in _[Y]){if(_[Y].hasOwnProperty($)){X[Z]=_[Y][$];}}}}}};this.getEntitySets=function(){var i={};var T=[];var U=q.getODataEntityContainer();if(!U){return[];}if(U.associationSet){U.associationSet.forEach(function(V){var W,X,Y;W=F(V.end[0].entitySet);if(!J(W)){return;}Y=V.end[1].entitySet;X=F(Y);if(!J(X)){i[Y]=true;}});}if(U.entitySet){U.entitySet.forEach(function(V){if(!i[V.name]){T.push(V.name);}});}return T;};this.getAllEntitySetsExceptParameterEntitySets=function(){var i=q.getODataEntityContainer();var T=[];if(!i){return[];}if(i.entitySet){i.entitySet.forEach(function(U){var V=C(U.name);if(!J(V)){T.push(U.name);}});}return T;};this.getEntitySetByEntityType=function(i){return j.getItem(i);};this.getHierarchyAnnotationsForProperty=function(i,T){var U={};var V=this.getAllPropertiesOfEntitySet(i);if(V.length===0){return I.instances.messageHandler.createMessageObject({code:5072,aParameters:[i,A]});}var W=C(i);var X=P(W);V.forEach(function(Y){var Z=N(X,Y);if(Z["hierarchy-node-for"]===T){U.hierarchyNodeFor=Y;}});if(!U.hierarchyNodeFor){return I.instances.messageHandler.createMessageObject({code:5073,aParameters:[i,A,T]});}V.forEach(function(Y){var Z=N(X,Y);if(Z["hierarchy-level-for"]===U.hierarchyNodeFor){U.hierarchyLevelFor=Y;}else if(Z["hierarchy-parent-node-for"]===U.hierarchyNodeFor){U.hierarchyParentNodeFor=Y;}else if(Z["hierarchy-drill-state-for"]===U.hierarchyNodeFor){U.hierarchyDrillStateFor=Y;}else if(Z["hierarchy-node-external-key-for"]===U.hierarchyNodeFor){U.hierarchyNodeExternalKeyFor=Y;}});return U;};this.getHierarchicalEntitySets=function(){var i=[];var T=this.getEntitySets();T.forEach(function(U){var V=S.call(this,U);if(V.entitySet){i.push(V.entitySet);}}.bind(this));return i;};this.getHierarchicalPropertiesOfEntitySet=function(i){return S.call(this,i).hierarchyProperties;};function S(i){var T={};T.hierarchyProperties=[];var U=C(i);if(!U){return T;}var V=P(U);var W=this.getAllPropertiesOfEntitySet(i);W.forEach(function(X){var Y=N(V,X);var Z=false;var $=false;var _=false;if(Y["hierarchy-node-for"]!==undefined){var a1=Y["hierarchy-node-for"];var b1=X;W.forEach(function(X){var Y=N(V,X);if(Y["hierarchy-level-for"]===b1){Z=true;}else if(Y["hierarchy-parent-node-for"]===b1){$=true;}else if(Y["hierarchy-drill-state-for"]===b1){_=true;}});if(Z&&$&&_){T.entitySet=i;T.hierarchyProperties.push(a1);}}});return T;}this.getNonHierarchicalPropertiesOfEntitySet=function(i){var T=[];var U=C(i);if(!U){return T;}var V=P(U);var W=this.getAllPropertiesOfEntitySet(i);var X=S.call(this,i).hierarchyProperties;W.forEach(function(Y){var Z=N(V,Y);if(Z["hierarchy-node-for"]===undefined&&Z["hierarchy-node-external-key-for"]===undefined&&Z["hierarchy-parent-node-for"]===undefined&&Z["hierarchy-level-for"]===undefined&&Z["hierarchy-drill-state-for"]===undefined&&Z["hierarchy-node-descendant-count-for"]===undefined&&X.indexOf(Y)===-1){var $=Z.name;T.push($);}});return T;};this.getODataModel=function(){return r;};this.isInitialized=function(){return b.promise();};R.call(this);};sap.apf.core.Metadata=M;return M;},true);
