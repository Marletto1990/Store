/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.declare("sap.apf.core.step");jQuery.sap.require("sap.apf.core.utils.filter");jQuery.sap.require("sap.apf.core.utils.areRequestOptionsEqual");jQuery.sap.require("sap.apf.utils.utils");jQuery.sap.require("sap.apf.utils.filter");jQuery.sap.require("sap.apf.utils.executeFilterMapping");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require("sap.apf.core.metadataProperty");(function(){'use strict';sap.apf.core.Step=function(m,s,f,r,c){m.check(s!==undefined,"Step: step configuration is missing");m.check(s.binding!==undefined,"No binding assigned to step "+s.id+" in analytical configuration",sap.apf.core.constants.message.code.errorCheckConfiguration);var l=sap.apf.core.constants.representationMetadata.labelDisplayOptions;var t=this;var b,R,C,o;var a={responseData:[]};var A=jQuery.extend(true,{},s);this.type='step';this.title=jQuery.extend(true,{},s.title);this.longTitle=undefined;if(s.longTitle){this.longTitle=jQuery.extend(true,{},s.longTitle);}this.thumbnail=jQuery.extend(true,{},s.thumbnail);this.categories=s.categories;this.destroy=function(){if(b){b.destroy();}R=undefined;C=undefined;o=undefined;b=undefined;t=undefined;};this.getRequestConfiguration=function(){return f.getConfigurationById(s.request);};this.getAdditionalConfigurationProperties=function(){return A;};this.update=function(F,e){var g;var h=this.getFilter();var j=!F.isEqual(C);var k=b.getRequestOptions(j);var n=!sap.apf.core.utils.areRequestOptionsEqual(o,k);var p=f.getConfigurationById(s.request);c.getMetadata(p.service).then(function(q){if(!h.isEmpty()&&!s.topNSettings&&(b.getSelectedRepresentation().type==='TableRepresentation')){var u=h.getProperties()[0];var v=[u];var w=q.getPropertyMetadata(p.entityType,u)["sap:text"];if(w){v.push(w);}g={selectionFilter:h,requiredFilterProperties:v};}if(R&&(j||n)){R.sendGetInBatch(F,e,k,g);}else{e({},false);}},function(){e({},false);});};this.determineFilter=function(e,g){var n;var M;if(this.adjustCumulativeFilter){n=this.adjustCumulativeFilter(e);}if(d()&&this.getFilter().toUrlParam()){var h=f.getConfigurationById(s.filterMapping.requestForMappedFilter);h.selectProperties=s.filterMapping.target.slice();if(s.filterMapping.targetPropertyDisplayOption===l.TEXT||s.filterMapping.targetPropertyDisplayOption===l.KEY_AND_TEXT){c.getMetadata(h.service).done(function(p){var q=p.getPropertyMetadata(h.entityType,h.selectProperties[0]);if(q.text){h.selectProperties.push(q.text);}j.call(this,h);}.bind(this));}else{j.call(this,h);}}else{a.responseData=[];g(this.getFilter(),n);}function j(h){var p=f.createRequest(h);M=e.addAnd(this.getFilter());if(n){M=n.copy().addAnd(this.getFilter());}if(M.isEqual(a.mergedFilter)){g(a.mappedFilter,n);}else{sap.apf.utils.executeFilterMapping(M,p,s.filterMapping.target,k,m);}}function k(p,q,u){if(!q){if(s.filterMapping.keepSource==='true'){p=t.getFilter().addAnd(p);}a.mergedFilter=M;a.mappedFilter=p;a.responseData=u;g(p,n);}}};this.getBinding=function(){return b;};this.getFilter=function(){return b.getFilter(this.getContextInfo());};this.getContextInfo=function(){var e=f.getConfigurationById(s.request);var g={entityType:e.entityType,service:e.service};return g;};this.setData=function(D,F){var e=!F.isEqual(C);C=F.copy();o=jQuery.extend({},b.getRequestOptions(e));b.setData(D);};this.getRepresentationInfo=function(){return b.getRepresentationInfo();};this.getSelectedRepresentationInfo=function(){return b.getSelectedRepresentationInfo();};this.getSelectedRepresentation=function(){return b.getSelectedRepresentation();};this.setSelectedRepresentation=function(r){b.setSelectedRepresentation(r);};this.getFilterInformation=function(e,g){var h=jQuery.Deferred();var j;if(s.longTitle&&s.longTitle.key){j=c.getTextNotHtmlEncoded(s.longTitle.key);}else{j=c.getTextNotHtmlEncoded(s.title.key);}if(d()&&s.filterMapping.keepSource==="true"){jQuery.when(p(e,j),k(e,j)).then(function(u,v){h.resolve([u,v]);});}else if(d()){jQuery.when(k(e,j)).then(function(u){h.resolve([u]);});}else{jQuery.when(p(e,j)).then(function(u){h.resolve([u]);});}return h;function k(){var u=jQuery.Deferred();var v;if(s.filterMapping.targetPropertyLabelKey){v=c.getTextNotHtmlEncoded(s.filterMapping.targetPropertyLabelKey);}var w=s.filterMapping.target[0];var x=f.getConfigurationById(s.filterMapping.requestForMappedFilter);n(w,x).done(function(y){q(u,w,y,v,x,true);});return u;}function n(u,v){var w=jQuery.Deferred();c.getMetadata(v.service).done(function(x){var y;var z=new sap.apf.core.MetadataProperty(x.getPropertyMetadata(v.entityType,u));if(z.text){y=z.text;}var B=[];var D=s.filterMapping.targetPropertyDisplayOption;var E=false;a.responseData.forEach(function(F){if(D===l.TEXT&&y){B.push({text:F[y]});}else if(D===l.KEY_AND_TEXT&&y){B.push({text:c.getTextNotHtmlEncoded("keyAndTextSelection",[F[y],sap.apf.utils.convertToExternalFormat(F[u],z)])});}else{B.push({text:F[u]});E=true;}});B=sap.apf.utils.sortByProperty(B,"text",z);if(E===true){B.forEach(function(F){F.text=sap.apf.utils.convertToExternalFormat(F.text,z);});}w.resolve(B);});return w;}function p(){var u=jQuery.Deferred();var v;var w;var x=f.getConfigurationById(s.binding);var y=f.getConfigurationById(s.request);if(x.requiredFilters&&x.requiredFilters.length===1){v=x.requiredFilters[0];if(x.requiredFilterOptions&&x.requiredFilterOptions.fieldDesc){w=c.getTextNotHtmlEncoded(x.requiredFilterOptions.fieldDesc.key);}}q(u,v,b.getSortedSelections(),w,y,false);return u;}function q(u,v,w,x,y,z){var B;var D;if(!x){B=c.getMetadata(y.service);}if(v){D=c.getMetadata(e.getRequestConfiguration().service);}jQuery.when(B,D).then(function(E,F){var G=false;var H;var I=e.getRequestConfiguration().entityType;var J;if(F){J=F.getFilterableProperties(I).concat(F.getParameterEntitySetKeyProperties(I));}if(!x&&E&&v){x=E.getPropertyMetadata(y.entityType,v)["sap:label"];}if(!v){G=true;H=c.getTextNotHtmlEncoded("noSelectionPossible");}else if(J.indexOf(v)===-1){G=true;H=c.getTextNotHtmlEncoded("filterNotApplicable");}else if(w.length===0){G=true;H=c.getTextNotHtmlEncoded("nothingSelected");}u.resolve({text:j,selectablePropertyLabel:x||v,filterValues:w,infoIcon:z,infoText:z?c.getTextNotHtmlEncoded("infoIconfilterMapping"):undefined,warningIcon:G,warningText:H,stepIndex:g});});}};this.serialize=function(){return{stepId:s.id,binding:b.serialize()};};this.deserialize=function(S){b.deserialize(S.binding);m.check(s.id,S.stepId,"sap.apf.core.step.deserialize inconsistent serialization data - id "+S.stepId);return this;};this.getAssignedNavigationTargets=function(){return s.navigationTargets;};i();function i(){b=f.createBinding(s.binding,undefined,undefined,r);delete A.binding;if(s.request!==undefined&&s.request!==""){R=f.createRequest(s.request);delete A.request;}}function d(){if(s.filterMapping){if(s.filterMapping.requestForMappedFilter&&s.filterMapping.target instanceof Array&&s.filterMapping.keepSource){return true;}m.putMessage(m.createMessageObject({code:"5104"}));}return false;}};}());
