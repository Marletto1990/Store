/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/utils/utils","sap/apf/core/utils/filter","sap/apf/core/utils/filterTerm","sap/apf/core/utils/filterSimplify"],function(u,F,a,f){'use strict';var R=function(I,c){var m=I.instances.messageHandler;var C=I.instances.coreApi;var s=c.service;var b=c.selectProperties;var U=C.getUriGenerator();var M;if(s===undefined){M=m.createMessageObject({code:'5015',aParameters:[c.id]});m.putMessage(M);}var d=C.getMetadata(s);this.type=c.type;this.sendGetInBatch=function(o,e,r,S){d.done(function(g){C.getXsrfToken(s).done(function(x){var h=g.getUriComponents(c.entityType);var E,j;if(h){E=h.entitySet;j=h.navigationProperty;}m.check(E!==undefined,'Invalid request configuration: An entityset does not exist under the service '+c.entityType);m.check(j!==undefined,'Invalid request configuration: A usable navigation does not exist for the service '+c.entityType);var k;var l;G(o);if(o&&o.getProperties){k=o.restrictToProperties(g.getFilterableProperties(E));if(C.getStartParameterFacade().isFilterReductionActive()){l=new f.FilterReduction();k=l.reduceFilter(m,k);}}D(r);var p=r&&r.paging;var n=r&&r.orderby;var q=U.buildUri(m,E,b,k,o,n,p,undefined,B,j,g);var t=[{requestUri:q,method:'GET',headers:{'Accept-Language':sap.ui.getCore().getConfiguration().getLanguage(),'x-csrf-token':x}}];A();var v=U.getAbsolutePath(s);v=v+'$batch';var w={method:'POST',headers:{'x-csrf-token':x},requestUri:v,serviceMetadata:g.getODataModel().getServiceMetadata(),data:{__batchRequests:t}};var y=function(i,H){var J={};C.getEntityTypeMetadata(c.service,c.entityType).done(function(K){var L;try{var N='';if(i&&i.__batchResponses&&i.__batchResponses[0].data){J.data=i.__batchResponses[0].data.results;J.metadata=K;if(i.__batchResponses[0].data.__count){J.count=parseInt(i.__batchResponses[0].data.__count,10);}if(i.__batchResponses[1]&&i.__batchResponses[1].data){J.selectionValidation=i.__batchResponses[1].data.results;}e(J,true);}else if(i&&i.__batchResponses[0]&&i.__batchResponses[0].response&&i.__batchResponses[0].message){N=H.requestUri;var O=i.__batchResponses[0].message;var P=i.__batchResponses[0].response.body;L=u.extractOdataErrorResponse(P);var Q=i.__batchResponses[0].response.statusCode;J=m.createMessageObject({code:'5001',aParameters:[Q,O,L,N]});m.putMessage(J);}else{N=H.requestUri||q;J=m.createMessageObject({code:'5001',aParameters:['unknown','unknown error','unknown error',N]});m.putMessage(J);}}catch(T){if(!m.isOwnException(T)){L=T&&T.message||"";m.putMessage(m.createMessageObject({code:"5042",aParameters:[L]}));}}});};var z=function(i){var H='unknown error';var J;var K='unknown error';var L=q;if(i.message!==undefined){H=i.message;}var N='unknown';if(i.response&&i.response.statusCode){N=i.response.statusCode;K=i.response.statusText||'';L=i.response.requestUri||q;}if(i.messageObject&&i.messageObject.type==='messageObject'){m.putMessage(i.messageObject);e(i.messageObject);}else{J=m.createMessageObject({code:'5001',aParameters:[N,H,K,L]});m.putMessage(J);e(J);}};C.odataRequest(w,y,z,OData.batchHandler);function A(){if(S&&S.requiredFilterProperties&&S.selectionFilter){var i=k.copy();i.addAnd(S.selectionFilter);if(C.getStartParameterFacade().isFilterReductionActive()){i=l.reduceFilter(m,i);}var H=U.buildUri(m,E,S.requiredFilterProperties,i,o,undefined,undefined,undefined,B,j,g);t.push({requestUri:H,method:'GET',headers:{'Accept-Language':sap.ui.getCore().getConfiguration().getLanguage(),'x-csrf-token':x}});}}function B(P,i){var H="'";var J=g.getPropertyMetadata(E,P);if(J&&J.dataType){return u.formatValue(i,J);}if(typeof i==='number'){return i;}return H+u.escapeOdata(i)+H;}function D(r){var P,i;if(!r){return;}P=Object.getOwnPropertyNames(r);for(i=0;i<P.length;i++){if(P[i]!=='orderby'&&P[i]!=='paging'){m.putMessage(m.createMessageObject({code:'5032',aParameters:[E,P[i]]}));}}}function G(o){var i=g.getFilterableProperties(E);var H='';var J=g.getEntityTypeAnnotations(E);var K;if(J.requiresFilter!==undefined&&J.requiresFilter==='true'){if(J.requiredProperties!==undefined){H=J.requiredProperties;}}if(H===''){return;}if(jQuery.inArray(H,i)===-1){K=m.createMessageObject({code:'5006',aParameters:[E,H]});m.putMessage(K);}var P=o.getProperties();if(jQuery.inArray(H,P)===-1){K=m.createMessageObject({code:'5005',aParameters:[E,H]});m.putMessage(K);}}});});};};sap.apf.core.Request=R;return R;},true);
