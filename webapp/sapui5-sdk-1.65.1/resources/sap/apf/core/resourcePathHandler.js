/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.core.resourcePathHandler");jQuery.sap.require("sap.apf.core.utils.filter");jQuery.sap.require("sap.apf.utils.hashtable");jQuery.sap.require("sap.apf.core.messageHandler");jQuery.sap.require("sap.apf.core.messageDefinition");jQuery.sap.require("sap.apf.core.odataProxy");jQuery.sap.require("sap.apf.core.layeredRepositoryProxy");jQuery.sap.require("sap.apf.cloudFoundry.runtimeProxy");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require("sap.apf.utils.startParameter");jQuery.sap.require("sap.apf.utils.utils");sap.apf.core.ResourcePathHandler=function(i){var t=this;var c=i.instances.coreApi;var m=i.instances.messageHandler;var h=new sap.apf.utils.Hashtable(m);var C;var p;var s=null;var d=jQuery.Deferred();var l=false;var P;this.loadConfigFromFilePath=function(F){if(l){return;}l=true;var w=c.getStartParameterFacade().getAnalyticalConfigurationId();var U=F;c.ajax({url:U,dataType:"json",success:x,error:function(J,S,E){var M=m.createMessageObject({code:"5068",aParameters:[U,S,E]});r(M);},async:true,suppressSapSystem:true});function x(D,S,J){var T=i.functions.checkForTimeout(J);var M;if(T){M=m.createMessageObject({code:"5054",aParameters:[F]});M.setPrevious(T);r(M);}if(!D||!D.applicationConfiguration){r(m.createMessageObject({code:"5055",aParameters:[F]}));}if(D.applicationConfiguration.textResourceLocations===undefined){r(m.createMessageObject({code:"5056",aParameters:[F]}));return;}q(D,w);f().done(function(){if(w){a(w);}else{e();}});}};function u(){return c.getStartParameterFacade().isLrepActive();}function a(w){var x=w.applicationId;var y=w.configurationId;if(u()&&!x){r(m.createMessageObject({code:"5024"}));}var z=new P({serviceRoot:p&&p.path&&p.path.service,entityTypes:{configuration:sap.apf.core.constants.entitySets.configuration,texts:sap.apf.core.constants.entitySets.texts}},{instances:{coreApi:c,messageHandler:m},manifests:i.manifests});if(u()){var A=[];var B=jQuery.Deferred();A.push(B);A.push(b(x,z));}z.readEntity("configuration",function(D,E,F){if(F){r(m.createMessageObject({code:"5022",aParameters:[y]}));d.resolve();}else{var G=JSON.parse(D.SerializedAnalyticalConfiguration);c.loadAnalyticalConfiguration(G);if(G.applicationTitle){C.appName=G.applicationTitle.key;C.appTitle=G.applicationTitle.key;}if(u()){B.resolve();}else{x=x||D.Application;b(x,z).then(function(){d.resolve();});}}},[{name:"AnalyticalConfiguration",value:y}],undefined,x,{layer:'ALL'},{'noMetadata':true});if(u()){jQuery.when.apply(jQuery,A).then(function(){d.resolve();});}}function b(w,x){var y=jQuery.Deferred();var z=new sap.apf.core.utils.Filter(m,'Application','eq',w);var A=new sap.apf.core.utils.Filter(m,'Language','eq',sap.apf.core.constants.developmentLanguage);A.addAnd(z);var B=["TextElement","TextElementDescription"];x.readCollection('texts',function(D,E,F){if(F){r(m.createMessageObject({code:"5023",aParameters:[c.getStartParameterFacade().getAnalyticalConfigurationId()]}));}else{c.loadTextElements(D);}y.resolve();},undefined,B,A,{layer:'ALL'});return y.promise();}function e(){var U=t.getResourceLocation(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation);var M;if(U!==""){c.ajax({url:U,dataType:"json",success:function(D,S,J){if(D){c.loadAnalyticalConfiguration(D);if(D.applicationTitle){C.appName=D.applicationTitle.key;C.appTitle=D.applicationTitle.key;}d.resolve();}else{M=m.createMessageObject({code:"5057",aParameters:[U]});r(M);}},error:function(J,S,E,w){M=m.createMessageObject({code:"5057",aParameters:[U]});if(w){M.setPrevious(w);}r(M);},async:true,suppressSapSystem:true});}else{M=m.createMessageObject({code:"5060"});r(M);}}function f(){c.loadMessageConfiguration(sap.apf.core.messageDefinition,true);return g(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,false);}function g(R,w){var x=jQuery.Deferred();var U=t.getResourceLocation(R);if(U!==""){c.ajax({url:U,dataType:"json",success:y,error:function(J,S,E,z){var M=m.createMessageObject({code:"5058",aParameters:[S,E,U]});if(z){M.setPrevious(z);}r(M);},async:true,suppressSapSystem:true});}else{x.resolve();}return x.promise();function y(D,S,J){var M;var T=i.functions.checkForTimeout(J);if(!T){if(D.messageConfiguration){c.loadMessageConfiguration(D.messageConfiguration.definitions,w);}}else{M=m.createMessageObject({code:"5067"});M.setPrevious(T);r(M);}x.resolve();}}function j(w){var M;if(!w||!w.path){M=m.createMessageObject({code:"5066"});r(M);}if(!w.path.service){M=m.createMessageObject({code:"5067"});r(M);}if(w.analyticalConfiguration){if(!w.analyticalConfiguration.service){M=m.createMessageObject({code:sap.apf.core.constants.message.code.errorInAnalyticalConfig,rawText:"service or entity set are missing in analytical configuration in the application configuration"});r(M);}}}function k(w){var M;if(w.evaluations&&!w.evaluations.service){M=m.createMessageObject({code:"5063"});r(M);}if(w.evaluations&&(!w.evaluations.type||w.evaluations.type!=="smartBusinessRequest")){M=m.createMessageObject({code:"5062",rawText:"type in Smart Business configuration is not smartBusinessRequest"});r(M);}if(w.evaluations&&!w.evaluations.entityType){M=m.createMessageObject({code:"5061"});r(M);}}this.getResourceLocation=function(R){return h.getItem(R);};this.getPersistenceConfiguration=function(){var w=jQuery.Deferred();d.done(function(){w.resolve(p);});return w;};this.getConfigurationProperties=function(){var w=jQuery.Deferred();i.corePromise.done(function(){w.resolve(C);});return w;};function n(){var w=sap.apf.core.utils.uriGenerator;var x,y,z;var A=i.manifests.manifest;var B=i.manifests.baseManifest;var M;if(d.state()==='resolved'){return;}var D=w.getBaseURLOfComponent(sap.apf.utils.getComponentNameFromManifest(i.manifests.baseManifest));var E=w.getBaseURLOfComponent(sap.apf.utils.getComponentNameFromManifest(i.manifests.manifest));if(A["sap.app"].dataSources&&A["sap.app"].dataSources.PathPersistenceServiceRoot){z=A["sap.app"].dataSources.PathPersistenceServiceRoot.uri;}else if(i.functions.isUsingCloudFoundryProxy()){z="";}else{M=m.createMessageObject({code:"5064"});r(M);}var F=B["sap.app"].i18n;F=w.addRelativeToAbsoluteURL(D,F);var G=A["sap.app"].i18n;G=w.addRelativeToAbsoluteURL(E,G);var H=A["sap.app"].title;var I=sap.apf.utils.createPseudoGuid();c.registerTextWithKey(I,H);var J=c.getStartParameterFacade().getAnalyticalConfigurationId();var K="";if(A["sap.app"].dataSources&&A["sap.app"].dataSources.AnalyticalConfigurationLocation&&A["sap.app"].dataSources.AnalyticalConfigurationLocation.uri){K=A["sap.app"].dataSources.AnalyticalConfigurationLocation.uri;K=w.addRelativeToAbsoluteURL(E,K);}if(!J&&!K){M=m.createMessageObject({code:"5065"});r(M);}var L={"appName":I,"appTitle":I,"analyticalConfigurationLocation":K,"textResourceLocations":{"apfUiTextBundle":F,"applicationUiTextBundle":G},"persistence":{"path":{"service":z}}};if(A["sap.apf"]&&A["sap.apf"].appSpecificParameters){for(x in A["sap.apf"].appSpecificParameters){L[x]=A["sap.apf"].appSpecificParameters[x];}}if(A["sap.app"].dataSources&&A["sap.app"].dataSources.SmartBusiness){y=A["sap.app"].dataSources.SmartBusiness.uri;L.smartBusiness={runtime:{service:y}};}if(A["sap.app"].dataSources&&A["sap.app"].dataSources.LogicalSystem){L.persistence.logicalSystem={service:A["sap.app"].dataSources.LogicalSystem.uri};}q({applicationConfiguration:L},J);f().done(function(){if(J){a(J);}else{e();}});}function o(){var A=c.getUriGenerator().getApfLocation();h.setItem(sap.apf.core.constants.resourceLocation.apfUiTextBundle,A+"resources/i18n/apfUi.properties");h.setItem(sap.apf.core.constants.resourceLocation.applicationMessageDefinitionLocation,"");h.setItem(sap.apf.core.constants.resourceLocation.applicationMessageTextBundle,"");h.setItem(sap.apf.core.constants.resourceLocation.applicationUiTextBundle,"");h.setItem(sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation,"");}function q(w,x){function y(A){C=jQuery.extend(true,{},A);delete C.type;delete C.analyticalConfigurationLocation;delete C.applicationMessageDefinitionLocation;delete C.textResourceLocations;delete C.persistence;}var A=w.applicationConfiguration;y(A);var T=w.applicationConfiguration.textResourceLocations;p=w.applicationConfiguration.persistence;if(!i.functions.isUsingCloudFoundryProxy()){j(p);if(!p.path.entitySet){p.path.entitySet=sap.apf.core.constants.entitySets.analysisPath;}}if(w.applicationConfiguration.smartBusiness){s=w.applicationConfiguration.smartBusiness;k(s);}var M;var U;var z;for(z in sap.apf.core.constants.resourceLocation){if(!sap.apf.core.constants.resourceLocation.hasOwnProperty(z)){continue;}if(z===sap.apf.core.constants.resourceLocation.analyticalConfigurationLocation&&x){continue;}if(A[z]!==undefined){U=A[z];}else if(T[z]!==undefined){U=T[z];}else{continue;}if(i.manifests){h.setItem(z,U);}else if(z===sap.apf.core.constants.resourceLocation.apfUiTextBundle||i.instances.fileExists.check(U,true)){h.setItem(z,U);}else if(!x){M=m.createMessageObject({code:"5059",aParameters:[U,z]});r(M);}}}function r(w){m.putMessage(w);}function v(){var A;var w;var x;jQuery.when(d).done(function(){A=t.getResourceLocation(sap.apf.core.constants.resourceLocation.apfUiTextBundle);w=t.getResourceLocation(sap.apf.core.constants.resourceLocation.applicationUiTextBundle);x=t.getResourceLocation(sap.apf.core.constants.resourceLocation.applicationMessageTextBundle);i.functions.initTextResourceHandlerAsPromise(A,w,x).done(function(){i.corePromise.resolve();});});}o();if(i.constructors&&i.constructors.ProxyForAnalyticalConfiguration){P=i.constructors.ProxyForAnalyticalConfiguration;}else if(i.functions.isUsingCloudFoundryProxy()){P=sap.apf.cloudFoundry.RuntimeProxy;}else if(u()){P=sap.apf.core.LayeredRepositoryProxy;}else{P=sap.apf.core.OdataProxy;}if(i.manifests&&i.manifests.manifest){n();}if(i.corePromise){v();}};}());
