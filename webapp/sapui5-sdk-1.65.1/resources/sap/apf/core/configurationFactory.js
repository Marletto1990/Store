/*!
 * SAP APF Analysis Path Framework
 * 
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
(function(){'use strict';jQuery.sap.declare("sap.apf.core.configurationFactory");jQuery.sap.require("sap.apf.core.step");jQuery.sap.require("sap.apf.core.hierarchicalStep");jQuery.sap.require("sap.apf.core.request");jQuery.sap.require("sap.apf.utils.hashtable");jQuery.sap.require("sap.apf.core.binding");jQuery.sap.require("sap.apf.core.representationTypes");jQuery.sap.require("sap.apf.core.constants");jQuery.sap.require('sap.apf.utils.utils');sap.apf.core.ConfigurationFactory=function(I){var t=this;var m;var s=false;var d=jQuery.Deferred();var a=new sap.apf.utils.Hashtable(I.instances.messageHandler);var b=function(i){I.instances.messageHandler.check(i!==undefined&&i.hasOwnProperty("id")!==false,"oItem is undefined or property 'id' is missing",sap.apf.core.constants.message.code.errorCheckConfiguration);if(!a){a=new sap.apf.utils.Hashtable(I.instances.messageHandler);}var E=a.setItem(i.id,i);I.instances.messageHandler.check((E===undefined),"Configuration includes duplicated identifiers (IDs): "+i.id+"",sap.apf.core.constants.message.code.errorCheckConfigurationWarning);};var g=function(i){var R=[];if(!s&&d.state()==='pending'){I.instances.messageHandler.putMessage(I.instances.messageHandler.createMessageObject({code:"5020"}));}if(a.getNumberOfItems()!==0){a.each(function(E,F){if(F.type===i){R.push(F);}});return R;}return R;};function c(i){if(!sap.apf.core.constants.configurationObjectTypes.hasOwnProperty(i.type)){I.instances.messageHandler.putMessage(I.instances.messageHandler.createMessageObject({code:"5033",aParams:[i.type]}));}if(i.type===sap.apf.core.constants.configurationObjectTypes.facetFilter&&!(i.property)){I.instances.messageHandler.putMessage(I.instances.messageHandler.createMessageObject({code:"5034"}));}a.setItem(i.id,i);}function l(i){if(i.type===undefined){i.type="step";}b(i);}function e(i){I.instances.messageHandler.check(i!==undefined&&i instanceof Array!==false,"aSteps is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);i.forEach(function(E){l(E);});}function f(R){if(R.type===undefined){R.type="request";}if(R.entitySet){R.entityType=R.entitySet;delete R.entitySet;}b(R);}function h(i){if(i.type===undefined){i.type="navigationTarget";}b(i);}function j(R){I.instances.messageHandler.check(R!==undefined&&R instanceof Array!==false,"aRequests is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);R.forEach(function(i){f(i);});}function k(i){function E(){var F=new sap.apf.utils.Hashtable(I.instances.messageHandler);i.representations.forEach(function(G){if(!(G.id&&typeof G.id==="string")){I.instances.messageHandler.putMessage(I.instances.messageHandler.createMessageObject({code:"5028",aParameters:[i.id]}));}if(F.setItem(G.id,G.id)){I.instances.messageHandler.putMessage(I.instances.messageHandler.createMessageObject({code:"5029",aParameters:[i.id]}));}});}if(i.type===undefined){i.type="binding";}I.instances.messageHandler.check(i.id!==undefined,"binding has no id");I.instances.messageHandler.check(i.representations!==undefined&&i.representations instanceof Array!==false,"representations for binding "+i.id+" not defined",sap.apf.core.constants.message.code.errorCheckConfiguration);E();b(i);}function n(i){I.instances.messageHandler.check(i!==undefined&&i instanceof Array!==false,"aBindings is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);i.forEach(function(E){k(E);});}function o(i){I.instances.messageHandler.check(i!==undefined&&i instanceof Array!==false,"navigationTarget is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);i.forEach(function(E){h(E);});}function p(i){a.setItem("configHeader",i);}function q(i){if(i.type===undefined){i.type="category";}b(i);}function r(i){I.instances.messageHandler.check(i!==undefined&&i instanceof Array!==false,"aCategories is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);i.forEach(function(E){var F=E.steps;I.instances.messageHandler.check(F!==undefined&&F instanceof Array!==false,"steps for category "+E.id+" are missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);F.forEach(function(G){I.instances.messageHandler.check(G.type&&(G.type==="step"||G.type==="hierarchicalStep")&&G.id,"step with wrong format assigned to category '"+E.id+"'");I.instances.messageHandler.check(t.existsConfiguration(G.id),"step with id '"+G.id+"' which is assigned to category '"+E.id+"' does not exist");});q(E);});}function u(i){var E=false;var R=sap.apf.core.representationTypes();R.forEach(function(F){if(i===F.id){E=true;}});return E;}function v(R){var i;if(R.type===undefined){R.type="representationType";}if(!u(R.id)){i=sap.apf.utils.extractFunctionFromModulePathString(R.constructor);if(!jQuery.isFunction(i)){I.instances.messageHandler.putMessage(I.instances.messageHandler.createMessageObject({code:'5030',parameters:[R.id]}));}}b(R);}function w(R){I.instances.messageHandler.check(R!==undefined&&R instanceof Array!==false,"aRepresentationInfo is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);R.forEach(function(i){v(i);});}function x(i){if(i.type===undefined){i.type='smartFilterBar';}c(i);}function y(F){if(F.type===undefined){F.type="facetFilter";}c(F);}function z(F){I.instances.messageHandler.check(F!==undefined&&F instanceof Array!==false,"Facet filter configuration is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);if(F.length===0){a.setItem(sap.apf.core.constants.existsEmptyFacetFilterArray,true);return;}F.forEach(y);}function A(F,i,E,G){var H,J,K;function M(R){return R.alias||R.property;}function N(R){var U=(R.preselectionDefaults&&R.preselectionDefaults.length>0);var V=(R.valueList&&R.valueList.length>0);return U||V;}function O(J,R,F,i,G){J.metadataProperty=R;y(J);A(F,i,E,G);}function P(J,R){if(sap.apf.utils.isPropertyTypeWithDateSemantics(R)){J.preselectionDefaults=sap.apf.utils.convertDateListToInternalFormat(J.preselectionDefaults,R);J.valueList=sap.apf.utils.convertDateListToInternalFormat(J.valueList,R);}}if(i===F.length){E.resolve();s=false;return;}J=F[i];i++;K=M(J);m=m||I.instances.coreApi.getMetadataFacade();var Q=jQuery.inArray(K,G)>-1;if(Q&&N(J)){if(J.valueHelpRequest||J.filterResolutionRequest){if(J.valueHelpRequest){H=a.getItem(J.valueHelpRequest);}else if(J.filterResolutionRequest){H=a.getItem(J.filterResolutionRequest);}m.getPropertyMetadataByEntitySet(H.service,H.entityType,K).done(function(R){P(J,R);O(J,R,F,i,G);});}else{m.getProperty(K).done(function(R){P(J,R);O(J,R,F,i,G);});}}else if(Q){if(J.valueHelpRequest||J.filterResolutionRequest){if(J.valueHelpRequest){H=a.getItem(J.valueHelpRequest);}else if(J.filterResolutionRequest){H=a.getItem(J.filterResolutionRequest);}m.getPropertyMetadataByEntitySet(H.service,H.entityType,K).done(function(R){O(J,R,F,i,G);});}else{m.getProperty(K).done(function(R){O(J,R,F,i,G);});}}else{O(J,{},F,i,G);}}function B(F){var i=jQuery.Deferred();m=m||I.instances.coreApi.getMetadataFacade();I.instances.messageHandler.check(F!==undefined&&F instanceof Array!==false,"Facet filter configuration is missing or not an Array",sap.apf.core.constants.message.code.errorCheckConfiguration);if(F.length===0){a.setItem(sap.apf.core.constants.existsEmptyFacetFilterArray,true);i.resolve();return i.promise();}s=true;m.getAllProperties(function(E){A(F,0,i,E);});return i.promise();}function C(R){w(R);}function S(i,F){function E(i,J){var K=J.getConfigurationById(i.binding).representations;if(K){return K;}I.instances.messageHandler.check(false,'Binding of step with ID "'+i.id+'" does not contain any representations.',sap.apf.core.constants.message.code.errorCheckConfigurationWarning);}function G(i,J){var K;var M=[];if(i.binding){K=E(i,J);K.forEach(function(N){var O=jQuery.extend(true,{},J.getConfigurationById(N.representationTypeId));O.representationId=N.id;O.representationLabel=N.label;O.parameter=jQuery.extend(true,{},N.parameter);M.push(O);});return M;}I.instances.messageHandler.check(false,'Step with ID "'+i.id+'" does not contain any binding references.',sap.apf.core.constants.message.code.errorCheckConfigurationWarning);}var H=jQuery.extend(true,{},i);var R=G(i,F);delete H.request;delete H.binding;delete H.thumbnail;delete H.longTitle;H.type="stepTemplate";H.getRepresentationInfo=function(){var J=jQuery.extend(true,[],R);J.forEach(function(K){delete K.id;delete K.type;delete K.constructor;});return J;};return H;}var D=function(i,E){var t=this;this.type=i.type;this.id=i.id;this.label=i.label;this.stepTemplates=[];i.steps.forEach(function(F){var G=E.getConfigurationById(F.id);t.stepTemplates.push(new S(G,E));});return this;};var T=function(i,F){this.type="thumbnail";if(i===undefined){return this;}this.leftUpper=F.createLabel(i.leftUpper);this.rightUpper=F.createLabel(i.rightUpper);this.leftLower=F.createLabel(i.leftLower);this.rightLower=F.createLabel(i.rightLower);this.altTitle=F.createLabel(i.altTitle);return this;};this.createThumbnail=function(i){return new T(i,this);};function L(i){this.type="label";this.kind=i.kind;if(this.kind==="text"){this.file=i.file;this.key=i.key;}else if(this.kind==="property"){this.property=i.property;}else if(this.kind==="sapLabel"){this.labelOf=i.labelOf;}}this.createLabel=function(i){return new L(i,this);};this.loadConfig=function(i,E){a=new sap.apf.utils.Hashtable(I.instances.messageHandler);if(i.applicationTitle){a.setItem('applicationTitle',i.applicationTitle);}var F={constructors:{Hashtable:sap.apf.utils.Hashtable},instances:{messageHandler:I.instances.messageHandler}};sap.apf.utils.migrateConfigToCategoryStepAssignment(i,F);var R=sap.apf.core.representationTypes();C(R);e(i.steps);r(i.categories);j(i.requests);n(i.bindings);if(i.representationTypes){w(i.representationTypes);}if(i.smartFilterBar){x(i.smartFilterBar);}if(i.facetFilters){if(E){z(i.facetFilters);d.resolve();}else{B(i.facetFilters).done(function(){d.resolve();});}}else{d.resolve();}if(i.navigationTargets){o(i.navigationTargets);}if(i.configHeader){p(i.configHeader);}return d;};this.getConfigurationById=function(i){return a.getItem(i);};this.existsConfiguration=function(i){return a.hasItem(i);};this.getServiceDocuments=function(){var R=g("request");var i=[];R.forEach(function(E){i.push(E.service);});return sap.apf.utils.eliminateDuplicatesInArray(I.instances.messageHandler,i);};this.getNavigationTargets=function(){var i=g("navigationTarget");return jQuery.extend(true,[],i);};this.getStepTemplates=function(){var i=[];var E=g("step");E=jQuery.merge(E,g("hierarchicalStep"));E.forEach(function(F,G){i[G]=new S(F,t);});return i;};this.getSmartFilterBarConfiguration=function(){var i=jQuery.Deferred();var E;d.done(function(){E=g('smartFilterBar')[0];if(typeof E==='object'&&E.service&&(E.entityType||E.entitySet)){i.resolve(jQuery.extend(true,{},E));}else{i.resolve();}});return i.promise();};this.getFacetFilterConfigurations=function(){var E=g("facetFilter");var F,G,i;var H=jQuery.extend(true,[],E);for(i=0;i<H.length;i++){G=H[i];if(E[i].metadataProperty&&E[i].metadataProperty.clone){G.metadataProperty=E[i].metadataProperty.clone();}if(G.preselectionFunction){F=sap.apf.utils.extractFunctionFromModulePathString(G.preselectionFunction);if(!jQuery.isFunction(F)){I.instances.messageHandler.putMessage(I.instances.messageHandler.createMessageObject({code:'5035',parameters:[G.id]}));G.preselectionFunction=undefined;}else{G.preselectionFunction=F;}}}return H;};this.getCategories=function(){var i=g("category");var E=[];i.forEach(function(F,G){E[G]=new D(F,t);});return E;};this.getConfigHeader=function(){return a.getItem("configHeader");};this.createStep=function(i,R){var E=this.getConfigurationById(i);I.instances.messageHandler.check((E!==undefined&&(E.type==="step"||E.type==="hierarchicalStep")),"Error - referenced object is undefined or has not type step",sap.apf.core.constants.message.code.errorCheckConfiguration);I.instances.messageHandler.check(sap.apf.core.Step!==undefined,"Step must be defined ",sap.apf.core.constants.message.code.errorCheckConfiguration);I.instances.messageHandler.check(typeof sap.apf.core.Step==="function","Step must be constructor function");if(E.type==='hierarchicalStep'){I.instances.messageHandler.check(typeof sap.apf.core.HierarchicalStep==="function","HierarchicalStep must be constructor function");return new sap.apf.core.HierarchicalStep(I.instances.messageHandler,E,this,R,I.instances.coreApi);}return new sap.apf.core.Step(I.instances.messageHandler,E,this,R,I.instances.coreApi);};this.createBinding=function(i,E,F,R){var G=this.getConfigurationById(i);I.instances.messageHandler.check((G!==undefined&&G.type==="binding"),"Error - oBindingConfig is undefined or has not type binding",sap.apf.core.constants.message.code.errorCheckConfiguration);G.oTitle=E;G.oLongTitle=F;return new sap.apf.core.Binding(I,G,this,R);};this.createRequest=function(i){if(i.entitySet){i.entityType=i.entitySet;delete i.entitySet;}var M;var R;if(typeof i==="string"){R=t.getConfigurationById(i);if(!(R!==undefined&&R.type==="request")){M=I.instances.messageHandler.createMessageObject({code:"5004",aParameters:[i]});I.instances.messageHandler.putMessage(M);return undefined;}}else{R=i;I.instances.messageHandler.check(R.type&&R.type==="request"&&R.service&&R.entityType,'Wrong request configuration when creating a new request');if(!R.id){M=I.instances.messageHandler.createMessageObject({code:"5004",aParameters:[i]});I.instances.messageHandler.putMessage(M);return undefined;}}return new((I&&I.constructors&&I.constructors.Request)||sap.apf.core.Request)(I,R);};if(I.constructors&&I.constructors.RegistryProbe){this.getRegistry=function(){return new I.constructors.RegistryProbe(a);};}};}());
