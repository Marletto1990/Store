/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/core/utils/filterTerm","sap/apf/core/constants","sap/ui/model/Filter","sap/apf/utils/utils"],function(F,c,U,u){'use strict';var a="%20and%20";var b="%20or%20";var d=function(m,e,f,g,h){this.type="internalFilter";this.messageHandler=m;if(e&&(e instanceof F||e instanceof d)){this.leftExpr=e;}else if(e!==undefined&&f!==undefined&&g!==undefined){this.leftExpr=new F(m,e,f,g,h);}else if(e!==undefined||f!==undefined||g!==undefined){m.check(false,"wrong arguments in construction of sap.apf.core.utils.Filter");}this.restExpr=[];};d.prototype.getProperties=function(){var i;var p=[];var P=[];var e="";if(this.leftExpr===undefined){return p;}if(this.leftExpr instanceof F){e=this.leftExpr.getProperty();p.push(e);}else if(this.leftExpr instanceof d){p=this.leftExpr.getProperties();}for(i=0;i<this.restExpr.length;i++){if(this.restExpr[i]instanceof F){p.push(this.restExpr[i].getProperty());}else{P=this.restExpr[i].getProperties();p=p.concat(P);}}return u.eliminateDuplicatesInArray(this.messageHandler,p);};d.prototype.copy=function(){var f;var i;if(this.leftExpr===undefined){return new d(this.messageHandler);}f=new d(this.messageHandler,this.leftExpr);if(this.levelOperator===undefined){return f;}for(i=0;i<this.restExpr.length;i++){if(this.levelOperator===c.BooleFilterOperators.AND){f.addAnd(this.restExpr[i].copy());}else{f.addOr(this.restExpr[i].copy());}}return f;};d.prototype.isEmpty=function(){if(this.leftExpr===undefined){return true;}if(this.leftExpr instanceof F){return false;}if(!this.leftExpr.isEmpty()){return false;}if(this.restExpr.length===0){return true;}var i;for(i=0;i<this.restExpr.length;++i){if(!this.restExpr[i].isEmpty()){return false;}}return true;};d.prototype.isOr=function(){if(this.levelOperator===c.BooleFilterOperators.OR){return true;}else if(this.levelOperator===c.BooleFilterOperators.AND){return false;}if(this.leftExpr){if(this.leftExpr instanceof d){return this.leftExpr.isOr();}}return false;};d.prototype.isEqual=function(f){if(this===f){return true;}if(f===undefined){return false;}return this.getHash()===f.getHash();};d.prototype.getHash=function(l){var n=l||1;var e=0;if(this.restExpr.length===0){e=n;}else{e=n+1;}if(this.leftExpr===undefined){return 0;}var h=this.leftExpr.getHash(e);var i;if(this.levelOperator===undefined){return h;}if(this.levelOperator===c.BooleFilterOperators.AND){h=h+Math.pow(2,n);}else if(this.levelOperator===c.BooleFilterOperators.OR){h=h+Math.pow(3,n);}for(i=0;i<this.restExpr.length;i++){h=h+this.restExpr[i].getHash(e);}return h;};d.prototype.getFilterTermsForProperty=function(p){var t=[];var i;if(this.leftExpr===undefined){return t;}if(this.leftExpr instanceof d){t=this.leftExpr.getFilterTermsForProperty(p);}else if(p===this.leftExpr.getProperty()){t.push(this.leftExpr);}for(i=0;i<this.restExpr.length;i++){if(this.restExpr[i]instanceof F){if(p===this.restExpr[i].getProperty()){t.push(this.restExpr[i]);}}else{t=t.concat(this.restExpr[i].getFilterTermsForProperty(p));}}return t;};d.prototype.getFilterTerms=function(){var t=[];var i;if(this.leftExpr===undefined){return t;}if(this.leftExpr instanceof d){t=this.leftExpr.getFilterTerms();}else{t.push(this.leftExpr);}for(i=0;i<this.restExpr.length;i++){if(this.restExpr[i]instanceof F){t.push(this.restExpr[i]);}else{t=t.concat(this.restExpr[i].getFilterTerms());}}return t;};d.prototype.isConsistentWithFilter=function(p,v){var i;var e=false;if(this.leftExpr===undefined){return true;}if(this.levelOperator===undefined){return this.leftExpr.isConsistentWithFilter(p,v);}if(this.levelOperator===c.BooleFilterOperators.AND){if(!this.leftExpr.isConsistentWithFilter(p,v)){return false;}for(i=0;i<this.restExpr.length;i++){if(!this.restExpr[i].isConsistentWithFilter(p,v)){return false;}}return true;}if(this.levelOperator===c.BooleFilterOperators.OR){if(f(this.leftExpr,p)){e=true;if(this.leftExpr.isConsistentWithFilter(p,v)){return true;}}for(i=0;i<this.restExpr.length;i++){if(f(this.restExpr[i],p)){e=true;if(this.restExpr[i].isConsistentWithFilter(p,v)){return true;}}}return!e;}function f(g,p){if(g instanceof F){return g.getProperty()===p;}return g.getProperties().indexOf(p)>=0;}};d.prototype.removeTermsByProperty=function(p){var f=this.internalRemoveTermsByProperty(p);if(f===undefined){return new d(this.messageHandler);}return f;};d.prototype.internalRemoveTermsByProperty=function(p){var i,r,R;if(this.leftExpr===undefined){return this.copy();}r=this.leftExpr.internalRemoveTermsByProperty(p);if(r instanceof F){r=new d(this.messageHandler,r.getProperty(),r.getOp(),r.getValue(),r.getHighValue());}if(this.levelOperator===undefined){return r;}for(i=0;i<this.restExpr.length;i++){R=this.restExpr[i].internalRemoveTermsByProperty(p);if(r===undefined){if(R instanceof F){r=new d(this.messageHandler,R);}else{r=R;}}else if(R!==undefined){if(this.levelOperator===c.BooleFilterOperators.AND){r.addAnd(R);}else{r.addOr(R);}}}if(r){return new d(this.messageHandler,r);}};d.prototype.removeTerms=function(p,o,v){var i;if(this.leftExpr===undefined){return this.copy();}var f=this.leftExpr.removeTerms(p,o,v);var e;if(f instanceof F){f=new d(this.messageHandler,f.getProperty(),f.getOp(),f.getValue(),f.getHighValue());}if(this.levelOperator===undefined){return f;}for(i=0;i<this.restExpr.length;i++){e=this.restExpr[i].removeTerms(p,o,v);if(f===undefined){if(e instanceof F){f=new d(this.messageHandler,e);}else{f=e;}}else if(e!==undefined){if(this.levelOperator===c.BooleFilterOperators.AND){f.addAnd(e);}else{f.addOr(e);}}}return f;};d.prototype.addOr=function(e,f,g,h){var o;if(e instanceof d||e instanceof F){o=e;}else if(e!==undefined&&f!==undefined&&g!==undefined){o=new F(this.messageHandler,e,f,g,h);}else{this.messageHandler.check(false,"sap.apf.core.utils.Filter.addOr: wrong arguments in construction of  Filter");}if(this.leftExpr===undefined){this.leftExpr=o;return this;}if(this.levelOperator===undefined){this.levelOperator=c.BooleFilterOperators.OR;}this.restExpr.push(o);this.messageHandler.check(this.levelOperator===c.BooleFilterOperators.OR,"sap.apf.core.utils.Filter - addOr wrong operation");return this;};d.prototype.addAnd=function(e,f,g,h){var o;if(e instanceof d||e instanceof F){o=e;}else if(e!==undefined&&f!==undefined&&g!==undefined){o=new F(this.messageHandler,e,f,g,h);}else{this.messageHandler.check(false,"sap.apf.core.utils.Filter.addAnd: wrong arguments in construction of  Filter");}if(this.leftExpr===undefined){this.leftExpr=o;return this;}if(this.levelOperator===undefined){this.levelOperator=c.BooleFilterOperators.AND;}this.messageHandler.check(this.levelOperator===c.BooleFilterOperators.AND,"sap.apf.core.utils.Filter - addAnd wrong operation");this.restExpr.push(o);return this;};d.prototype.toUrlParam=function(e){var E="";if(this.leftExpr===undefined){return"";}E=this.leftExpr.toUrlParam(e);var i=0;var l=this.restExpr.length;var C="";if(l===0){return E;}if(this.levelOperator===c.BooleFilterOperators.AND){C=a;}else{C=b;}var r="";for(i=0;i<l;i++){r=this.restExpr[i].toUrlParam(e);if(E===""){E=r;}else if(r!==""){E=E+C+r;}}if(E===""){return"";}return'('+E+')';};d.prototype.mapToSapUI5FilterExpression=function(){var i,e,f=[];if(this.leftExpr===undefined){return new U({filters:[],and:undefined});}if(this.restExpr.length===0){return this.leftExpr.mapToSapUI5FilterExpression();}if(!(this.leftExpr.type==="internalFilter"&&this.leftExpr.isEmpty())){f.push(this.leftExpr.mapToSapUI5FilterExpression());}for(i=0;i<this.restExpr.length;i++){if(!(this.restExpr[i].type==="internalFilter"&&this.restExpr[i].isEmpty())){f.push(this.restExpr[i].mapToSapUI5FilterExpression());}}e={aFilters:f,bAnd:this.levelOperator===c.BooleFilterOperators.AND};var r=new U({filters:e.aFilters,and:e.bAnd});r.bAnd=e.bAnd;return r;};d.prototype.overwriteWith=function(f){var p=f.getProperties();var r;if(p.length!==0){r=this.removeTermsByProperty(p);if(r===undefined){return f.copy();}r.addAnd(f);return r;}return this.copy();};d.prototype.restrictToProperties=function(p){var f=s(this.getProperties(),p);return this.copy().removeTermsByProperty(f)||new d(this.messageHandler);function s(S,e){var i;var r=[];var h={};var l=S?S.length:0;var g=e?e.length:0;for(i=0;i<g;i++){h[e[i]]=undefined;}for(i=0;i<l;i++){if(!(S[i]in h)){r.push(S[i]);}}return r;}};d.prototype.isFilterTerm=function(){if(this.restExpr.length>0){return false;}if(!this.leftExpr){return false;}if(this.leftExpr instanceof F){return true;}return this.leftExpr.isFilterTerm();};d.prototype.getSingleValueTerms=function(){var s=[];var t=this;var p=this.getProperties();p.forEach(function(e){var f=t.getFilterTermsForProperty(e);if(f.length===1&&f[0].getOp()===c.FilterOperators.EQ){s.push({'property':f[0].getProperty(),'value':f[0].getValue()});}});return s;};d.prototype.traverse=function(v){if(!this.leftExpr){return v.processEmptyFilter();}if(this.leftExpr&&this.restExpr.length===0){if(this.leftExpr instanceof F){return v.processTerm(this.leftExpr);}return this.leftExpr.traverse(v);}if(this.levelOperator===c.BooleFilterOperators.AND){return v.processAnd(this.leftExpr,this.restExpr,this);}if(this.levelOperator===c.BooleFilterOperators.OR){return v.processOr(this.leftExpr,this.restExpr,this);}this.messageHandler.check(false,'undefined case in traverse()');return false;};d.prototype.isDisjunctionOverEqualities=function(){var i=true;if(this.levelOperator===c.BooleFilterOperators.AND){return false;}if(this.getProperties().length>1){return false;}if(this.leftExpr instanceof d){if(this.leftExpr.getFilterTerms().length>1&&!this.leftExpr.isOr()){return false;}}this.getFilterTerms().forEach(function(f){if(f.getOp()!==c.FilterOperators.EQ){i=false;}});this.restExpr.forEach(function(r){if(r instanceof d){if(r.getFilterTerms().length>1){i=false;}}});return i;};d.prototype.mapToSelectOptions=function(g){var e=jQuery.Deferred();var p;var t=this;g(f);function f(h){p=h;var v=new V();v.process(t);e.resolve(v.getSelectionVariant());}function V(){var s={};s.SelectOptions=[];s.Parameters=[];function h(k){var l;s.SelectOptions.forEach(function(m){if(m.PropertyName===k){l=m;}});if(!l){l={PropertyName:k,Ranges:[]};s.SelectOptions.push(l);}return l.Ranges;}function i(k){var o,v;var r=h(k.getProperty());if(k.getHighValue()!==undefined&&k.getHighValue()!==null){r.push({Sign:'I',Option:k.getOp(),Low:k.getValue(),High:k.getHighValue()});}else{o=k.getOp();v=k.getValue();if(o==='StartsWith'){o='CP';v=v+'*';}else if(o==='EndsWith'){o='CP';v='*'+v;}else if(o==='Contains'){o='CP';v='*'+v+'*';}r.push({Sign:'I',Option:o,Low:v});}}function j(k){s.Parameters.push({PropertyName:k.getProperty(),PropertyValue:k.getValue()});}this.getSelectionVariant=function(){if(s.SelectOptions.length>0||s.Parameters.length>0){return s;}return{};};this.processEmptyFilter=function(){return;};this.processTerm=function(k){if(jQuery.inArray(k.getProperty(),p)===-1){i(k);}else{j(k);}};this.processAnd=function(k,l){this.process(k);l.forEach(function(m){this.process(m);}.bind(this));};this.processOr=function(k,l){this.process(k);l.forEach(function(m){this.process(m);}.bind(this));};this.process=function(k){k.traverse(this);};}return e.promise();};d.createFromArray=function(m,p,D,I){var l=p.length;var i;var n;var j;var f;var o;var e;m.check(p instanceof Array&&p.length>0,"sap.apf.core.utils.Filter.createFromArray incorrect argument aProperties");m.check(D instanceof Array,"sap.apf.core.utils.Filter.createFromArray incorrect argument aData");if(I.length>0){for(i=0;i<I.length;++i){o=undefined;n=I[i];if(!D[n]){continue;}for(j=0;j<l;j++){e=new d(m,p[j],c.FilterOperators.EQ,D[n][p[j]]);if(o===undefined){o=new d(m,e);}else{o.addAnd(e);}}if(f===undefined){f=new d(m,o);}else{f.addOr(o);}}return f;}return new d(m);};d.createEmptyFilter=function(m,p){m.check(jQuery.isArray(p)&&p.length>0,"sap.apf.core.utils.Filter.createEmptyFilter - array with property names expected");return new d(m,p[0],c.FilterOperators.EQ,'').addAnd(p[0],c.FilterOperators.NE,'');};d.transformUI5FilterToInternal=function(m,o){return t(o,o.bAnd);function t(o,A){var r=new d(m);var s;if(o.aFilters){o.aFilters.forEach(function(f){if(f.aFilters){s=t(f,f.bAnd);if(A){r.addAnd(s);}else{r.addOr(s);}}else if(f.sPath){if(A){r.addAnd(f.sPath,f.sOperator,f.oValue1,f.oValue2);}else{r.addOr(f.sPath,f.sOperator,f.oValue1,f.oValue2);}}});}else{r=new d(m,o.sPath,o.sOperator,o.oValue1,o.oValue2);}return r;}};sap.apf.core.utils.Filter=d;return d;},true);
