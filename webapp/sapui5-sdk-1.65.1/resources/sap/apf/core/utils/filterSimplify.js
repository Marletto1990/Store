/*
 * Copyright(c) 2015 SAP SE
 */
sap.ui.define(["sap/apf/core/utils/filter","sap/apf/core/utils/filterTerm","sap/apf/core/constants","sap/apf/core/messageHandler"],function(F,a,c,M){'use strict';var f={};f.FilterReduction=function(){var t=this;var b=false;this.transformFilter=function(e){var T=[];var p;var g;if(e){e.forEach(function(h){if(h instanceof a){T.push({property:h.getProperty(),values:[h.getValue()]});}else if(h instanceof F){p=h.getProperties();g=new f.CollectPropertiesAndValuesVisitor();g.process(h);T.push({property:p[0],values:g.getValues()});}});}return T;};this.intersection=function(e,g){var r={};var l=e.values;var h=g.values;var k=[];var m={};var i,n=l.length;var j,o=h.length;for(i=0;i<n;i++){m[l[i]]=l[i];}for(j=0;j<o;j++){if(m[h[j]]!==undefined&&k.indexOf(h[j])<0){k.push(h[j]);}}r.property=e.property;r.values=k;return r;};function d(m){this.reducers=[];this.disjunctions=[];this.processTerm=function(e){var w=new F(m,e);if(e.getOp()===c.FilterOperators.EQ){this.disjunctions.push(w);}else{this.reducers.push(w);}};this.processOr=function(l,e,o){var i=new f.CollectPropertiesAndValuesVisitor();i.process(o);if(i.isWellFormed()){this.disjunctions.push(o);}else{this.reducers.push(o);}};this.processAnd=function(l,e,g){var s=t.filterSeparation(g,m);this.disjunctions=this.disjunctions.concat(s.disjunctions);this.reducers=this.reducers.concat(s.reducers);};this.processEmptyFilter=function(){};this.process=function(e){e.traverse(this);};}this.filterSeparation=function(e,m){var g=new f.CollectChildrenOfAndNodeVisitor();var h=g.process(e);var v;if(!h){return{reducers:[],disjunctions:[]};}v=new d(m);h.forEach(function(i){i.traverse(v);});return{reducers:v.reducers,disjunctions:v.disjunctions};};this.simplifyTransforms=function(T){var s=[];var r;var p=[];var l=T.length;var n;T.forEach(function(e,i){var j;n=e.property;if(p.indexOf(n)===-1){p.push(n);r=e;for(j=i+1;j<l;++j){if(n===T[j].property){r=t.intersection(r,T[j]);}}s.push(r);}});return s;};this.applyStartFilter=function(s,T){var r=[];var p=s.getProperties();T.forEach(function(e){var R=[];var j;var l=e.values.length;var v;if(p.indexOf(e.property)>-1){for(j=0;j<l;j++){v=e.values[j];if(s.isConsistentWithFilter(e.property,v)){R.push(v);}}r.push({property:e.property,values:R});}else{r.push(e);}});return r;};this.simplifyInStartFilter=function(s,T){var r=s;T.forEach(function(e){if(r){r=r.removeTermsByProperty(e.property);}});if(r.isEmpty()){return undefined;}return r;};this.containsContradiction=function(m,T){var b=false;T.forEach(function(e){if(e.values.length===0){b=true;}});if(b){return b;}return b;};this.rebuildDisjunction=function(m,e){var r=new F(m);var p=e.property;var v=e.values;v.forEach(function(g){var h=new a(m,p,c.FilterOperators.EQ,g);r.addOr(h);});return r;};this.reduceFilter=function(m,e){var g=this;function h(R){var i=[];R.forEach(function(n){i.push(t.rebuildDisjunction(m,n));});return i;}function j(i,n){n.forEach(function(o){i.addAnd(o);});}function k(n,o){var i;var R=o;var p=[];var q;for(i=0;i<n.length;++i){R=g.applyStartFilter(n[i],o);if(g.containsContradiction(m,R)){return{contradiction:e};}q=g.simplifyInStartFilter(n[i],o);if(q){p.push(q);}}return{reducedTransforms:R,simplifiedReducers:p};}var s;var D;var T;var S;var r;var l;if(e.isFilterTerm()||e.isOr()||e.isEmpty()){return e;}s=this.filterSeparation(e,m);D=s.disjunctions;T=this.transformFilter(D);S=this.simplifyTransforms(T);if(this.containsContradiction(m,S)){b=true;return e;}l=k(s.reducers,S);if(l.contradiction){b=true;return l.contradiction;}r=new F(m);j(r,l.simplifiedReducers);j(r,h(l.reducedTransforms));return r;};this.isContradicted=function(){return b;};};f.CollectPropertiesAndValuesVisitor=function(){var t=this;var p=[];var v=[];var b=true;var d=true;var n=0;var e=0;var g=0;var h=0;function j(k){var i,l=p.length;for(i=0;i<l;i++){if(p[i]===k){return;}}p.push(k);}this.getProperties=function(){return p.slice(0);};this.getValues=function(){return v.slice(0);};this.isWellFormed=function(){return b&&d&&p.length<=1;};this.isEmptyFilter=function(){return n===0&&e===0&&g>0&&h===0;};this.processEmptyFilter=function(){g++;};this.processAnd=function(i,k){n++;d=false;this.process(i);this.processAndArray(k);};this.processAndArray=function(i){i.forEach(function(k){t.process(k);});};this.processOr=function(i,k){e++;this.process(i);this.processOrArray(k);};this.processOrArray=function(i){i.forEach(function(k){t.process(k);});};this.processTerm=function(i){h++;var k=i.getProperty();j(k);switch(i.getOp()){case c.FilterOperators.EQ:v.push(i.getValue());return;default:b=false;return;}};this.process=function(i){if(i instanceof a){this.processTerm(i);}else{i.traverse(this);}};};f.CollectChildrenOfAndNodeVisitor=function(){this.processEmptyFilter=function(){return null;};this.processTerm=function(t){return[t];};this.processAnd=function(b,d){var r=[];r.push(b);d.forEach(function(e){r.push(e);});return r;};this.processOr=function(){return null;};this.process=function(b){if(b instanceof a){this.processTerm(b);}else{return b.traverse(this);}};};sap.apf.core.utils.FilterReduction=f.FilterReduction;return f;},true);
