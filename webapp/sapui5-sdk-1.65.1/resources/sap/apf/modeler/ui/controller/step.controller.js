jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");sap.ui.define(["sap/apf/modeler/ui/utils/sortDataHandler","sap/apf/modeler/ui/utils/nullObjectChecker","sap/apf/modeler/ui/utils/optionsValueModelBuilder","sap/apf/modeler/ui/utils/viewValidator","sap/apf/modeler/ui/utils/stepPropertyMetadataHandler"],function(S,n,o,V,a){"use strict";var p,t,c,C,T,g,s,v,b,d,I,e;var f=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_TITLE;var h=sap.apf.modeler.ui.utils.TranslationFormatMap.STEP_LONG_TITLE;function _(i){i.byId("idStepBasicData").setText(t("stepBasicData"));i.byId("idStepTitleLabel").setText(t("stepTitle"));i.byId("idStepTitle").setPlaceholder(t("newStep"));i.byId("idStepLongTitleLabel").setText(t("stepLongTitle"));i.byId("idStepLongTitle").setPlaceholder(t("stepLongTitle"));i.byId("idCategoryTitleLabel").setText(t("categoryAssignments"));i.byId("idGlobalLabel").setText(t("globalNavigationTarget"));i.byId("idStepSpecificLabel").setText(t("stepSpecificNavTargets"));i.byId("idDataRequest").setText(t("dataRequest"));i.byId("idFilterMapping").setText(t("filterMap"));i.byId("idFilterMapKeepSourceLabel").setText(t("filterMapKeepSource"));i.byId("idNavigationTarget").setText(t("navigationTargetAssignments"));i.byId("idDataReduction").setText(t("dataReduction"));i.byId("idDataReductionLabel").setText(t("dataReductionType"));i.byId("idNoDataReduction").setText(t("noDataReduction"));i.byId("idTopN").setText(t("topN"));i.byId("idNumberOfRecordsLabel").setText(t("recordNumber"));i.byId("idAriaPropertyForDataReduction").setText(t("dataReductionType"));}function k(i,j){var N=t(I?"hierarchicalStepTitle":"step")+": "+j;i.getView().getViewData().updateTitleAndBreadCrumb(N);l(i,j);}function l(i,j){var N=t(I?"hierarchicalStepTitle":"step")+": "+j;i.getView().getViewData().oTitleBreadCrumbController.byId("IdFormTitle").setText(N);}function m(i,j){var N={id:s.getId(),icon:s.getType()==="hierarchicalStep"?"sap-icon://drill-down":"sap-icon://step"};if(j){N.name=j;}i.getView().getViewData().updateSelectedNode(N);}function q(i){var j,N;if(p&&p.arguments&&p.arguments.stepId){s=C.getStep(p.arguments.stepId);I=(s&&s.getType()==="hierarchicalStep")?true:false;}if(!n.checkIsNotUndefined(s)){N=p.arguments.categoryId;I=p.bIsHierarchicalStep;if(I){j=C.createHierarchicalStep(N);}else{j=C.createStep(N);}s=C.getStep(j);m(i);}}function r(i){var j=this;var N=i.getParameter("bShowFilterMappingLayout");j.byId("idStepFilterMappingVBox").setVisible(N);j.byId("idFilterMapKeepSourceLabel").setVisible(N);j.byId("idFilterKeepSourceCheckBox").setVisible(N);if(!N){j.byId("idFilterMapping").setText("");j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.RESETFILTERMAPPINGFIELDS);}else{j.byId("idFilterMapping").setText(t("filterMap"));}}function u(i){i.byId("idDataReductionForm").setVisible(!I);}function w(i,j,N,O,U){sap.ui.view({viewName:O,type:sap.ui.core.mvc.ViewType.XML,id:i.createId(U),viewData:N,controller:j});}function x(i){var j,N,O,P,Q,R,U;j={oTextReader:t,oConfigurationEditor:C,oTextPool:T,oParentObject:s,oStepPropertyMetadataHandler:e,oCoreApi:i.getView().getViewData().oCoreApi};N=new sap.ui.controller("sap.apf.modeler.ui.controller.stepCornerTexts");w(i,N,j,"sap.apf.modeler.ui.view.cornerTexts","idStepCornerTextView");Q=i.byId("idStepCornerTextView");i.byId("idStepCornerTextVBox").insertItem(Q);j.oConfigurationHandler=c;j.getCalatogServiceUri=i.getView().getViewData().getCalatogServiceUri;if(I){O=new sap.ui.controller("sap.apf.modeler.ui.controller.hierarchicalStepRequest");}else{O=new sap.ui.controller("sap.apf.modeler.ui.controller.stepRequest");}w(i,O,j,"sap.apf.modeler.ui.view.requestOptions","idStepRequestView");R=i.byId("idStepRequestView");i.byId("idStepRequestVBox").insertItem(R);P=new sap.ui.controller("sap.apf.modeler.ui.controller.stepFilterMapping");w(i,P,j,"sap.apf.modeler.ui.view.requestOptions","idStepFilterMappingView");U=i.byId("idStepFilterMappingView");i.byId("idStepFilterMappingVBox").insertItem(U);R.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETDATAREDUCTIONSECTION,i.setDataReductionSection.bind(i));R.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,r.bind(i));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,r.bind(i));R.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.UPDATEFILTERMAPPINGFIELDS,U.getController().updateFilterMappingFields.bind(U.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.RESETFILTERMAPPINGFIELDS,U.getController().resetFilterMappingFields.bind(U.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,Q.getController().updateSubViewInstancesOnReset.bind(Q.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,R.getController().updateSubViewInstancesOnReset.bind(R.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,U.getController().updateSubViewInstancesOnReset.bind(U.getController()));R.addStyleClass("formTopPadding");R.addStyleClass("formBottomPadding");U.addStyleClass("formTopPadding");U.addStyleClass("formBottomPadding");}function y(i){if(!n.checkIsNotNullOrUndefinedOrBlank(C.getStep(p.arguments.stepId))){return;}i.byId("idStepTitle").setValue(s.getId());if(n.checkIsNotNullOrUndefinedOrBlank(s.getTitleId())&&T.get(s.getTitleId())){i.byId("idStepTitle").setValue(T.get(s.getTitleId()).TextElementDescription);}}function z(i){if(!n.checkIsNotNullOrUndefinedOrBlank(C.getStep(p.arguments.stepId))){return;}i.byId("idStepLongTitle").setValue("");if(n.checkIsNotNullOrUndefinedOrBlank(s.getLongTitleId())&&T.get(s.getLongTitleId())){i.byId("idStepLongTitle").setValue(T.get(s.getLongTitleId()).TextElementDescription);}}function A(i){var j=[];var N=C.getCategories();N.forEach(function(Q){var R={};R.CategoryId=Q.getId();R.CategoryTitle=T.get(Q.labelKey)?T.get(Q.labelKey).TextElementDescription:Q.labelKey;j.push(R);});var O=o.prepareModel(j,j.length);i.byId("idCategorySelect").setModel(O);var P=C.getCategoriesForStep(s.getId());if(n.checkIsNotNullOrUndefinedOrBlank(P)){i.byId("idCategorySelect").setSelectedKeys(P);}}function B(i){i.byId("idNumberOfRecordsValue").setValue("");i.byId("idNumberOfRecordsValue").setValueState("None");if(s.getTopN()){i.byId("idNumberOfRecordsValue").setValue(s.getTopN().top);}E(i);}function D(i){i.byId("idDataReductionRadioGroup").setSelectedButton(i.byId("idNoDataReduction"));G(i);if(s.getTopN()){i.byId("idDataReductionRadioGroup").setSelectedButton(i.byId("idTopN"));}}function E(i){var j=i.byId("idDataReductionRadioGroup").getSelectedButton()===i.byId("idTopN")?true:false;i.byId("idNumberOfRecordsLabel").setVisible(j);i.byId("idNumberOfRecordsValue").setVisible(j);if(j){v.addField("idNumberOfRecordsValue");}else{v.removeField("idNumberOfRecordsValue");}}function F(i){if(s.getTopN()){b.instantiateStepSortData();if(s.getTopN().orderby.length===0){i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETTOPNPROPERTIES);var j=d.createMessageObject({code:"11523"});d.putMessage(j);}}else{b.destroySortData();}}function G(i){var j=(s.getSelectProperties().length!==0)?true:false;i.byId("idDataReductionRadioGroup").setEnabled(j);}function H(i){var j=(s.getFilterProperties().length!==0)?true:false;i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,{"bShowFilterMappingLayout":j});}function J(i){if(n.checkIsNotNullOrUndefinedOrBlank(s.getFilterMappingKeepSource())){i.byId("idFilterKeepSourceCheckBox").setSelected(s.getFilterMappingKeepSource());}}function K(i,N,j,O){var P=[];if(N.length!==0){j.setBusy(true);}N.forEach(function(Q){var R={};R.navTargetKey=Q.getId();g(Q.getId()).then(function(U){R.navTargetName=U;P.push(R);if(P.length===N.length){var W=o.prepareModel(P,P.length);j.setModel(W);j.setSelectedKeys(O);j.setBusy(false);}});});}function L(i){var j=C.getNavigationTargets();var N=s.getNavigationTargets();var O=j.filter(function(P){return P.isStepSpecific();});K(i,O,i.byId("idStepSpecificCombo"),N);}function M(i){var j=C.getNavigationTargets();var N=j.filter(function(P){return P.isGlobal();});var O=N.map(function(P){return P.getId();});K(i,N,i.byId("idGlobalCombo"),O);}sap.ui.controller("sap.apf.modeler.ui.controller.step",{onInit:function(){var i=this,j;var N=i.getView().getViewData();d=N.oCoreApi;t=d.getText;p=N.oParams;c=N.oConfigurationHandler;T=c.getTextPool();C=N.oConfigurationEditor;g=N.getNavigationTargetName;v=new V(i.getView());_(i);q(i);e=new sap.apf.modeler.ui.utils.StepPropertyMetadataHandler(d,s);b=new S(i.getView(),s,e,t);x(i);i.setDetailData();j=i.byId("idStepTitle").getValue().trim();if(j===""){j="< "+t("newStep")+" >";}l(i,j);v.addFields(["idStepTitle","idCategorySelect"]);},setDetailData:function(){var i=this;y(i);z(i);A(i);i.setDataReductionSection();u(i);H(i);J(i);L(i);M(i);},onAfterRendering:function(){var i=this;if(i.byId("idStepTitle").getValue().length===0){i.byId("idStepTitle").focus();}},updateSubViewInstancesOnReset:function(i){var j=this;C=i;s=C.getStep(s.getId());j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,{"oConfigurationEditor":C,"oParentObject":s});},setDataReductionSection:function(){var i=this;D(i);B(i);F(i);},handleChangeForStepTitle:function(){var i=this;var j=C.getCategoriesForStep(s.getId());var N=i.byId("idStepTitle").getValue().trim();if(n.checkIsNotNullOrUndefinedOrBlank(N)){T.setTextAsPromise(N,f).done(function(O){s.setTitleId(O);if(j.length>1){i.getView().getViewData().updateTree();}else{m(i,N);}k(i,N);C.setIsUnsaved();});}else{C.setIsUnsaved();}},handleSuggestionsForStepTitle:function(i){var j=new sap.apf.modeler.ui.utils.SuggestionTextHandler(T);j.manageSuggestionTexts(i,f);},handleChangeForStepLongTitle:function(){var i=this;var j=i.byId("idStepLongTitle").getValue().trim();if(n.checkIsNotNullOrUndefined(j)){T.setTextAsPromise(j,h).done(function(N){s.setLongTitleId(N);C.setIsUnsaved();});}else{C.setIsUnsaved();}},handleSuggestionsForStepLongTitle:function(i){var j=new sap.apf.modeler.ui.utils.SuggestionTextHandler(T);j.manageSuggestionTexts(i,h);},handleChangeForCategory:function(){var N=this;var O=s.getId();var P=p.arguments.categoryId;var Q=C.getCategoriesForStep(s.getId());var R=N.byId("idCategorySelect").getSelectedKeys();var U=R.indexOf(P);var W=[];var X=[];var i,j;for(i=0;i<Q.length;i++){var Y=false;for(j=0;j<R.length;j++){if(Q[i]===R[j]){Y=true;break;}}if(!Y){X.push(Q[i]);}}if(R.length!==0){R.forEach(function(Z){C.addCategoryStepAssignment(Z,O);var $={oldContext:{name:p.name,arguments:{configId:p.arguments.configId,categoryId:P,stepId:O}},newContext:{arguments:{configId:p.arguments.configId,categoryId:Z}}};if(Z!==P){W.push($);}});Q.forEach(function(Z){if(R.indexOf(Z)===-1){C.removeCategoryStepAssignment(Z,s.getId());}});if(X.length!==0){X.forEach(function(Z){var $={oldContext:{name:p.name,arguments:{configId:p.arguments.configId,categoryId:P,stepId:O}},newContext:{arguments:{configId:p.arguments.configId,categoryId:Z}},removeStep:true};if(U===-1&&Z===P){var a1={arguments:{appId:p.arguments.appId,configId:p.arguments.configId,categoryId:R[0],stepId:O}};$.categoryChangeContext=a1;$.changeCategory=true;}W.push($);});}}if(W.length!==0){N.getView().getViewData().updateTree(W);}C.setIsUnsaved();},handleChangeForDataReductionType:function(){var i=this;if(i.byId("idDataReductionRadioGroup").getSelectedButton()===i.byId("idNoDataReduction")){s.resetTopN();i.setDataReductionSection();}else{b.instantiateStepSortData();}E(i);C.setIsUnsaved();},handleValidationForNumberOfRecords:function(i){var j=i.getSource();var N=j.getValue().trim();var O=(N.indexOf("E")!==-1||N.indexOf("e")!==-1||N.indexOf(".")!==-1||N<=0||N>10000)?sap.ui.core.ValueState.Error:sap.ui.core.ValueState.None;j.setValueState(O);C.setIsUnsaved();},handleChangeForNoOfRecords:function(i){var j=this;var N=i.getSource().getValue().trim();if(i.getSource().getValueState()===sap.ui.core.ValueState.Error){return;}if(n.checkIsNotNullOrUndefinedOrBlank(N)){if(s.getTopN()===undefined){j.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETTOPNPROPERTIES);}s.setTopNValue(N);}C.setIsUnsaved();},handleFilterMapKeepSource:function(){var i=this;var j=i.byId("idFilterKeepSourceCheckBox").getSelected();s.setFilterMappingKeepSource(j);C.setIsUnsaved();},handleChangeForStepSpecificNavTargets:function(){var i=this;var j=i.byId("idStepSpecificCombo").getSelectedKeys();var N=s.getNavigationTargets();N.forEach(function(O){if(j.indexOf(O)===-1){s.removeNavigationTarget(O);}});j.forEach(function(O){if(N.indexOf(O)===-1){s.addNavigationTarget(O);}});C.setIsUnsaved();},getValidationState:function(){var i=this;return v.getValidationState()&&i.byId("idStepRequestView").getController().getValidationState()&&i.byId("idStepFilterMappingView").getController().getValidationState();},onExit:function(){var i=this;i.byId("idStepCornerTextView").destroy();i.byId("idStepRequestView").destroy();i.byId("idStepFilterMappingView").destroy();}});});
