/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/modeler/ui/controller/overwriteExistingConfiguration","sap/apf/modeler/ui/utils/nullObjectChecker"],function(B,n){"use strict";var c,p,a,o,b;function _(C){var t=c.getText;C.byId("idImportFilesDialog").setTitle(t("importConfig"));C.byId("idJsonFileLabel").setText(t("jsonFile"));C.byId("idJsonFileUploader").setPlaceholder(t("jsonFileInputPlaceHolder"));C.byId("idTextFileLabel").setText(t("textFile"));C.byId("idTextFileUploader").setPlaceholder(t("textFileInputPlaceHolder"));C.byId("idUploadOfConfig").setText(t("upload"));C.byId("idCancelImportOfConfig").setText(t("cancel"));}function d(C,h,i,j){var k=new sap.ui.core.CustomData({value:{callbackOverwrite:h,callbackCreateNew:i}});o=sap.ui.xmlfragment("idOverwriteConfirmationFragment","sap.apf.modeler.ui.fragment.overwriteConfirmation",C);C.getView().addDependent(o);C.setOverwriteConfirmationDialogText(c.getText);o.removeAllCustomData();o.addCustomData(k);sap.ui.core.Fragment.byId("idOverwriteConfirmationFragment","idNewConfigTitleInput").setValue(j);o.open();}function e(m){var M=c.createMessageObject({code:m});c.putMessage(M);}function f(h,m,i){var C=this;var t=C.byId("idTextFileUploader");if(!n.checkIsNotUndefined(i)){p.fireEvent("updateAppListEvent");e("11515");if(t&&t.getValue()){t.upload();}else{C.closeAllOpenDialogs();}}else{var M=c.createMessageObject({code:"11502"});M.setPrevious(i);c.putMessage(M);C.closeAllOpenDialogs();}}function g(C,P){c.importTexts(P,function(m){if(!n.checkIsNotUndefined(m)){e("11516");}else{var M=c.createMessageObject({code:"11503"});M.setPrevious(m);c.putMessage(M);}});C.closeAllOpenDialogs();}return B.extend("sap.apf.modeler.ui.controller.importFiles",{onInit:function(){var C=this;c=C.getView().getViewData().oCoreApi;p=C.getView().getViewData().oParentControl;c.getApplicationHandler(function(h,m){if(h&&!n.checkIsNotUndefined(m)){a=h;}else{var M=c.createMessageObject({code:"11508"});M.setPrevious(m);c.putMessage(M);}});_(C);C.byId("idImportFilesDialog").open();},addAcceptAttribute:function(){var C=this;var j=jQuery("#"+C.getView().getId()+"--idJsonFileUploader-fu");var h=jQuery("#"+C.getView().getId()+"--idTextFileUploader-fu");j.attr('accept','.json');h.attr('accept','.properties');},handleTypeMissmatchForJSONFile:function(){e("11517");},handleTypeMissmatchForPropertiesFile:function(){e("11518");},handleJSONFileUploadComplete:function(E){var C=this;var h=E.getSource().oFileUpload.files[0];if(h){var r=new FileReader();r.readAsText(h,"UTF-8");r.onload=function(i){b=JSON.parse(i.target.result).configHeader.Application;c.importConfiguration(JSON.stringify(JSON.parse(i.target.result)),function(j,k,l){d(C,j,k,l);},f.bind(C));};r.onerror=function(){e("11519");};}},handleTextFileUploadComplete:function(E){var C=this,h,j;h=E.getSource().oFileUpload.files[0];j=C.byId("idJsonFileUploader");if(h){var r=new FileReader();r.readAsText(h,"UTF-8");r.onload=function(k){var l=k.target.result.split(/\r?\n/);var m,i,q;for(i=0;i<l.length;i++){m=/^\#\s*ApfApplicationId=[0-9A-F]+\s*$/.exec(l[i]);if(n.checkIsNotNull(m)){q=l[i].split('=')[1];}}var s;if(a){for(i=0;i<a.getList().length;i++){if(q===a.getList()[i].Application){s=true;break;}else{s=false;}}}if(!s&&j&&!j.getValue()){e("11520");}else if(j&&j.getValue()){if(b&&q&&q!==b){e("11521");}else{g(C,k.target.result);}}else if(s&&j&&!j.getValue()){g(C,k.target.result);}};r.onerror=function(){e("11522");};}C.closeAllOpenDialogs();},handleUploadOfConfig:function(){var C=this;var j=n.checkIsNotNullOrUndefinedOrBlank(C.byId("idJsonFileUploader").getValue());var t=n.checkIsNotNullOrUndefinedOrBlank(C.byId("idTextFileUploader").getValue());if((j&&t)||j){C.byId("idJsonFileUploader").upload();}else{C.byId("idTextFileUploader").upload();}},handleCancelOfImportFilesDialog:function(){var C=this;C.getView().destroy();},closeAllOpenDialogs:function(){var i=this.byId("idImportFilesDialog");if(o&&o.isOpen()){this.handleCancelOfOverwriteDialog();}if(i&&i.isOpen()){this.handleCancelOfImportFilesDialog();}}});});
