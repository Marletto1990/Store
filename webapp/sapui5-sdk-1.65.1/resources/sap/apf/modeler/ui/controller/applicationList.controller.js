/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(['sap/ui/core/mvc/Controller','sap/m/Table','sap/m/Column','sap/m/ColumnListItem','sap/m/Text','sap/m/Input','sap/ui/core/Icon','sap/apf/modeler/ui/utils/helper','sap/apf/modeler/ui/utils/nullObjectChecker','sap/apf/modeler/ui/utils/optionsValueModelBuilder','sap/ui/model/Filter'],function(B,T,C,a,b,I,c,h,n,o,F){"use strict";function _(i){var j=i.coreApi.getText;i.byId("idAppPage").setTitle(j("configModelerTitle"));i.byId("idAppTitle").setText(j("applicationOverview"));i.byId("idAppNumberTitle").setText(j("applications"));i.byId("idDescriptionLabel").setText(j("description"));if(i.coreApi.showSemanticObject()){i.byId("idSemanticObjectLabel").setText(j("semanticObject"));}i.byId("idImportButton").setText(j("import"));i.byId("idImportButton").setTooltip(j("importConfig"));i.byId("idNewButton").setText(j("new"));i.byId("idNewButton").setTooltip(j("newApplication"));i.byId("idEditIcon").setTooltip(j("editApplication"));i.byId("idDeleteIcon").setTooltip(j("deleteApplication"));i.byId("idTextpoolCleanupIcon").setTooltip(j("textCleanUp"));i.byId("idAriaPropertyForDelete").setText(j("ariaTextForDeleteIcon"));i.byId("idAriaPropertyForEdit").setText(j("ariaTextForEditIcon"));i.byId("idAriaPropertyForTextpoolCleanup").setText(j("ariaTextForTextpoolCleanupIcon"));}function d(i){var j=i.coreApi.getText;sap.ui.core.Fragment.byId("idDeleteConfirmationFragment","idDeleteConfirmation").setTitle(j("confirmation"));sap.ui.core.Fragment.byId("idDeleteConfirmationFragment","idDeleteButton").setText(j("deleteButton"));sap.ui.core.Fragment.byId("idDeleteConfirmationFragment","idCancelButtonDialog").setText(j("cancel"));}function e(i){var j=i.applicationHandler.getList();i.byId("idAppCount").setText("("+j.length+")");var A=[];j.forEach(function(q){var r={};r.id=q.Application;r.description=q.ApplicationName;r.semanticObject=q.SemanticObject;A.push(r);});var M=o.prepareModel(A,A.length);i.byId("idApplicationTable").setModel(M);if(i.actualQuery!==""){i.filterValues(i.actualQuery);}}function f(i,M){var j=i.coreApi.createMessageObject({code:M});i.coreApi.putMessage(j);}function g(i){i.byId("idApplicationTable").attachEvent("addNewAppEvent",i.handleAdditionOfNewApp.bind(i));i.byId("idApplicationTable").attachEvent("updateAppListEvent",i.handleAppListUpdate.bind(i));}function k(i,v){var V,j;V={oParentControl:i.byId("idApplicationTable"),oCoreApi:i.coreApi};j=new sap.ui.view({viewName:"sap.apf.modeler.ui.view."+v,type:sap.ui.core.mvc.ViewType.XML,viewData:V});i.getView().addDependent(j);}function l(i,D,j,q){i.getView().addDependent(D);var M=new b({text:i.coreApi.getText(j)});D.removeAllContent();D.addContent(M);if(q){D.removeAllCustomData();D.addCustomData(q);}D.open();}function m(i){var s=i.byId("idAppListScrollContainer");var A=i.byId("idApplicationTable");var v=i.getView();A.addEventDelegate({onAfterRendering:function(){var j=jQuery(window).height();var q=jQuery(v.byId("idAppTitle").getDomRef()).height();var r=jQuery(v.byId("idApplicationToolbar").getDomRef()).height();var t=jQuery(v.byId("idAppPage").getDomRef()).find("header").height();var u=jQuery(v.byId("idAppPage").getDomRef()).find("footer").height();var w;if(q>0){q=q+80;w=q+r+t+u+25;}else{w=232;}s.setHeight(j-w+"px");s.setWidth("100%");h.onResize(function(){if(jQuery(v.getDomRef()).css("display")==="block"){j=jQuery(v.byId("idAppPage").getDomRef()).height();s.setHeight(j-w+"px");s.setWidth("100%");}});sap.ui.core.UIComponent.getRouterFor(i).attachRoutePatternMatched(function(E){if(E.getParameter("name")==="applicationList"){j=jQuery(v.getDomRef()).height();s.setHeight(j-w+"px");s.setWidth("100%");}});}});}function p(i,E){var j=new sap.m.StandardListItem({title:i.coreApi.getText("importDeliveredContent"),type:sap.m.ListType.Active,press:function(){k(i,"importDeliveredContent");}});var q=new sap.m.StandardListItem({title:i.coreApi.getText("importFiles"),type:sap.m.ListType.Active,press:function(){k(i,"importFiles");}});var P=new sap.m.Popover({placement:sap.m.PlacementType.Top,showHeader:false});var A=new sap.m.List({items:[j,q]});P.addContent(A);P.openBy(E.getSource());}return B.extend("sap.apf.modeler.ui.controller.applicationList",{onInit:function(){var i=this;this.actualQuery="";var j=i.getOwnerComponent();if(n.checkIsNotUndefined(j)){i.coreApi=j.oCoreApi;if(!this.coreApi.showSemanticObject()){this.hideSemanticObjectColumn();}g(this);_(i);i.coreApi.getApplicationHandler(function(q,r){i.applicationHandler=q;if(i.applicationHandler&&!n.checkIsNotUndefined(r)){e(i);}else{i.showMessage("11508",r);}});}m(i);},showMessage:function(i,j){var M=this.coreApi.createMessageObject({code:i});if(j){M.setPrevious(j);}this.coreApi.putMessage(M);},hideSemanticObjectColumn:function(){this.byId("idSemanticObjectColumn").setVisible(false);},handleAddNewAppPress:function(){var i=this;if(n.checkIsNotNullOrUndefinedOrBlank(i.applicationHandler)){k(i,"newApplication");}else{i.showMessage("11509");}},handleListItemPress:function(i){var j=this,q;q=i.getParameter("listItem").getBindingContext().getPath().split("/")[2];sap.ui.core.UIComponent.getRouterFor(j).navTo("configurationList",{appId:j.byId("idApplicationTable").getModel().getData().Objects[q].id});},handleTextpoolCleanupPress:function(i){var t;var j=i.getSource().getBindingContext().getObject().id;var q=new sap.ui.core.CustomData({value:{applicationId:j}});var r=this.coreApi.getText;t=sap.ui.xmlfragment("idTextpoolCleanupConfirmationFragment","sap.apf.modeler.ui.fragment.textpoolCleanupConfirmationDialog",this);t.setTitle(r("confirmation"));t.getButtons()[0].setText(r("ok"));t.getButtons()[1].setText(r("cancel"));l(this,t,"textpoolCleanupConfirmation",q);},handleConfirmTextpoolCleanup:function(i){var j=this;var q=sap.ui.core.Fragment.byId("idTextpoolCleanupConfirmationFragment","idTextpoolCleanupConfirmation").getCustomData()[0].getValue().applicationId;j.coreApi.getConfigurationHandler(q,function(r){var t=r.getTextPool();j.coreApi.getUnusedTextKeys(q,function(u,s){if(!n.checkIsNotUndefined(s)){t.removeTexts(u,q,function(s){if(!n.checkIsNotUndefined(s)){j.showMessage("11511");}else{j.showMessage("11507",s);}j.closeTextpoolCleanupConfirmationDialog();});}else{j.showMessage("11506",s);j.closeTextpoolCleanupConfirmationDialog();}});});},closeTextpoolCleanupConfirmationDialog:function(){sap.ui.core.Fragment.byId("idTextpoolCleanupConfirmationFragment","idTextpoolCleanupConfirmation").destroy();},handleCancelTextpoolCleanup:function(i){this.closeTextpoolCleanupConfirmationDialog();},handleEditPress:function(i){var j,v;if(n.checkIsNotNullOrUndefinedOrBlank(this.applicationHandler)){j=i.getSource().getBindingContext().getObject();v={parentControl:this.byId("idApplicationTable"),coreApi:this.coreApi,applicationData:j};sap.ui.view({viewName:"sap.apf.modeler.ui.view.editApplication",type:sap.ui.core.mvc.ViewType.XML,viewData:v,async:true}).loaded().then(function(q){this.getView().addDependent(q);}.bind(this));}},handleDeletePress:function(i){var j=this,D;var P=i.getSource().getBindingContext().getPath().split("/")[2];var q=new sap.ui.core.CustomData({value:{removeId:this.byId("idApplicationTable").getModel().getData().Objects[P].id,sPath:P}});D=sap.ui.xmlfragment("idDeleteConfirmationFragment","sap.apf.modeler.ui.fragment.deleteConfirmationDialog",j);d(j);l(j,D,"deleteApp",q);},handleConfirmDeletion:function(){var i=this;var r=sap.ui.core.Fragment.byId("idDeleteConfirmationFragment","idDeleteConfirmation").getCustomData()[0].getValue().removeId;if(n.checkIsNotUndefined(r)){i.applicationHandler.removeApplication(r,function(R,M,j){if(!n.checkIsNotUndefined(j)&&(typeof R==="string")){e(i);f(i,"11510");}else{i.showMessage("11501",j);}i.closeDialog();});}},closeDialog:function(){sap.ui.core.Fragment.byId("idDeleteConfirmationFragment","idDeleteConfirmation").destroy();},handleNavigationWithSave:function(){var i=this;i.handleSavePress();sap.ui.core.Fragment.byId("idUnsavedDataConfirmationFragment","idMessageDialog").destroy();},handleNavigationWithoutSave:function(){sap.ui.core.Fragment.byId("idUnsavedDataConfirmationFragment","idMessageDialog").destroy();},handlePreventNavigation:function(){sap.ui.core.Fragment.byId("idUnsavedDataConfirmationFragment","idMessageDialog").destroy();},handleImportPress:function(E){if(this.coreApi.isVendorContentAvailable()){p(this,E);}else{k(this,"importFiles");}},handleSavePress:function(){var i=this,u=[],q,t,j;q=i.applicationHandler.getList();t=i.byId("idApplicationTable").getModel().getData().Objects;for(j=0;j<q.length;j++){if(t[j].description!==q[j].ApplicationName||t[j].semanticObject!==q[j].SemanticObject){u.push(t[j]);}}u.forEach(function(r){var s={ApplicationName:r.description,SemanticObject:r.semanticObject};i.applicationHandler.setAndSave(s,function(R,M,v){if(n.checkIsNotUndefined(v)){i.showMessage("11500",v);}},r.id);});},handleNavigationToConfigurationList:function(E){var i=this;var P={listItem:sap.ui.getCore().byId(E.currentTarget.id).getParent(),srcControl:i.byId("idApplicationTable")};i.byId("idApplicationTable").fireItemPress(P);},handleAdditionOfNewApp:function(E){var j=this,q,A,i,r=0,s;q=E.getParameter("appId");e(j);A=j.byId('idApplicationTable').getModel().getData().Objects;f(j,"11512");j.byId('idApplicationTable').rerender();for(i=0;i<A.length;i++){if(A[i].id===q){r=i;break;}}s=j.byId('idApplicationTable').getItems();if(s.length){var t=s[r].getDomRef();if(t){t.scrollIntoView();}}if(this.actualQuery!==""){this.filterValues(this.actualQuery);}},handleAppListUpdate:function(){var i=this;e(i);},handleNavBack:function(){window.history.go(-1);},onSearch:function(i){var q=i.getParameters().newValue;this.actualQuery=q;this.filterValues(q);},filterValues:function(q){var i=[];if(q&&q.length>0){var j=new F("description",sap.ui.model.FilterOperator.Contains,q);i.push(j);}var t=this.byId("idApplicationTable");var r=t.getBinding("items");r.filter(i,"Objects");}});});
