/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.require("sap.apf.modeler.ui.controller.requestOptions");jQuery.sap.require("sap.apf.modeler.ui.utils.displayOptionsValueBuilder");jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");(function(){"use strict";var n=sap.apf.modeler.ui.utils.nullObjectChecker;var t=sap.apf.modeler.ui.utils.textManipulator;var T=sap.apf.modeler.ui.utils.TranslationFormatMap.STEPFILTERPROPERTY_LABEL;function _(c){var o=c.getView().getViewData().oTextReader;var s=c.oParentObject.getFilterMappingTargetPropertyLabelKey()?o("label"):o("label")+" ("+o("default")+")";c.byId("idOptionalSelectedPropertyLabel").setText(s);c.byId("idOptionalSelectedPropertyLabel").setTooltip(s);}function a(c){var s=c.getSource();var e=c.getEntity();var p;var P=c.oParentObject.getFilterMappingTargetPropertyLabelKey();if(s===undefined||e===undefined){return;}if(n.checkIsNotUndefined(P)){p=c.getView().getViewData().oConfigurationHandler.getTextPool().get(P).TextElementDescription;c.byId("idOptionalSelectedPropertyLabelText").setValue(p);return;}c.oStepPropertyMetadataHandler.getFilterMappingEntityTypeMetadataAsPromise(s,e).done(function(d){var f=c.oParentObject.getFilterMappingTargetProperties()[0];if(f){p=c.oStepPropertyMetadataHandler.getDefaultLabel(d,f);}c.byId("idOptionalSelectedPropertyLabelText").setValue(p);});}function b(c){c.byId("idOptionalRequestFieldLabel").addStyleClass("filterPropertyLable");c.byId("idOptionalRequestField").addStyleClass("filterProperty");c.byId("idOptionalLabelDisplayOptionType").addStyleClass("filterProperty");}sap.apf.modeler.ui.controller.requestOptions.extend("sap.apf.modeler.ui.controller.stepFilterMapping",{setLabelDisplayOptionTypeAsPromise:function(o){var d=jQuery.Deferred();var c=this;var s=c.getSource();var e=c.getEntity();var l=[];var f=c.getView().getViewData().oTextReader;var g=new sap.apf.modeler.ui.utils.DisplayOptionsValueBuilder(f,o);var m=g.getLabelDisplayOptions();var L=sap.apf.core.constants.representationMetadata.labelDisplayOptions;var p=t.removePrefixText(c.byId("idOptionalRequestField").getSelectedKey(),f(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));_(c);a(c);c.byId("idOptionalLabelDisplayOptionType").setEnabled(true);if(!p){c.byId("idOptionalLabelDisplayOptionType").setModel(m);c.byId("idOptionalLabelDisplayOptionType").setEnabled(false);return d.promise();}var h=c.oParentObject.getFilterMappingTargetPropertyLabelDisplayOption();c.oStepPropertyMetadataHandler.getFilterMappingEntityTypeMetadataAsPromise(s,e).done(function(E){if((h===L.KEY_AND_TEXT||h===L.TEXT)&&!E.getPropertyMetadata(p).text){m=g.getValidatedLabelDisplayOptions();l=t.addPrefixText([h],f);h=l[0];}c.byId("idOptionalLabelDisplayOptionType").setModel(m);c.byId("idOptionalLabelDisplayOptionType").setSelectedKey(h);d.resolve();});return d.promise();},enableDisableLabelDisplayOptionTypeAsPromise:function(){var c=this;var s=c.getSource();var e=c.getEntity();var d=jQuery.Deferred();var o=c.getView().getViewData().oTextReader;var D=c.byId("idOptionalLabelDisplayOptionType");var p=t.removePrefixText(c.byId("idOptionalRequestField").getSelectedKey(),o(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));c.oStepPropertyMetadataHandler.getFilterMappingEntityTypeMetadataAsPromise(s,e).done(function(f){var i=f.getPropertyMetadata(p).text;D.getItems().forEach(function(g){g.setEnabled(true);if(g.getKey()!=="key"&&!i){g.setEnabled(false);}});d.resolve();});return d.promise();},changeLabelDisplayOption:function(l){var c=this;c.oParentObject.setFilterMappingTargetPropertyLabelDisplayOption(l);},changeOptionalSelectedPropertyLabelText:function(l){var c=this;if(l.trim().length===0){c.oParentObject.setFilterMappingTargetPropertyLabelKey(undefined);_(c);a(c);return;}c.getView().getViewData().oConfigurationHandler.getTextPool().setTextAsPromise(l,T).done(function(L){c.oParentObject.setFilterMappingTargetPropertyLabelKey(L);_(c);a(c);});},onBeforeRendering:function(){var c=this;c.byId("idSelectPropertiesLabel").setVisible(false);c.byId("idSelectProperties").setVisible(false);c.byId("idOptionalRequestFieldLabel").setVisible(true);c.byId("idOptionalRequestField").setVisible(true);c.byId("idOptionalLabelDisplayOptionType").setVisible(true);c.byId("idOptionalRequestField").setForceSelection(false);c.byId("idOptionalSelectedPropertyLabel").setVisible(true);c.byId("idOptionalSelectedPropertyLabelText").setVisible(true);},onAfterRendering:function(){b(this);},getIdOfPropertiesControl:function(){return"idOptionalRequestField";},getIdOfPropertyLabel:function(){return"idOptionalRequestFieldLabel";},setSelectedKeysForProperties:function(p){var c=this;if(p.length!==0){c.byId("idOptionalRequestField").setSelectedKey(p[0]);}else{c.byId("idOptionalRequestField").clearSelection();}},getSelectedKeysForProperties:function(){var c=this,s,S;var o=c.getView().getViewData().oTextReader;s=t.removePrefixText(c.byId("idOptionalRequestField").getSelectedKey(),o(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));S=n.checkIsNotNullOrUndefinedOrBlank(s)?[s]:[];return S;},setDisplayText:function(){var c=this;var o=c.getView().getViewData().oTextReader;c.byId("idSourceLabel").setText(o("source"));c.byId("idEntityLabel").setText(o("entity"));c.byId("idOptionalRequestFieldLabel").setText(o("targetProperty"));},resetEntityAndProperties:function(){var c=this;c.clearEntity();c.byId("idEntity").setModel(null);c.byId("idEntity").setSelectedKey(undefined);c.clearSelectProperties();c.byId("idOptionalRequestField").setModel(null);c.byId("idOptionalRequestField").setSelectedKey(undefined);},resetFilterMappingFields:function(){var c=this;c.clearSource();c.byId("idSource").setValue("");c.resetEntityAndProperties();c.addOrRemoveMandatoryFieldsAndRequiredFlag(false);},updateFilterMappingFields:function(){var c=this,s,e,E,S,d;var o=c.getView().getViewData().oTextReader;s=c.byId("idSource").getValue().trim();c.oConfigurationEditor.setIsUnsaved();if(n.checkIsNotNullOrUndefinedOrBlank(s)){c.getAllEntitiesAsPromise(s).done(function(f){if(!n.checkIsNotNullOrUndefinedOrBlank(f)){c.resetEntityAndProperties();return;}c.setDetailData();e=t.removePrefixText(c.byId("idEntity").getSelectedKey(),o(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));E=n.checkIsNotNullOrUndefinedOrBlank(e)?e:undefined;c.updateEntity(E);S=t.removePrefixText(c.byId("idOptionalRequestField").getSelectedKey(),o(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));d=n.checkIsNotNullOrUndefinedOrBlank(S)?[S]:[];c.updateSelectProperties(d);});}},getSource:function(){var c=this;return c.oParentObject.getFilterMappingService();},getAllEntitiesAsPromise:function(s){var c=this;return c.oConfigurationEditor.getAllEntitySetsOfServiceWithGivenPropertiesAsPromise(s,c.oParentObject.getFilterProperties());},getEntity:function(){var c=this;return c.oParentObject.getFilterMappingEntitySet();},getAllEntitySetPropertiesAsPromise:function(s,e){var c=this;return c.oConfigurationEditor.getAllPropertiesOfEntitySetAsPromise(s,e);},clearSource:function(){var c=this;c.oParentObject.setFilterMappingService(undefined);c.clearEntity();},clearEntity:function(){var c=this;c.oParentObject.setFilterMappingEntitySet(undefined);c.clearSelectProperties();},clearSelectProperties:function(){var c=this;var o=c.oParentObject.getFilterMappingTargetProperties();o.forEach(function(p){c.oParentObject.removeFilterMappingTargetProperty(p);});c.byId("idOptionalSelectedPropertyLabelText").setValue("");},removeSelectProperties:function(p){var c=this;p.forEach(function(d){c.oParentObject.removeFilterMappingTargetProperty(d);});},updateSource:function(s){var c=this;c.oParentObject.setFilterMappingService(s);},updateEntity:function(e){var c=this;c.oParentObject.setFilterMappingEntitySet(e);},updateSelectProperties:function(s){var c=this;c.removeSelectProperties(c.oParentObject.getFilterMappingTargetProperties());s.forEach(function(p){c.oParentObject.addFilterMappingTargetProperty(p);});},updateOptionalRequestFieldProperty:function(f){var c=this;c.updateSelectProperties(f);},getSelectProperties:function(){var c=this;return c.oParentObject.getFilterMappingTargetProperties();},getValidationState:function(){var c=this;return c.viewValidator.getValidationState();}});}());
