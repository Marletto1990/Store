/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.require("sap.apf.modeler.ui.controller.requestOptions");jQuery.sap.require("sap.apf.modeler.ui.utils.displayOptionsValueBuilder");jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");sap.ui.define(["sap/apf/modeler/ui/controller/requestOptions","sap/apf/modeler/ui/utils/textManipulator"],function(B,t){"use strict";var o=sap.apf.modeler.ui.utils.optionsValueModelBuilder;var n=sap.apf.modeler.ui.utils.nullObjectChecker;var T=sap.apf.modeler.ui.utils.TranslationFormatMap.STEPFILTERPROPERTY_LABEL;function _(c){var d=c.getView().getViewData().oTextReader;var s=c.oParentObject.getFilterPropertyLabelKey()?d("label"):d("label")+" ("+d("default")+")";c.byId("idOptionalSelectedPropertyLabel").setText(s);c.byId("idOptionalSelectedPropertyLabel").setTooltip(s);}function a(c){var d=jQuery.Deferred();var p;var P=c.oParentObject.getFilterPropertyLabelKey();if(!c.getSource()||!c.getEntity()){return d.resolve();}if(n.checkIsNotUndefined(P)){p=c.getView().getViewData().oConfigurationHandler.getTextPool().get(P).TextElementDescription;c.byId("idOptionalSelectedPropertyLabelText").setValue(p);return d.resolve();}c.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().done(function(e){var s=c.oParentObject.getFilterProperties()[0];if(c.oParentObject.getType()==="hierarchicalStep"&&s){s=c.oStepPropertyMetadataHandler.getPropertyMetadata(e,s)["hierarchy-node-for"];}if(s){p=c.oStepPropertyMetadataHandler.getDefaultLabel(e,s);}c.byId("idOptionalSelectedPropertyLabelText").setValue(p);d.resolve();});return d;}function b(c){c.byId("idOptionalRequestFieldLabel").addStyleClass("filterPropertyLable");c.byId("idOptionalRequestField").addStyleClass("filterProperty");c.byId("idOptionalLabelDisplayOptionType").addStyleClass("filterProperty");}return B.extend("sap.apf.modeler.ui.controller.stepRequest",{setLabelDisplayOptionTypeAsPromise:function(o){var d=jQuery.Deferred();var c,l,m,p,L,C=this,e=[];var f=C.getView().getViewData().oTextReader;c=new sap.apf.modeler.ui.utils.DisplayOptionsValueBuilder(f,o);m=c.getLabelDisplayOptions();l=sap.apf.core.constants.representationMetadata.labelDisplayOptions;p=t.removePrefixText(C.byId("idOptionalRequestField").getSelectedKey(),f(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));_(C);a(C).done(function(){C.byId("idOptionalLabelDisplayOptionType").setEnabled(true);if(p===f("none")){C.byId("idOptionalLabelDisplayOptionType").setModel(m);C.byId("idOptionalLabelDisplayOptionType").setEnabled(false);return d.promise();}L=C.oParentObject.getFilterPropertyLabelDisplayOption();C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().done(function(E){if((L===l.KEY_AND_TEXT||L===l.TEXT)&&!C.oStepPropertyMetadataHandler.hasTextPropertyOfDimension(E,p)){m=c.getValidatedLabelDisplayOptions();e=t.addPrefixText([L],f);L=e[0];}C.byId("idOptionalLabelDisplayOptionType").setModel(m);C.byId("idOptionalLabelDisplayOptionType").setSelectedKey(L);d.resolve();});});return d.promise();},enableDisableLabelDisplayOptionTypeAsPromise:function(){var i,c=this;var d=jQuery.Deferred();var e=c.getView().getViewData().oTextReader;var D=c.byId("idOptionalLabelDisplayOptionType");var p=t.removePrefixText(c.byId("idOptionalRequestField").getSelectedKey(),e(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));c.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().done(function(f){var I=c.oStepPropertyMetadataHandler.hasTextPropertyOfDimension(f,p);for(i=0;i<D.getItems().length;i++){D.getItems()[i].setEnabled(true);if(i>0&&!I){D.getItems()[i].setEnabled(false);}}d.resolve();});return d.promise();},onBeforeRendering:function(){var c=this;c.byId("idOptionalRequestFieldLabel").setVisible(true);c.byId("idOptionalRequestField").setVisible(true);c.byId("idOptionalLabelDisplayOptionType").setVisible(true);c.byId("idOptionalSelectedPropertyLabel").setVisible(true);c.byId("idOptionalSelectedPropertyLabelText").setVisible(true);},onAfterRendering:function(){var c=this;c.addOrRemoveMandatoryFieldsAndRequiredFlag(true);b(c);},setDisplayText:function(){var c=this;var d=c.getView().getViewData().oTextReader;c.byId("idSourceLabel").setText(d("source"));c.byId("idEntityLabel").setText(d("entity"));c.byId("idSelectPropertiesLabel").setText(d("selectProperties"));c.byId("idOptionalRequestFieldLabel").setText(d("requiredFilters"));},setOptionalRequestFieldProperty:function(){var c=this;var p,s,i,m,N,v=[];var f=c.oParentObject.getFilterProperties();N=[c.getView().getViewData().oTextReader("none")];p=c.byId("idSelectProperties").getSelectedKeys();s=c.oParentObject.getSelectProperties();s.forEach(function(d){if(d===f[0]){i=true;}});if(!i&&f.length>0){c.removeOptionalRequestFieldProperty(f);f=c.oParentObject.getFilterProperties();}m=o.convert(N.concat(p));c.byId("idOptionalRequestField").setModel(m);c.byId("idOptionalRequestField").setSelectedKey(N[0]);if(n.checkIsNotNullOrUndefinedOrBlank(f)){v=c.validateSelectedValues(c,f,p);f=v.aSelectedValues;c.byId("idOptionalRequestField").setSelectedKey(f[0]);}},addOrRemoveMandatoryFieldsAndRequiredFlag:function(r){var c=this;if(r===false){return;}c.byId("idSourceLabel").setRequired(r);c.byId("idEntityLabel").setRequired(r);c.byId("idSelectPropertiesLabel").setRequired(r);c.viewValidator.addFields(["idSource","idEntity","idSelectProperties"]);},fireRelevantEvents:function(e){var c=this,f,s;if(e.getSource()!==c.byId("idOptionalRequestField")){f=[t.removePrefixText(c.byId("idOptionalRequestField").getSelectedKey(),c.getView().getViewData().oTextReader(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE))];if(n.checkIsNotNullOrUndefinedOrBlank(f)){c.updateOptionalRequestFieldProperty(f);}if(c.getSelectProperties().length===0){c.oParentObject.resetTopN();}c.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETDATAREDUCTIONSECTION);}if(e.getSource()===c.byId("idOptionalProperty")){c.setOptionalRequestFieldProperty();}s=(c.byId("idOptionalRequestField").getSelectedKey()!==c.getView().getViewData().oTextReader("none"))?true:false;c.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.SETVISIBILITYOFFILTERMAPPINGFIELDS,{"bShowFilterMappingLayout":s});c.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.step.UPDATEFILTERMAPPINGFIELDS);},getSource:function(){return this.oParentObject.getService();},getAllEntitiesAsPromise:function(s){return this.oConfigurationEditor.getAllEntitySetsOfServiceAsPromise(s);},getEntity:function(){return this.oParentObject.getEntitySet();},getAllEntitySetPropertiesAsPromise:function(s,e){return this.oConfigurationEditor.getAllPropertiesOfEntitySetAsPromise(s,e);},changeLabelDisplayOption:function(l){var c=this;c.oParentObject.setFilterPropertyLabelDisplayOption(l);},changeOptionalSelectedPropertyLabelText:function(l){var c=this;if(l.trim().length===0){c.oParentObject.setFilterPropertyLabelKey(undefined);_(c);a(c);return;}c.getView().getViewData().oConfigurationHandler.getTextPool().setTextAsPromise(l,T).done(function(L){c.oParentObject.setFilterPropertyLabelKey(L);_(c);a(c);});},resetEntityAndProperties:function(){var c=this;c.clearEntity();c.byId("idEntity").setModel(null);c.byId("idEntity").setSelectedKey(undefined);c.clearSelectProperties();c.byId("idSelectProperties").setModel(null);c.byId("idSelectProperties").setSelectedKeys([]);c.byId("idOptionalRequestField").setModel(null);c.byId("idOptionalRequestField").setSelectedKey(undefined);},clearSource:function(){var c=this;c.oParentObject.setService(undefined);c.clearEntity();},clearEntity:function(){var c=this;c.oParentObject.setEntitySet(undefined);c.clearSelectProperties();},clearSelectProperties:function(){var c=this;var O=c.oParentObject.getSelectProperties();O.forEach(function(p){c.oParentObject.removeSelectProperty(p);});c.clearOptionalRequestFieldProperty();},clearOptionalRequestFieldProperty:function(){var c=this;var O=c.oParentObject.getFilterProperties();O.forEach(function(p){c.oParentObject.removeFilterProperty(p);});},removeSelectProperties:function(p){var c=this;p.forEach(function(d){c.oParentObject.removeSelectProperty(d);});},removeOptionalRequestFieldProperty:function(p){var c=this;p.forEach(function(d){c.oParentObject.removeFilterProperty(d);});},updateSource:function(s){var c=this;c.oParentObject.setService(s);},updateEntity:function(e){var c=this;c.oParentObject.setEntitySet(e);},updateSelectProperties:function(s){var c=this;c.removeSelectProperties(c.oParentObject.getSelectProperties());s.forEach(function(p){c.oParentObject.addSelectProperty(p);});},updateOptionalRequestFieldProperty:function(f){var c=this;var l=c.oParentObject.getFilterPropertyLabelKey();var d=c.oParentObject.getFilterPropertyLabelDisplayOption();var F=c.oParentObject.getFilterProperties();c.removeOptionalRequestFieldProperty(c.oParentObject.getFilterProperties());f.forEach(function(p){if(p!==c.getView().getViewData().oTextReader("none")){c.oParentObject.addFilterProperty(p);if(p===F[0]){c.oParentObject.setFilterPropertyLabelKey(l);c.oParentObject.setFilterPropertyLabelDisplayOption(d);}}});},getSelectProperties:function(){var c=this;return c.oParentObject.getSelectProperties();},getOptionalRequestFieldProperty:function(){var c=this;return c.oParentObject.getFilterProperties();},getValidationState:function(){var c=this;return c.viewValidator.getValidationState();}});});
