/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");jQuery.sap.require("sap.apf.modeler.ui.utils.nullObjectChecker");jQuery.sap.require("sap.apf.modeler.ui.utils.optionsValueModelBuilder");jQuery.sap.require("sap.apf.modeler.ui.utils.viewValidator");jQuery.sap.require("sap.apf.modeler.ui.utils.textManipulator");(function(){"use strict";var p,t,c,C,T,f,v;var n=sap.apf.modeler.ui.utils.nullObjectChecker;var o=sap.apf.modeler.ui.utils.optionsValueModelBuilder;var a=sap.apf.modeler.ui.utils.textManipulator;var b=sap.apf.modeler.ui.utils.TranslationFormatMap.FACETFILTER_LABEL;function _(i){i.byId("idFacetFilterBasicData").setText(t("basicData"));i.byId("idFFLabel").setText(t("ffLabel"));i.byId("idLabel").setPlaceholder(t("newFacetFilter"));i.byId("idFFPropertyLabel").setText(t("ffProperty"));i.byId("idDoNotShowAtRuntimeLabel").setText(t("doNotShowAtRuntime"));i.byId("idSelectionModeLabel").setText(t("ffSelectionMode"));i.byId("idValueHelpLabel").setText(t("valueHelpMode"));i.byId("idVHNone").setText(t("none"));i.byId("idValueHelpRequest").setText(t("valueHelpRequest"));i.byId("idConfigListOfValues").setText(t("configListOfValues"));i.byId("idConfigListOfValuesLabel").setText(t("configListOfValuesLabel"));i.byId("idSingleSelectionMode").setText(t("singleSelection"));i.byId("idMultiSelectionMode").setText(t("multipleSelection"));i.byId("idDefaultValuesTitle").setText(t("vhDefaultValues"));i.byId("idPreselectionModeLabel").setText(t("vhDefaultValueMode"));i.byId("idNoneSelection").setText(t("none"));i.byId("idAutomaticSelection").setText(t("automaticValue"));i.byId("idFixedValue").setText(t("fixedValues"));i.byId("idFunction").setText(t("function"));i.byId("idPreselectionDefaultsLabel").setText(t("vhDefaultValues"));i.byId("idPreselectionFunctionLabel").setText(t("function"));i.byId("idValueHelpTitle").setText(t("valueHelp"));i.byId("idFilterResolutionTitle").setText(t("contextResolution"));i.byId("idUseVHRAsFRRCheckBoxLabel").setText(t("vhCheckBoxLabel"));i.byId("idAriaPropertyForSelection").setText(t("ffSelectionMode"));i.byId("idAriaPropertyForDefaultMode").setText(t("vhDefaultValueMode"));i.byId("idAriaPropertyForVHR").setText(t("valueHelpMode"));}function d(i,H){var I=f.isVisible()?"sap-icon://filter":"sap-icon://hide";var J={id:f.getId(),icon:I};if(H){delete J.icon;J.name=H;}i.getView().getViewData().updateSelectedNode(J);}function e(i,H){var I=t("facetFilter")+": "+H;i.getView().getViewData().updateTitleAndBreadCrumb(I);}function g(i){var H;if(p&&p.arguments&&p.arguments.facetFilterId){f=C.getFacetFilter(p.arguments.facetFilterId);}if(!n.checkIsNotUndefined(f)){H=C.createFacetFilter();f=C.getFacetFilter(H);d(i);}}function h(i){var H,I,V,J;var K={oTextReader:t,oConfigurationHandler:c,oConfigurationEditor:C,oParentObject:f,getCalatogServiceUri:i.getView().getViewData().getCalatogServiceUri,oCoreApi:i.getView().getViewData().oCoreApi};H=new sap.ui.controller("sap.apf.modeler.ui.controller.facetFilterVHR");V=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.requestOptions",type:sap.ui.core.mvc.ViewType.XML,id:i.createId("idVHRView"),viewData:K,controller:H});I=new sap.ui.controller("sap.apf.modeler.ui.controller.facetFilterFRR");J=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.requestOptions",type:sap.ui.core.mvc.ViewType.XML,id:i.createId("idFRRView"),viewData:K,controller:I});V.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.UPDATEPROPERTIES,i.setFFProperty.bind(i));J.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.UPDATEPROPERTIES,i.setFFProperty.bind(i));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.USESAMEASVHR,J.getController().handleCopy.bind(J.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS,J.getController().enableOrDisableView.bind(J.getController()));V.attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.USESAMEASVHR,J.getController().handleCopy.bind(J.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,V.getController().updateSubViewInstancesOnReset.bind(V.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,J.getController().updateSubViewInstancesOnReset.bind(J.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.DONOTSHOWATRUNTIME,V.getController().clearVHRFields.bind(V.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.CLEARVHRFIELDSIFVALUELIST,V.getController().clearVHRFields.bind(V.getController()));i.getView().attachEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.DONOTSHOWATRUNTIME,J.getController().clearFRRFields.bind(J.getController()));V.addStyleClass("formTopPadding");V.addStyleClass("formBottomPadding");J.addStyleClass("formTopPadding");}function j(i,V){i.byId("idSelectionMode").setVisible(V);i.byId("idSelectionModeLabel").setVisible(V);i.byId("idSelectionModeRadioGroup").setSelectedButton(i.byId("idMultiSelectionMode"));i.byId("idValueHelp").setVisible(V);i.byId("idValueHelpLabel").setVisible(V);i.byId("idValueHelpRadioGroup").setSelectedButton(i.byId("idVHNone"));i.byId("idFFForm1").setVisible(V);if(V){i.byId("idValueHelpTitle").setText(t("valueHelp"));i.byId("idFRRVBox").insertItem(i.byId("idFRRView"));i.byId("idDoNotShowAtRuntimeCheckBox").setSelected(false);}else{i.byId("idValueHelpTitle").setText("");z(i,V);y(i,V);i.byId("idFRRVBox").removeItem(i.byId("idFRRView"));}}function k(i){if(!f.isVisible()){i.byId("idDoNotShowAtRuntimeCheckBox").setSelected(true);}j(i,f.isVisible());}function l(i){if(!n.checkIsNotNullOrUndefinedOrBlank(C.getFacetFilter(p.arguments.facetFilterId))){return;}if(n.checkIsNotNullOrUndefinedOrBlank(f.getLabelKey())&&T.get(f.getLabelKey())){i.byId("idLabel").setValue(T.get(f.getLabelKey()).TextElementDescription);}else{i.byId("idLabel").setValue(f.getId());}}function m(i){if(!n.checkIsNotNullOrUndefinedOrBlank(C.getFacetFilter(p.arguments.facetFilterId))){f.setMultiSelection(true);}if(f.isMultiSelection()){i.byId("idSelectionModeRadioGroup").setSelectedButton(i.byId("idMultiSelectionMode"));}else{i.byId("idSelectionModeRadioGroup").setSelectedButton(i.byId("idSingleSelectionMode"));}}function q(i){i.byId("idPreselectionFunction").setValue("");if(n.checkIsNotNullOrUndefinedOrBlank(f.getPreselectionFunction())){i.byId("idPreselectionFunction").setValue(f.getPreselectionFunction());}}function r(i){var I=false,H=false;if(f.getNoneSelection()){i.byId("idPreselectionModeRadioGroup").setSelectedButton(i.byId("idNoneSelection"));}else if(n.checkIsNotNullOrUndefinedOrBlank(f.getPreselectionFunction())){i.byId("idPreselectionModeRadioGroup").setSelectedButton(i.byId("idFunction"));q(i);I=true;}else if(n.checkIsNotNullOrUndefinedOrBlank(f.getPreselectionDefaults())){i.byId("idPreselectionModeRadioGroup").setSelectedButton(i.byId("idFixedValue"));w(i);H=true;}else if(f.getAutomaticSelection()){i.byId("idPreselectionModeRadioGroup").setSelectedButton(i.byId("idAutomaticSelection"));}s(i,I);u(i,H);}function s(i,V){i.byId("idPreselectionFunctionLabel").setVisible(V);i.byId("idPreselectionFunction").setVisible(V);if(V){v.addField("idPreselectionFunction");}else{i.byId("idPreselectionFunction").setValue("");v.removeField("idPreselectionFunction");}}function u(i,V){i.byId("idPreselectionDefaultsLabel").setVisible(V);i.byId("idPreselectionDefaults").setVisible(V);if(V){v.addField("idPreselectionDefaults");}else{v.removeField("idPreselectionDefaults");}}function w(i){i.byId("idPreselectionDefaults").setTokens([]);var H=f.getPreselectionDefaults();if(n.checkIsNotNullOrUndefinedOrBlank(H)){H.forEach(function(I){i.byId("idPreselectionDefaults").addToken(new sap.m.Token({text:I}));});}}function x(i){i.byId("idConfigListOfValuesMultiInput").setTokens([]);var H=f.getValueList();if(n.checkIsNotNullOrUndefinedOrBlank(H)){H.forEach(function(I){i.byId("idConfigListOfValuesMultiInput").addToken(new sap.m.Token({text:I}));});}}function y(i,I){i.byId("idConfigListOfValuesLabel").setVisible(I);i.byId("idConfigListOfValuesMultiInput").setVisible(I);if(I){v.addField("idConfigListOfValuesMultiInput");}else{v.removeField("idConfigListOfValuesMultiInput");}}function z(i,I){i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS);D(i,I);if(I){i.byId("idVHRVBox").insertItem(i.byId("idVHRView"));}else{i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.CLEARVHRFIELDSIFVALUELIST);i.byId("idVHRVBox").removeItem(i.byId("idVHRView"));}}function A(i){if(f.getUseSameRequestForValueHelpAndFilterResolution()){i.byId("idUseVHRAsFRRCheckBox").setSelected(true);i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS);}}function B(i){var I=false,H=false;if(n.checkIsNotNullOrUndefinedOrBlank(f.getServiceOfValueHelp())){I=true;i.byId("idValueHelpRadioGroup").setSelectedButton(i.byId("idValueHelpRequest"));}else if(n.checkIsNotNullOrUndefinedOrBlank(f.getValueList())){x(i);H=true;i.byId("idValueHelpRadioGroup").setSelectedButton(i.byId("idConfigListOfValues"));}else{i.byId("idValueHelpRadioGroup").setSelectedButton(i.byId("idVHNone"));}y(i,H);z(i,I);}function D(i,I){if(I===false){i.byId("idUseVHRAsFRRCheckBox").setSelected(false);}i.byId("idUseVHRAsFRRCheckBox").setVisible(I);i.byId("idUseVHRAsFRRCheckBoxLabel").setVisible(I);}function E(i,H){H.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.Warning);H.byId("idPreselectionDefaults").setValueStateText(t(i));H.byId('idPreselectionDefaults').focus();}function F(i,M){var P=new sap.m.Token({text:i});M.addToken(P);C.setIsUnsaved();}function G(M,i){if(M.mEventRegistry.tokenChange===undefined){M.attachTokenChange(i);}}sap.ui.controller("sap.apf.modeler.ui.controller.facetFilter",{onInit:function(){var i=this;var V=i.getView().getViewData();t=V.getText;p=V.oParams;c=V.oConfigurationHandler;T=c.getTextPool();C=V.oConfigurationEditor;if(!C){c.loadConfiguration(p.arguments.configId,function(H){C=H;});}v=new sap.apf.modeler.ui.utils.ViewValidator(i.getView());_(i);g(i);h(i);i.setDetailData();v.addFields(["idFFProperty","idLabel"]);},onAfterRendering:function(){var i=this;if(i.byId("idLabel").getValue().length===0){i.byId("idLabel").focus();}G(i.byId("idConfigListOfValuesMultiInput"),i.handleTokenChangeForConfigListOfValues.bind(i));G(i.byId("idPreselectionDefaults"),i.handleTokenChangeForPreselectionDefaults.bind(i));},setDetailData:function(){var i=this;k(i);i.setFFProperty();l(i);m(i);r(i);B(i);A(i);},updateSubViewInstancesOnReset:function(i){var H=this;C=i;f=C.getFacetFilter(f.getId());H.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.UPDATESUBVIEWINSTANCESONRESET,{"oConfigurationEditor":C,"oParentObject":f});},validateSelectedValues:function(i,S,H){var V={},I=[],J=[],K=[],L=[],M;V=sap.apf.utils.validateSelectedValues(S,H);I=V.invalid;J=V.valid;K=a.addPrefixText(I,t);L=K.concat(H).length!==0?K.concat(H):H;M=K.concat(J).length!==0?K.concat(J):S;return{aValues:L,aSelectedValues:M};},setFFProperty:function(){var i=this;var H=[],V,I;C.getFilterablePropertiesAndParametersAsPromise().done(function(J){H=J;I=f.getProperty();if(n.checkIsNotNullOrUndefinedOrBlank(I)){V=i.validateSelectedValues(i,[I],H);H=V.aValues;I=V.aSelectedValues[0];}var M=o.convert(H);i.byId("idFFProperty").setModel(M);i.byId("idFFProperty").setSelectedKey(I);});},handleChangeForVisibilityAtRuntime:function(){var i=this,V=true;if(i.byId("idDoNotShowAtRuntimeCheckBox").getSelected()){V=false;f.setInvisible();f.setUseSameRequestForValueHelpAndFilterResolution(false);i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS);i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.DONOTSHOWATRUNTIME);f.setValueList([]);x(i);}else{f.setVisible();}f.setMultiSelection(true);C.setIsUnsaved();d(i);j(i,V);},handleChangeForProperty:function(){var i=this;var H=i.byId("idFFProperty").getSelectedKey().trim();H=a.removePrefixText(H,t(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE));if(n.checkIsNotNullOrUndefinedOrBlank(H)){f.setProperty(H);}C.setIsUnsaved();},handleChangeForLabel:function(){var i=this;var H=i.byId("idLabel").getValue().trim();if(n.checkIsNotNullOrUndefinedOrBlank(H)){T.setTextAsPromise(H,b).done(function(I){f.setLabelKey(I);d(i,H);e(i,H);C.setIsUnsaved();});}else{C.setIsUnsaved();}},handleSuggestions:function(i){var S=new sap.apf.modeler.ui.utils.SuggestionTextHandler(T);S.manageSuggestionTexts(i,b);},handleChangeForSelectionMode:function(){var i=this,P,H;var S=i.byId("idSelectionModeRadioGroup").getSelectedButton();if(S===i.byId("idSingleSelectionMode")){f.setMultiSelection(false);if(i.byId("idPreselectionDefaultsLabel").getVisible()){P=f.getPreselectionDefaults();if(P&&P.length>1){f.setPreselectionDefaults([P[0]]);H=new sap.m.Token({text:P[0]});i.byId("idPreselectionDefaults").setTokens([H]);E("singleToMultipleSelectionWarningMessage",i);}}}else{i.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.None);f.setMultiSelection(true);}C.setIsUnsaved();},handleChangeForPreselectionMode:function(){var i=this,H=false,P=false,I=false,N=false;switch(i.byId("idPreselectionModeRadioGroup").getSelectedButton()){case i.byId("idAutomaticSelection"):H=true;break;case i.byId("idFunction"):P=true;f.removePreselectionDefaults();break;case i.byId("idFixedValue"):I=true;f.removePreselectionFunction();break;default:N=true;}f.setAutomaticSelection(H);f.setNoneSelection(N);w(i);q(i);u(i,I);s(i,P);C.setIsUnsaved();},handleChangeForPreselectionDefaults:function(i){var H=this;H.byId("idPreselectionDefaults").setValue("");H.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.None);if(!f.isMultiSelection()){if(H.byId("idPreselectionDefaults").getTokens().length<1){H.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.None);F(i.getParameter("value"),H.byId("idPreselectionDefaults"));}else{E("singleSelectionWarningMessage",H);}}else{F(i.getParameter("value"),H.byId("idPreselectionDefaults"));}},handleTokenChangeForPreselectionDefaults:function(H){var I=this;var i,J=[];var K=I.byId("idPreselectionDefaults").getTokens();I.byId("idPreselectionDefaults").setValueState(sap.ui.core.ValueState.None);if(H.getParameters().type==="removed"||H.getParameters().type==="added"){for(i=0;i<K.length;i++){J[i]=K[i].getText();}if(f.isMultiSelection()){f.setPreselectionDefaults(J);}else{f.setPreselectionDefaults([J[0]]);}if(H.getParameters().type==="removed"){C.setIsUnsaved();}}},handleChangeForPreselectionFunction:function(){var i=this;var P=i.byId("idPreselectionFunction").getValue().trim();f.removePreselectionFunction();if(n.checkIsNotNullOrUndefinedOrBlank(P)){f.setPreselectionFunction(P);}C.setIsUnsaved();},handleChangeForUseVHRAsFRRCheckBox:function(){var i=this;if(i.byId("idUseVHRAsFRRCheckBox").getSelected()){f.setUseSameRequestForValueHelpAndFilterResolution(true);}else{f.setUseSameRequestForValueHelpAndFilterResolution(false);}i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.ENABLEDISABLEFRRFIELDS);i.getView().fireEvent(sap.apf.modeler.ui.utils.CONSTANTS.events.facetFilter.USESAMEASVHR);C.setIsUnsaved();},handleChangeForValueHelpOption:function(){var i=this,V=false,H=false;switch(i.byId("idValueHelpRadioGroup").getSelectedButton()){case i.byId("idValueHelpRequest"):V=true;f.setValueList([]);break;case i.byId("idConfigListOfValues"):H=true;f.setAlias(undefined);break;default:f.setAlias(undefined);f.setValueList([]);}if(f.getUseSameRequestForValueHelpAndFilterResolution()===true){f.setUseSameRequestForValueHelpAndFilterResolution(false);i.byId("idUseVHRAsFRRCheckBox").setSelected(false);}x(i);y(i,H);z(i,V);C.setIsUnsaved();},handleChangeForConfigListOfValues:function(i){var H=this;H.byId("idConfigListOfValuesMultiInput").setValue("");F(i.getParameter("value"),H.byId("idConfigListOfValuesMultiInput"));},handleTokenChangeForConfigListOfValues:function(H){var I=this;var i,J=[];var K=I.byId("idConfigListOfValuesMultiInput").getTokens();if(H.getParameters().type==="removed"||H.getParameters().type==="added"){for(i=0;i<K.length;i++){J[i]=K[i].getText();}f.setValueList(J);if(H.getParameters().type==="removed"){C.setIsUnsaved();}}},getValidationState:function(){var i=this;return v.getValidationState()&&i.byId("idVHRView").getController().getValidationState()&&i.byId("idFRRView").getController().getValidationState();},onExit:function(){var i=this;i.byId("idVHRView").destroy();i.byId("idFRRView").destroy();}});}());
