/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");jQuery.sap.require("sap.apf.modeler.ui.utils.textManipulator");jQuery.sap.require('sap.apf.utils.utils');sap.ui.define(['sap/apf/modeler/ui/utils/constants','sap/apf/modeler/ui/utils/optionsValueModelBuilder','sap/apf/modeler/ui/utils/nullObjectChecker'],function(M,o,n){"use strict";var t=sap.apf.modeler.ui.utils.textManipulator;var c=M.events;var T=sap.apf.modeler.ui.utils.TranslationFormatMap.REPRESENTATION_LABEL;function _(C){var r=C.oRepresentation.getRepresentationType();var k=C.getView().getViewData().oPropertyTypeData.sContext;var p=C.getView().getViewData().oRepresentationTypeHandler.getLabelsForChartType(C.oTextReader,r,k);C.byId("idPropertyTypeLabel").setText(p);C.byId("idPropertyTypeLabel").setTooltip(p);}function a(C){if(sap.ui.Device.browser.msie&&sap.ui.Device.browser.version>=11){C.byId("idAriaPropertyForBasicDataGroup").setText(C.oTextReader("basicData"));}C.byId("idAriaPropertyForAdd").setText(C.oTextReader("ariaTextForAddIcon"));C.byId("idAriaPropertyForDelete").setText(C.oTextReader("ariaTextForDeleteIcon"));}function b(C){var m;var j=jQuery.Deferred();var v=C.byId("idPropertyType");C.getAllPropertiesAsPromise().then(function(r){m=o.convert(r.aAllProperties);v.setModel(m);v.setSelectedKey(r.sSelectedKey);j.resolve();});return j.promise();}function d(C){var p=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(M.texts.NOTAVAILABLE));var s=C.getPropertyTextLabelKey(p)?C.oTextReader("label"):C.oTextReader("label")+" ("+C.oTextReader("default")+")";C.byId("idPropertyLabel").setText(s);C.byId("idPropertyLabel").setTooltip(s);}function e(C){var p;var P=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(M.texts.NOTAVAILABLE));var s=C.getPropertyTextLabelKey(P);if(n.checkIsNotUndefined(s)){p=C.getView().getViewData().oConfigurationHandler.getTextPool().get(s).TextElementDescription;C.byId("idPropertyLabelText").setValue(p);}else{C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().then(function(j){var l=C.oStepPropertyMetadataHandler.getDefaultLabel(j,P);C.byId("idPropertyLabelText").setValue(l);});}}function f(C){C.byId("idAddPropertyIcon").setTooltip(C.oTextReader("addButton"));C.byId("idRemovePropertyIcon").setTooltip(C.oTextReader("deleteButton"));}function g(C){var p=C.getView().getViewData().sPropertyType;var k=C.getView().getViewData().oPropertyTypeData.sContext;var s=C.oRepresentationTypeHandler.isAdditionToBeEnabled(C.oRepresentation.getRepresentationType(),p,k);var S=s;var P=C.getView().getViewData().oPropertyTypeState;var j=P.indexOfPropertyTypeViewId(C.getView().getId());if(j===0){S=false;}else if(j>0){var l=P.getViewAt(j-1);var m=l.getViewData().oPropertyTypeData.sContext;if(k!==m){S=false;}}C.byId("idAddPropertyIcon").setVisible(s);C.byId("idRemovePropertyIcon").setVisible(S);}function h(C){C.byId("idAddPropertyIcon").attachEvent(c.SETFOCUSONADDICON,C.setFocusOnAddRemoveIcons.bind(C));}var i=sap.ui.core.mvc.Controller.extend("sap.apf.modeler.ui.controller.propertyType",{_apfName:"propertyType",oConfigurationEditor:{},oRepresentation:{},oStepPropertyMetadataHandler:{},oRepresentationTypeHandler:{},oTextReader:{},oTextPool:{},initPromise:null,onInit:function(){var C=this;C.initPromise=new jQuery.Deferred();C.oConfigurationEditor=C.getView().getViewData().oConfigurationEditor;C.oRepresentation=C.getView().getViewData().oParentObject;C.oStepPropertyMetadataHandler=C.getView().getViewData().oStepPropertyMetadataHandler;C.oRepresentationTypeHandler=C.getView().getViewData().oRepresentationTypeHandler;C.oTextReader=C.getView().getViewData().oCoreApi.getText;C.oTextPool=C.getView().getViewData().oTextPool;if(C.getView().getViewData().oPropertyTypeData.bMandatory){C.getView().getViewData().oViewValidator.addField(C.byId("idPropertyType").getId());C.byId("idPropertyTypeLabel").setRequired(true);}b(C).then(function(){C.setDetailData().then(function(){C.initPromise.resolve();});});},onAfterRendering:function(){var C=this;C.initPromise.then(function(){C.enableDisableLabelDisplayOptionTypeAsPromise().then(function(){C.byId("idAddPropertyIcon").fireEvent(c.SETFOCUSONADDICON);});});},setDetailData:function(){var j=jQuery.Deferred();var C=this;C.setLabelDisplayOptionTypeAsPromise(o).then(function(){if(!C.byId("idPropertyType")){j.resolve();return;}e(C);a(C);d(C);_(C);f(C);g(C);j.resolve();});return j.promise();},handleChangeForPropertyTypeAsPromise:function(j){var C=this;var k=jQuery.Deferred();var s=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(M.texts.NOTAVAILABLE));var p=C.getView().getViewData().oPropertyOrchestration;var v=C.getView().getId();var l;var m=null;if(p){l=p.isSwapCase(v,s);m=p.getPropertyTypeRowByPropertyName(s);p.updateAllSelectControlsForPropertyType(v,s).then(function(){var q;C.updateRepresentationAndView().then(function(){if(l){q=m.oView.getController();q.updateRepresentationAndView().then(function(){C.oConfigurationEditor.setIsUnsaved();k.resolve();});}else{C.oConfigurationEditor.setIsUnsaved();k.resolve();}});});}else{C.forceFailSinceOrchestrationIsMissing();k.resolve()}return k.promise();},updateRepresentationAndView:function(){var C=this;return new Promise(function(r){C.updateOfConfigurationObjectAsPromise().then(function(){C.setDetailData();C.enableDisableLabelDisplayOptionTypeAsPromise().then(function(){r();});});});},handleChangeForLabelDisplayOptionType:function(){var C=this;var l=C.byId("idLabelDisplayOptionType").getSelectedKey();C.changeLabelDisplayOption(l);C.oConfigurationEditor.setIsUnsaved();},handleChangeForLabelText:function(){var C=this,l;var L=C.byId("idPropertyLabelText").getValue();var p=t.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(M.texts.NOTAVAILABLE));if(L.trim().length===0){l=undefined;C.setPropertyTextLabelKey(p,l);d(C);e(C);C.oConfigurationEditor.setIsUnsaved();}else{C.getView().getViewData().oConfigurationHandler.getTextPool().setTextAsPromise(L,T).then(function(l){C.setPropertyTextLabelKey(p,l);d(C);e(C);C.oConfigurationEditor.setIsUnsaved();});}},setFocusOnAddRemoveIcons:function(){var C=this;C.byId("idAddPropertyIcon").focus();},handlePressOfAddPropertyIcon:function(){var C=this;var v=C.getView();var p=v.getViewData().oPropertyOrchestration;var j=C.byId("idPropertyType").getItems();var s=C.byId("idPropertyType").getSelectedKey();var k=C.oTextReader("none");if(this._shallAddPropertyBeHandled(j,s,k,p)){h(C);C.getView().fireEvent(M.events.ADDPROPERTY,{"oSourceView":v});C.oConfigurationEditor.setIsUnsaved();}},handlePressOfRemovePropertyIcon:function(){var C=this;var v=C.getView().getViewData();var p=v.oPropertyTypeState;var j=p.indexOfPropertyTypeViewId(C.getView().getId());if(j>0){var P=p.getViewAt(j-1);h(P.getController());}var k=v.oPropertyOrchestration;k.removePropertyTypeReference(C.getView().getId());return C.updateRepresentationAndView().then(function(){k.updateAllSelectControlsForPropertyType();v.oPropertyTypeHandlerBackLink.handlePressOfRemove({oSourceView:C.getView()});C.oConfigurationEditor.setIsUnsaved();C.getView().destroy();});},updateOfConfigurationObjectAsPromise:function(){var C=this;return new Promise(function(r){var p=[];if(C.getView().getViewData().oPropertyOrchestration){p=C.getView().getViewData().oPropertyOrchestration.getPropertyInformationList();C.updatePropertiesInConfiguration(p);}else{C.forceFailSinceOrchestrationIsMissing();}r();});},handleSuggestions:function(E){var C=this;var s=new sap.apf.modeler.ui.utils.SuggestionTextHandler(C.oTextPool);s.manageSuggestionTexts(E,T);},getSelectedProperty:function(){var C=this;var p=C.getView().getViewData().oPropertyTypeState;var j=p.getPropertyValueState();var k=p.indexOfPropertyTypeViewId(C.getView().getId());return j[k];},removeAllItemsFromDropDownList:function(){var C=this;var v=C.byId("idPropertyType");v.getItems().forEach(function(I){v.removeItem(I);});},setItemsOfDropDownList:function(C,A,s,m,j){function k(r,u){return r.indexOf(u)!==-1;}var l=this;var v=l.byId("idPropertyType");var p=[];var q=(s===l.oTextReader("none"));if(!m&&j===M.aggregationRoles.DIMENSION){v.addItem(new sap.ui.core.Item({key:l.oTextReader("none"),text:l.oTextReader("none")}));}if(j===M.aggregationRoles.MEASURE){p=JSON.parse(JSON.stringify(A));}else{p=JSON.parse(JSON.stringify(C));}if(!k(p,s)&&!q){p.unshift(s);}p.forEach(function(V){var u=V;if(!k(A,V)&&!q&&V!==""){V=t.addPrefixText([V],l.oTextReader)[0];}var I=new sap.ui.core.Item({key:V,text:V});v.addItem(I);if(u===s){s=V;}});v.setSelectedKey(s);},updatePropertiesInConfiguration:function(p){},createNewPropertyInfoAsPromise:function(s){return sap.apf.utils.createPromise();},setPropertyInParentObject:function(){},setLabelDisplayOptionTypeAsPromise:function(o){return sap.apf.utils.createPromise();},getAllPropertiesAsPromise:function(){return sap.apf.utils.createPromise();},getPropertyTextLabelKey:function(p){},setPropertyTextLabelKey:function(p,l){},enableDisableLabelDisplayOptionTypeAsPromise:function(){return sap.apf.utils.createPromise();},removePropertyFromParentObject:function(){},addPropertyAsPromise:function(){return sap.apf.utils.createPromise();},changeLabelDisplayOption:function(l){},_shallAddPropertyBeHandled:function(j,s,k,p){var l=j.filter(function(u){return u.mProperties.key!==k;});if(p&&p.getAggregationRole()===M.aggregationRoles.MEASURE){var m=p._getPropertyTypeRows().length;return(m<l.length);}if(j.length===0||!s){return false;}var q=l.filter(function(u){return u.mProperties.key!==s;});var r=(s===k);if(q.length<2&&r){return false;}else if(q.length<1&&!r){return false;}return true;}});return i;},true);
