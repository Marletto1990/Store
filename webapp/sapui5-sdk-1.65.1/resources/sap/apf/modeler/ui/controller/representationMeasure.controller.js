/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(["sap/apf/modeler/ui/controller/propertyType","sap/apf/modeler/ui/utils/displayOptionsValueBuilder","sap/apf/modeler/ui/utils/textManipulator","sap/apf/core/constants"],function(B,D,t,c){"use strict";D=D||sap.apf.modeler.ui.utils.DisplayOptionsValueBuilder;var T=sap.apf.modeler.ui.utils.textManipulator;B.extend("sap.apf.modeler.ui.controller.representationMeasure",{setLabelDisplayOptionTypeAsPromise:function(o){var C=this;var p=C.getView().getViewData().oPropertyTypeData.sProperty;if(!C.oRepresentationTypeHandler.isCombinationChart(C.oRepresentation.getRepresentationType())){if(C.byId("idLabelDisplayOptionType")){C.byId("idLabelDisplayOptionType").destroy();C.byId("idPropertyTypeLayout").setSpan("L4 M4 S4");C.oRepresentation.setMeasureDisplayOption(p,undefined);}}else{var d=new D(C.oTextReader,o);var m=d.getMeasureDisplayOptions();C.byId("idLabelDisplayOptionType").setModel(m);var a=C.oRepresentation.getMeasureDisplayOption(p);if(!a){var b=C.getView().getViewData().oPropertyTypeData.bMandatory?c.representationMetadata.measureDisplayOptions.BAR:c.representationMetadata.measureDisplayOptions.LINE;C.byId("idLabelDisplayOptionType").setSelectedKey(b);C.oRepresentation.setMeasureDisplayOption(p,b);}else{C.byId("idLabelDisplayOptionType").setSelectedKey(a);}}return jQuery.Deferred().resolve();},changeLabelDisplayOption:function(n){var C=this;var p=C.getView().getViewData().oPropertyTypeData.sProperty;C.oRepresentation.setMeasureDisplayOption(p,n);},getAllPropertiesAsPromise:function(){var C=this,a,s,p,A,m=[];var S=C.oStepPropertyMetadataHandler.oStep;var o=sap.apf.modeler.ui.utils.CONSTANTS;var d=jQuery.Deferred();C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().done(function(e){S.getConsumablePropertiesForRepresentation(C.oRepresentation.getId()).done(function(r){a=r.consumable;a.forEach(function(P){if(C.oStepPropertyMetadataHandler.getPropertyMetadata(e,P)){A=C.oStepPropertyMetadataHandler.getPropertyMetadata(e,P)["aggregation-role"];if(A===o.aggregationRoles.MEASURE){m.push(P);}}});s=C.getSelectedProperty();if(s!==undefined){p=m.indexOf(s)!==-1?m:m.concat(s);m=r.available.indexOf(s)!==-1?p:m.concat(T.addPrefixText([s],C.oTextReader));s=r.available.indexOf(s)!==-1?s:T.addPrefixText([s],C.oTextReader)[0];}d.resolve({aAllProperties:m,sSelectedKey:s});});});return d.promise();},getPropertyTextLabelKey:function(p){var C=this;return C.oRepresentation.getMeasureTextLabelKey(p);},updatePropertiesInConfiguration:function(p){var C=this;C.oRepresentation.getMeasures().forEach(function(m){C.oRepresentation.removeMeasure(m);});p.forEach(function(P){C.oRepresentation.addMeasure(P.sProperty);C.oRepresentation.setMeasureKind(P.sProperty,P.sKind);C.oRepresentation.setMeasureTextLabelKey(P.sProperty,P.sTextLabelKey);C.oRepresentation.setMeasureDisplayOption(P.sProperty,P.sMeasureDisplayOption);});},createNewPropertyInfoAsPromise:function(n){var C=this,N={};N.sProperty=n;N.sKind=C.getView().getViewData().oPropertyTypeData.sContext;N.sTextLabelKey=undefined;return sap.apf.utils.createPromise(N);},setPropertyTextLabelKey:function(p,l){var C=this;C.oRepresentation.setMeasureTextLabelKey(p,l);},setNextPropertyInParentObject:function(){var C=this;C.updateOfConfigurationObjectAsPromise().then(function(){C.setDetailData();});},removePropertyFromParentObject:function(){var C=this;C.oRepresentation.removeMeasure(T.removePrefixText(C.byId("idPropertyType").getSelectedKey(),C.oTextReader(sap.apf.modeler.ui.utils.CONSTANTS.texts.NOTAVAILABLE)));},addPropertyAsPromise:function(){var d=jQuery.Deferred();var C=this,a,m=[];var s=C.oStepPropertyMetadataHandler.oStep;var o=sap.apf.modeler.ui.utils.CONSTANTS;C.oStepPropertyMetadataHandler.getEntityTypeMetadataAsPromise().done(function(e){s.getConsumablePropertiesForRepresentation(C.oRepresentation.getId()).done(function(r){r.consumable.forEach(function(p){if(C.oStepPropertyMetadataHandler.getPropertyMetadata(e,p)){a=C.oStepPropertyMetadataHandler.getPropertyMetadata(e,p)["aggregation-role"];if(a===o.aggregationRoles.MEASURE){m.push(p);}}});C.getView().fireEvent(o.events.ADDPROPERTY,{"sProperty":m[0],"sContext":C.getView().getViewData().oPropertyTypeData.sContext});C.oConfigurationEditor.setIsUnsaved();d.resolve();});});return d.promise();}});});
