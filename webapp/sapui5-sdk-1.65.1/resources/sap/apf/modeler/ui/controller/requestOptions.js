/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP AG. All rights reserved
 */
sap.ui.define(['sap/apf/modeler/ui/utils/nullObjectChecker','sap/apf/modeler/ui/utils/optionsValueModelBuilder','sap/apf/modeler/ui/utils/textManipulator','sap/apf/modeler/ui/utils/textPoolHelper','sap/apf/modeler/ui/utils/viewValidator','sap/apf/modeler/ui/utils/constants'],function(n,o,t,a,V,m){"use strict";function _(C){C.byId("idSource").attachEvent("selectService",C.handleSelectionOfService.bind(C));}function b(C){var d=jQuery.Deferred();C.setLabelDisplayOptionTypeAsPromise(o).done(function(){if(!C.byId("idOptionalRequestField")){d.resolve();}else{C.enableDisableLabelDisplayOptionTypeAsPromise().done(function(){d.resolve();});}});return d;}var c=sap.ui.core.mvc.Controller.extend("sap.apf.modeler.ui.controller.requestOptions",{viewValidator:{},oConfigurationEditor:{},oParentObject:{},oStepPropertyMetadataHandler:{},initPromise:{},onInit:function(){var C=this;this.initPromise=jQuery.Deferred();var T=C.getView().getViewData().oConfigurationHandler.getTextPool();C.oSuggestionTextHandler=new a.SuggestionTextHandler(T);C.viewValidator=new V(C.getView());C.oConfigurationEditor=C.getView().getViewData().oConfigurationEditor;C.oParentObject=C.getView().getViewData().oParentObject;C.oStepPropertyMetadataHandler=C.getView().getViewData().oStepPropertyMetadataHandler;C.setDetailData();C.setDisplayText();_(C);},setDetailData:function(){var C=this;C.setSource();C.setEntityAsPromise().done(function(){C.setOptionalHierarchicalProperty();C.setSelectProperties().done(function(){C.setOptionalRequestFieldProperty();b(C).done(function(){C.initPromise.resolve();});});});},setSource:function(){var C=this;var s=C.getSource();C.byId("idSource").setValue("");C.setValidationStateForService();if(!n.checkIsNotNullOrUndefinedOrBlank(s)){C.addOrRemoveMandatoryFieldsAndRequiredFlag(false);return;}C.byId("idSource").setValue(s);C.addOrRemoveMandatoryFieldsAndRequiredFlag(true);},setEntityAsPromise:function(){var C=this;var d=jQuery.Deferred();var M,s,e,v;s=C.byId("idSource").getValue();C.byId("idEntity").setModel(null);C.byId("idEntity").clearSelection();if(!n.checkIsNotNullOrUndefinedOrBlank(s)){d.resolve();return d.promise();}C.getAllEntitiesAsPromise(s).done(function(A){e=C.getEntity();if(n.checkIsNotNullOrUndefinedOrBlank(e)){v=C.validateSelectedValues(C,[e],A);A=v.aValues;e=v.aSelectedValues[0];}M=o.convert(A);C.byId("idEntity").setModel(M);if(!n.checkIsNotNullOrUndefinedOrBlank(e)||A.indexOf(e)===-1){C.getAllEntitiesAsPromise(s).done(function(f){e=f[0];if(n.checkIsNotNullOrUndefinedOrBlank(e)){C.byId("idEntity").setSelectedKey(e);}d.resolve();});}else if(n.checkIsNotNullOrUndefinedOrBlank(e)){C.byId("idEntity").setSelectedKey(e);d.resolve();}});return d.promise();},setSelectProperties:function(){var d=jQuery.Deferred();var C=this;var s,e,S,M,v=[];var T=C.getView().getViewData().oTextReader;s=C.byId("idSource").getValue();var i=C.getIdOfPropertiesControl();C.byId(i).setModel(null);C.byId(i).clearSelection();e=t.removePrefixText(C.byId("idEntity").getSelectedKey(),T(m.texts.NOTAVAILABLE));C.getAllEntitySetPropertiesAsPromise(s,e).done(function(p){S=C.getSelectProperties();if(n.checkIsNotNullOrUndefinedOrBlank(S)){v=C.validateSelectedValues(C,S,p);p=v.aValues;S=v.aSelectedValues;}M=o.convert(p);C.byId(i).setModel(M);C.setSelectedKeysForProperties(S);d.resolve();});return d;},updateSubViewInstancesOnReset:function(e){var C=this;C.oConfigurationEditor=e.getParameter("oConfigurationEditor");C.oParentObject=e.getParameter("oParentObject");C.setDetailData();},setDisplayText:function(){},handleChangeForSourceAsPromise:function(e){var d=jQuery.Deferred();var C=this,E,s;var S=C.byId("idSource").getValue().trim();var T=C.getView().getViewData().oTextReader;C.setValidationStateForService();if(!n.checkIsNotNullOrUndefinedOrBlank(S)){C.clearSource();C.addOrRemoveMandatoryFieldsAndRequiredFlag(false);C.setEntityAsPromise(C).done(function(){E=t.removePrefixText(C.byId("idEntity").getSelectedKey(),T(m.texts.NOTAVAILABLE));C.updateEntity(E);C.setSelectProperties();s=C.getSelectedKeysForProperties();C.updateSelectProperties(s);C.setOptionalHierarchicalProperty().done(function(){var h=t.removePrefixText(C.byId("idOptionalProperty").getSelectedKey(),T(m.texts.NOTAVAILABLE));C.updateHierarchicalProperty(h);C.setOptionalRequestFieldProperty();C.oConfigurationEditor.setIsUnsaved();C.fireRelevantEvents(e);d.resolve();});});}else{C.oConfigurationEditor.registerServiceAsPromise(S).done(function(r){C.getAllEntitiesAsPromise(S).done(function(f){if(r){C.addOrRemoveMandatoryFieldsAndRequiredFlag(true);C.updateSource(S);if(!n.checkIsNotNullOrUndefinedOrBlank(f)){var v={sValueState:sap.ui.core.ValueState.Error,sValueStateText:T("hierarchicalServiceError")};C.setValidationStateForService(v);C.resetEntityAndProperties();return;}}else{C.clearSource();C.addOrRemoveMandatoryFieldsAndRequiredFlag(false);}C.setEntityAsPromise(C).done(function(){E=t.removePrefixText(C.byId("idEntity").getSelectedKey(),T(m.texts.NOTAVAILABLE));C.updateEntity(E);C.setSelectProperties();s=C.getSelectedKeysForProperties();C.updateSelectProperties(s);C.setOptionalHierarchicalProperty().done(function(){var h=t.removePrefixText(C.byId("idOptionalProperty").getSelectedKey(),T(m.texts.NOTAVAILABLE));C.updateHierarchicalProperty(h);C.setOptionalRequestFieldProperty();C.oConfigurationEditor.setIsUnsaved();C.fireRelevantEvents(e);d.resolve();});});});});}return d.promise();},handleChangeForEntity:function(e){var C=this,E,s;var T=C.getView().getViewData().oTextReader;E=t.removePrefixText(C.byId("idEntity").getSelectedKey(),T(m.texts.NOTAVAILABLE));C.updateEntity(E);C.setSelectProperties();s=C.getSelectedKeysForProperties();C.updateSelectProperties(s);C.setOptionalHierarchicalProperty();var h=t.removePrefixText(C.byId("idOptionalProperty").getSelectedKey(),T(m.texts.NOTAVAILABLE));C.updateHierarchicalProperty(h);C.setOptionalRequestFieldProperty();C.oConfigurationEditor.setIsUnsaved();C.fireRelevantEvents(e);},handleChangeForSelectProperty:function(e){var C=this;var s=C.getSelectedKeysForProperties();C.updateSelectProperties(s);C.setOptionalRequestFieldProperty();b(C);C.oConfigurationEditor.setIsUnsaved();C.fireRelevantEvents(e);},handleChangeForOptionalRequestField:function(e){var C=this;var T=C.getView().getViewData().oTextReader;var f=[t.removePrefixText(C.byId("idOptionalRequestField").getSelectedKey(),T(m.texts.NOTAVAILABLE))];C.updateOptionalRequestFieldProperty(f);b(C);C.oConfigurationEditor.setIsUnsaved();C.fireRelevantEvents(e);},handleChangeForOptionalLabelDisplayOptionType:function(){var C=this;var l=C.byId("idOptionalLabelDisplayOptionType").getSelectedKey();C.changeLabelDisplayOption(l);C.oConfigurationEditor.setIsUnsaved();},handleChangeForOptionalSelectedPropertyLabelText:function(){var C=this;var l=C.byId("idOptionalSelectedPropertyLabelText").getValue();C.changeOptionalSelectedPropertyLabelText(l);C.oConfigurationEditor.setIsUnsaved();},handleSuggestionsForSource:function(e){var C=this;var E=C.oConfigurationEditor.getAllServices();C.oSuggestionTextHandler.manageSuggestions(e,E);},fireRelevantEvents:function(){},addOrRemoveMandatoryFieldsAndRequiredFlag:function(r){var C=this;C.byId("idEntityLabel").setRequired(r);C.byId(C.getIdOfPropertyLabel()).setRequired(r);if(r){C.viewValidator.addFields(["idEntity",C.getIdOfPropertiesControl()]);}else{C.viewValidator.removeFields(["idEntity",C.getIdOfPropertiesControl()]);}},handleSelectionOfService:function(e){var s=e.getParameter("sSelectedService");e.getSource().setValue(s);e.getSource().fireEvent("change");},handleShowValueHelpRequest:function(e){var C=this;var E={oTextReader:C.getView().getViewData().oTextReader,parentControl:e.getSource(),getCalatogServiceUri:C.getView().getViewData().getCalatogServiceUri};var v=C.getView().getViewData();var s;if(v.oCoreApi&&(s=v.oCoreApi.getGenericExit("showValueHelp"))){s(E,v.oCoreApi,this);}else{sap.ui.view({id:C.createId("idCatalogServiceView"),viewName:"sap.apf.modeler.ui.view.catalogService",type:sap.ui.core.mvc.ViewType.XML,viewData:E});}},getNonCommonValues:function(e,T){var N=[];if(!n.checkIsNotNullOrUndefined(e)){return N;}N=e.filter(function(p){return T.indexOf(p)===-1;});return N;},validateSelectedValues:function(C,s,A){var v={},i=[],d=[],I=[],e=[],f;var T=C.getView().getViewData().oTextReader;v=sap.apf.utils.validateSelectedValues(s,A);i=v.invalid;d=v.valid;I=t.addPrefixText(i,T);e=I.concat(A).length!==0?I.concat(A):A;f=I.concat(d).length!==0?I.concat(d):s;return{aValues:e,aSelectedValues:f};},handleSuggestionsForSelectedPropertyLabel:function(e){this.oSuggestionTextHandler.manageSuggestionTexts(e,a.TranslationFormatMap.STEPFILTERPROPERTY_LABEL);},resetEntityAndProperties:function(){},setOptionalRequestFieldProperty:function(){},setOptionalHierarchicalProperty:function(){return jQuery.Deferred().resolve();},getIdOfPropertiesControl:function(){return"idSelectProperties";},getIdOfPropertyLabel:function(){return"idSelectPropertiesLabel";},setSelectedKeysForProperties:function(p){var C=this;C.byId("idSelectProperties").setSelectedKeys(p);},getSelectedKeysForProperties:function(){var C=this,s=[],S=[];var T=C.getView().getViewData().oTextReader;s=C.byId("idSelectProperties").getSelectedKeys();s.forEach(function(k){S.push(t.removePrefixText(k,T(m.texts.NOTAVAILABLE)));});return S;},setValidationStateForService:function(v){var C=this;var d={sValueState:sap.ui.core.ValueState.None,sValueStateText:""};var e=v?v:d;C.byId("idSource").setValueState(e.sValueState);C.byId("idSource").setValueStateText(e.sValueStateText);},getSource:function(){},updateSource:function(s){},clearSource:function(){},getAllEntitiesAsPromise:function(s){return sap.apf.utils.createPromise();},getEntity:function(){},updateEntity:function(e){},clearEntity:function(){},getAllEntitySetPropertiesAsPromise:function(s,e){return sap.apf.utils.createPromise();},setLabelDisplayOptionTypeAsPromise:function(o){return sap.apf.utils.createPromise();},enableDisableLabelDisplayOptionTypeAsPromise:function(){return sap.apf.utils.createPromise();},getSelectProperties:function(){},updateSelectProperties:function(s){},clearSelectProperties:function(){},removeSelectProperties:function(p){},getOptionalRequestFieldProperty:function(){},updateOptionalRequestFieldProperty:function(f){},updateHierarchicalProperty:function(h){},clearOptionalRequestFieldProperty:function(){},removeOptionalRequestFieldProperty:function(p){},changeLabelDisplayOption:function(l){},changeOptionalSelectedPropertyLabelText:function(l){},handleChangeForOptionalProperty:function(){}});return c;},true);
