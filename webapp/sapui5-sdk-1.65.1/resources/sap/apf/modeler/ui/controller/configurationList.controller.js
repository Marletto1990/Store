/*!
* SAP APF Analysis Path Framework
*
* (c) Copyright 2012-2014 SAP SE. All rights reserved
*/
(function(){'use strict';jQuery.sap.require("sap.apf.modeler.ui.utils.textPoolHelper");jQuery.sap.require('sap.apf.modeler.ui.utils.navigationHandler');jQuery.sap.require('sap.apf.modeler.ui.utils.helper');jQuery.sap.require('sap.apf.modeler.ui.utils.APFTree');jQuery.sap.require('sap.ui.core.util.File');sap.ui.controller("sap.apf.modeler.ui.controller.configurationList",{onInit:function(){var c=this.getOwnerComponent();if(c!==undefined){this.oCoreApi=c.oCoreApi;this._setDisplayText();this._setPublishVisible();}this._instantiateToolbarView();this._instantiateAPFTree();this._instantiateTitleAndBreadCrumbView();this._addConfigStyleClass();this.oModel=new sap.ui.model.json.JSONModel({aConfigDetails:[]});this.getView().setModel(this.oModel);this.bProgramaticSelection=false;this.modelUpdateDeferred={};sap.apf.modeler.ui.utils.APFRouter.patternMatch(this);},_instantiateToolbarView:function(){var t=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.toolbar",type:"XML",viewData:{oConfigListInstance:this}});this.toolbarController=t.getController();this.byId("idConfigMasterData").insertItem(t,0);},_instantiateAPFTree:function(){this.oTreeInstance=this.byId("idConfigTree");this.oTreeInstance.setTranslationFunction(this.oCoreApi.getText);var d;if(this.oCoreApi.getRepresentationTypes()[0].metadata){d=this.oCoreApi.getRepresentationTypes()[0].id;}this.oTreeInstance.setDefaultRepresentationType(d);},_instantiateTitleAndBreadCrumbView:function(){this.oTitleBreadCrumbView=new sap.ui.view({viewName:"sap.apf.modeler.ui.view.titleBreadCrumb",type:"XML",viewData:{getText:this.oCoreApi.getText}});this.oTitleBreadCrumbController=this.oTitleBreadCrumbView.getController();this.byId("idConfigDetail").insertItem(this.oTitleBreadCrumbView,0);this.oBreadCrumb=this.oTitleBreadCrumbView.byId("IdBreadCrumb");},setConfigListMasterTitle:function(t){this.byId("idConfigTitleMaster").setText(this.oCoreApi.getText("configurationObjectTitle")+" : "+t);},onAfterRendering:function(){var s=this;this.oTreeInstance.onAfterRendering=function(){s._setHeightForTree();};},_setHeightForTree:function(){var v=this;var t=this.oTreeInstance;var w=jQuery(v.byId("idConfigMasterData").getDomRef()).width();var h=jQuery(window).height();var a=100;var b=jQuery(v.byId("idConfigMasterData").getItems()[0].getDomRef()).height();var c=jQuery(v.byId("configPage").getDomRef()).find("header").height();var f=jQuery(v.byId("configPage").getDomRef()).find("footer").height();var o;if(b>0){o=a+b+c+f;}else{o=205;}t.setHeight(h-o+"px");t.setWidth(w+"px");sap.apf.modeler.ui.utils.helper.onResize(function(){w=jQuery(v.byId("idConfigMasterData").getDomRef()).width();h=jQuery(v.byId("configPage").getDomRef()).height();t.setHeight(h-o+"px");t.setWidth(w+"px");});},_setDisplayText:function(){this.byId("configPage").setTitle(this.oCoreApi.getText("configModelerTitle"));this.byId("idSavebutton").setText(this.oCoreApi.getText("save"));this.byId("idCancelbutton").setText(this.oCoreApi.getText("cancel"));this.byId("idExportbutton").setText(this.oCoreApi.getText("export"));this.byId("idExecuteButton").setText(this.oCoreApi.getText("execute"));this.byId("idPublishbutton").setText(this.oCoreApi.getText("share"));this.byId("idAriaPropertyForBreadCrumb").setText(this.oCoreApi.getText("breadCrumbText"));},_setPublishVisible:function(){var v=this.oCoreApi&&this.oCoreApi.isUsingCloudFoundryProxy()&&this.oCoreApi.getGenericExit("publishTileDialog")?true:false;this.byId("idPublishbutton").setVisible(v);},_addConfigStyleClass:function(){this.getView().addStyleClass("sapUiSizeCompact");this.byId("idConfigTree").addStyleClass("configTree");this.byId("idConfigTitleMaster").addStyleClass("configTitle");this.byId("idConfigMasterData").addStyleClass("configMasterData");this.byId("idConfigDetailData").addStyleClass("configDetailData");},_setSubViewContainerHeight:function(s){var S=this;var a=s.getContent()[0].getItems()[0];var h=jQuery(window).height();var t=jQuery(this.byId("idConfigTitleMaster").getDomRef()).outerHeight()+jQuery(this.byId("idConfigTitleMaster").getDomRef()).offset().top+25;var b=jQuery(this.byId("idConfigMasterData").getItems()[0].getDomRef()).height();var c=jQuery(this.byId("configPage").getDomRef()).find("header").height();var f=jQuery(this.byId("configPage").getDomRef()).find("footer").height();var o,d;if(b>0){o=t+b+c+f;}else{o=265;}var e=h-o-40+"px";a.setHeight(e);var g=jQuery(this.byId("idConfigDetailData").getDomRef()).width();if(g>0){d=jQuery(this.byId("idConfigMasterData").getDomRef()).offset().left;}else{g=1015;d=15;}var i=g-d;var j=i+"px";a.setWidth(j);sap.apf.modeler.ui.utils.helper.onResize(function(){h=jQuery(S.byId("configPage").getDomRef()).height();e=h-o+"px";a.setHeight(e);g=jQuery(S.byId("idConfigDetailData").getDomRef()).width();i=g-d;j=i+"px";a.setWidth(j);});},_setSubView:function(s){this.oSubView=s;},_getSubView:function(){return this.oSubView;},updateSubView:function(p){var s=this;var P=this._getSubView();var d=this.byId("idConfigDetailData");var v=this.getSPathFromURL(p);this.configurationHandler.memorizeConfiguration(p.arguments.configId);if(P){P.destroy();}if(p.arguments.configId.indexOf("newConfig")===0){this.modelUpdateDeferred[this.byId("idConfigTree").getModel().getData().aConfigDetails.length-1]=new jQuery.Deferred();}var S=new sap.ui.view({viewName:"sap.apf.modeler.ui.view."+v.objectType,type:"XML",viewData:{oParams:p,oCoreApi:s.oCoreApi,updateConfigTree:s.updateConfigTree.bind(s),updateSelectedNode:s.updateSelectedNode.bind(s),updateTitleAndBreadCrumb:s.updateTitleAndBreadCrumb.bind(s),updateTree:s.updateTree.bind(s),oConfigurationHandler:s.configurationHandler,oApplicationHandler:s.applicationHandler,oConfigurationEditor:s.configEditor,getText:s.oCoreApi.getText,getEntityTypeMetadataAsPromise:s.oCoreApi.getEntityTypeMetadataAsPromise,getRepresentationTypes:s.oCoreApi.getRepresentationTypes,oFooter:s.byId("idFooterBarMain"),createMessageObject:s.oCoreApi.createMessageObject,putMessage:s.oCoreApi.putMessage,getAllAvailableSemanticObjects:s.oCoreApi.getAllAvailableSemanticObjects,getSemanticActions:s.oCoreApi.getSemanticActions,getNavigationTargetName:s._getNavigationTargetName.bind(s),setNavigationTargetName:s._setNavigationTargetName.bind(s),getCalatogServiceUri:s.oCoreApi.getCatalogServiceUri,oTitleBreadCrumbController:s.oTitleBreadCrumbController}});if(p.name!=="applicationList"){d.removeAllContent();S.placeAt(d);this._setSubViewContainerHeight(S);this._setSubView(S);}},clearTitleAndBreadCrumb:function(){this.oTitleBreadCrumbView.byId("IdFormTitle").setText("");this.oTitleBreadCrumbView.byId("IdBreadCrumb").destroyContent();},_createLinkForBreadCrumb:function(n,i,p){var c=this;var l=new sap.m.Link({text:n,id:c.createId("linkId"+i),press:function(){c._navigateToNode(p);}});l.addAriaDescribedBy(c.byId("idAriaPropertyForBreadCrumb"));return l;},_createTextForBreadCrumb:function(v,i){var c=this;var l=new sap.m.Label({id:c.createId("textId"+i)});l.addStyleClass("dialogText");l.setText(v);return l;},_createIconForBreadCrumb:function(){var b=new sap.ui.core.Icon({src:"sap-icon://open-command-field"});b.addStyleClass("breadCrumbIcon");return b;},_navigateToNode:function(p){var c=this.oTreeInstance.getModel().getContext(p);var n=this.oTreeInstance.getNodeByContext(c);this.oTreeInstance.setSelection(n);},_getAllPossibleNodes:function(p){var n=[];if(p.configId){n.push({id:p.configId,name:p.configurationName,oParams:{arguments:{configId:p.configId}}});}if(p.facetFilterId){n.push({id:p.facetFilterId,name:p.facetFilterName,oParams:{arguments:{configId:p.configId,facetFilterId:p.facetFilterId}}});}if(p.smartFilterId){n.push({id:p.smartFilterId,name:p.smartFilterName,oParams:{arguments:{configId:p.configId,smartFilterId:p.smartFilterId}}});}if(p.categoryId){n.push({id:p.categoryId,name:p.categoryName,oParams:{arguments:{configId:p.configId,categoryId:p.categoryId}}});}if(p.stepId){n.push({id:p.stepId,name:p.stepName,oParams:{arguments:{configId:p.configId,categoryId:p.categoryId,stepId:p.stepId}}});}if(p.representationId){n.push({id:p.representationId,name:p.representationName,oParams:{arguments:{configId:p.configId,categoryId:p.categoryId,stepId:p.stepId,representationId:p.representationId}}});}if(p.navTargetId){n.push({id:p.navTargetId,name:p.navTargetName,oParams:{arguments:{configId:p.configId,navTargetId:p.navTargetId}}});}return n;},_breadCrumbCreation:function(s,t){for(var i=0;i<s.length;i++){var p=this.getSPathFromURL(s[i].oParams).sPath;var l;if(i===1){l=this._createTextForBreadCrumb(t,i);this.oBreadCrumb.addContent(l);var I=this._createIconForBreadCrumb();this.oBreadCrumb.addContent(I);}if(i!==s.length-1){var L=this._createLinkForBreadCrumb(s[i].name,i,p);this.oBreadCrumb.addContent(L);var o=this._createIconForBreadCrumb();this.oBreadCrumb.addContent(o);}if(i===s.length-1){l=this._createTextForBreadCrumb(s[i].name,++i);this.oBreadCrumb.addContent(l);}}},updateTitleAndBreadCrumb:function(t){var f;var s=this.oTreeInstance.getSelection();var S=s?this.oTreeInstance.getAPFTreeNodeContext(s):undefined;var n=S?S.nodeObjectType:undefined;var p=S?this.oTreeInstance.getParentNodeContext(S):undefined;if(t){f=t;}else{if(n){var a=s.getText();f=this.oCoreApi.getText(n)+": "+a;if(n===sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.SMARTFILTERBAR){f=a;}}}if(p){if(this.oBreadCrumb){this.oBreadCrumb.destroyContent();}var o=this._getAllPossibleNodes(p);var T;switch(n){case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION:this._breadCrumbCreation(o);break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.SMARTFILTERBAR:case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.FACETFILTER:T=this.oCoreApi.getText("facetFilter");this._breadCrumbCreation(o,T);break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY:T=this.oCoreApi.getText("category");this._breadCrumbCreation(o,T);break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.STEP:T=this.oCoreApi.getText("category");this._breadCrumbCreation(o,T);break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.REPRESENTATION:T=this.oCoreApi.getText("category");this._breadCrumbCreation(o,T);break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.NAVIGATIONTARGET:T=this.oCoreApi.getText("navigationTarget");this._breadCrumbCreation(o,T);break;default:break;}}if(n!==sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.STEP){this.oTitleBreadCrumbController.setTitleForDetailPage(f);}},setSelectionOnTree:function(v){if(v.objectType==="smartFilterBar"){this.toolbarController.disableCopyDeleteButton();}else{this.toolbarController.enableCopyDeleteButton();}this._enableDisableExportAndExecuteButton(true);this.oTreeInstance.setSelectionOnTree(v.sPath);},removeSelectionOnTree:function(){this.oTreeInstance.removeSelectionOnTree(this.selectedNode);},updateConfigTree:function(o){var a,n,O,i,b,c,d,e,f;var s=this;o.forEach(function(S){var h;a=s.getSPathFromURL(S.oldContext).sPath;O=a.split("/");i=O[2];b=O[6];d=O[8];e=jQuery.extend(true,{},s.oModel.getData().aConfigDetails[i].configData[1].categories[b].steps[d]);f=e.id;e.isSelected=false;n=s.getSPathFromURL(S.newContext).sPath;c=n.split("/")[6];if(S.removeStep===undefined){if(s.oModel.getData().aConfigDetails[i].configData[1].categories[c].steps){s.oModel.getData().aConfigDetails[i].configData[1].categories[c].steps.forEach(function(p){if(p.id===f){h=true;}});if(h===undefined){s.oModel.getData().aConfigDetails[i].configData[1].categories[c].steps.push(e);}}else{s.oModel.getData().aConfigDetails[i].configData[1].categories[c].steps=[];s.oModel.getData().aConfigDetails[i].configData[1].categories[c].steps.push(e);}}else if(S.removeStep===true){if(s.oModel.getData().aConfigDetails[i].configData[1].categories[c].steps){s.oModel.getData().aConfigDetails[i].configData[1].categories[c].steps.forEach(function(p,q){if(p.id===f){var r=s.oModel.getData().aConfigDetails[i].configData[1].categories[c].steps;r.splice(q,1);s.oModel.getData().aConfigDetails[i].configData[1].categories[c].steps=r;}});if(S.changeCategory===true){var j=s.getSPathFromURL(S.categoryChangeContext).sPath;var k=j.split("/");i=k[2];var l=k[6];var m=k[8];s.oModel.getData().aConfigDetails[i].configData[1].categories[l].steps[m].isSelected=true;s.oModel.getData().aConfigDetails[i].configData[1].categories[l].expanded=true;}}}});this.oModel.updateBindings();var g=o.length;if(o[g-1].changeCategory){sap.ui.core.UIComponent.getRouterFor(this).navTo(o[g-1].oldContext.name,o[g-1].categoryChangeContext.arguments,true);}this.configEditor.setIsUnsaved();},updateSelectedNode:function(p,c){if(p){if(this.oTreeInstance.getSelection()){this.selectedNode=this.oTreeInstance.getSelection();}if(this.selectedNode){if(p.name&&this.selectedNode.getBindingContext()&&this.selectedNode.getBindingContext().getObject()){this.selectedNode.getBindingContext().getObject().name=p.name;this.selectedNode.getBindingContext().getObject().isSelected=true;if(this.selectedNode.getBindingContext().getObject().type===sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.REPRESENTATION||this.selectedNode.getBindingContext().getObject().type===sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.NAVIGATIONTARGET){this.selectedNode.getBindingContext().getObject().icon=p.icon;}this.oModel.updateBindings();}if(p.id&&this.selectedNode.getBindingContext().getObject().id){this.selectedNode.getBindingContext().getObject().id=p.id;if(p.icon){this.selectedNode.getBindingContext().getObject().icon=p.icon;}this.oModel.updateBindings();}else if(p.id&&this.selectedNode.getBindingContext().getObject().AnalyticalConfiguration){this.selectedNode.getBindingContext().getObject().AnalyticalConfiguration=p.id;this.selectedNode.getBindingContext().getObject().expanded=true;}}if((this.selectedNode.getBindingContext().getObject().type===sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION)&&c){sap.ui.core.UIComponent.getRouterFor(this).navTo(this.selectedNode.getBindingContext().getObject().type,c,true);this.updateTree();}}},createConfigList:function(){var s=this;this.configList=this.configurationHandler.getList();this.configList.forEach(function(c,i){var C={};C.AnalyticalConfiguration=c.AnalyticalConfiguration;C.name=c.AnalyticalConfigurationName;C.Application=c.Application;C.type=sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION;C.bIsLoaded=false;C.bToggleState=false;C.isSelected=false;C.expanded=false;C.selectable=true;C.hasExpander=true;s.oModel.getData().aConfigDetails.push(C);s.modelUpdateDeferred[i]=new jQuery.Deferred();});this.oModel.updateBindings();},showNoConfigSelectedText:function(){this.byId("idConfigDetailData").removeAllContent();this.clearTitleAndBreadCrumb();var n=new sap.m.Label().addStyleClass("noConfigSelected");n.setText(this.oCoreApi.getText("noConfigSelected"));n.placeAt(this.byId("idConfigDetailData"));this.toolbarController.disableCopyDeleteButton();this._enableDisableExportAndExecuteButton(false);this.byId("idConfigDetail").setBusy(false);},updateConfigListView:function(){this.selectedNode=this.oTreeInstance.getSelection();if(this.selectedNode===null){if(this.configList.length>1){this.showNoConfigSelectedText();}else{this.oModel.getData().aConfigDetails[0].isSelected=true;this.oModel.getData().aConfigDetails[0].expanded=true;this.configId=this.oModel.getData().aConfigDetails[0].AnalyticalConfiguration;this.oModel.updateBindings();var c={appId:this.appId,configId:this.oModel.getData().aConfigDetails[0].AnalyticalConfiguration};this.selectedNode=this.oTreeInstance.getNodes()[0];this.toolbarController.enableCopyDeleteButton();this._enableDisableExportAndExecuteButton(true);sap.ui.core.UIComponent.getRouterFor(this).navTo(this.oModel.getData().aConfigDetails[0].type,c,true);}}},_getNodeData:function(p,t){var c=this.oModel.getData().aConfigDetails;var n={};var g=function(h){var j={};var k=h||this.configId;for(var i=0;i<c.length;i++){if(c[i].AnalyticalConfiguration===k){j.index=i;j.data=c[i];j.id=c[i].AnalyticalConfiguration;break;}}return j;};var a=function(h){var k=g.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION]).index;var l={};for(var i=0;i<c[k].configData.length;i++){if(c[k].configData[i].filters instanceof Array){l.indexConfigData=i;for(var j=0;j<c[k].configData[i].filters.length;j++){if(c[k].configData[i].filters[j].id===h){l.index=j;l.data=c[k].configData[i].filters[j];l.id=c[k].configData[i].filters[j].id;l.filterNodeExpansion=c[k].configData[i].expanded;}}}}return l;};var b=function(h){var k=g.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION]).index;var l={};for(var i=0;i<c[k].configData.length;i++){if(c[k].configData[i].categories instanceof Array){l.indexConfigData=i;for(var j=0;j<c[k].configData[i].categories.length;j++){if(c[k].configData[i].categories[j].id===h){l.index=j;l.data=c[k].configData[i].categories[j];l.id=c[k].configData[i].categories[j].id;l.categoryExpansion=c[k].configData[i].expanded;}}}}return l;};var d=function(h){var j=g.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION]).index;var k=b.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY]).indexConfigData;var l=b.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY]).index;var m={};for(var i=0;i<c[j].configData[k].categories[l].steps.length;i++){if(c[j].configData[k].categories[l].steps[i].id===h){m.index=i;m.data=c[j].configData[k].categories[l].steps[i];m.id=c[j].configData[k].categories[l].steps[i].id;}}return m;};var e=function(h){var j=g.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION]).index;var k=b.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY]).indexConfigData;var l=b.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY]).index;var m=d.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.STEP]).index;var o={};if(c[j].configData[k].categories[l].steps[m]){for(var i=0;i<c[j].configData[k].categories[l].steps[m].representations.length;i++){if(c[j].configData[k].categories[l].steps[m].representations[i].id===h){o.index=i;o.data=c[j].configData[k].categories[l].steps[m].representations[i];o.id=c[j].configData[k].categories[l].steps[m].representations[i].id;}}}return o;};var f=function(h){var k=g.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION]).index;var l={};for(var i=0;i<c[k].configData.length;i++){if(c[k].configData[i].navTargets instanceof Array){l.indexConfigData=i;for(var j=0;j<c[k].configData[i].navTargets.length;j++){if(c[k].configData[i].navTargets[j].id===h){l.index=j;l.data=c[k].configData[i].navTargets[j];l.id=c[k].configData[i].navTargets[j].id;l.nTExpansion=c[k].configData[i].expanded;}}}}return l;};switch(t){case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION:n=g.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION]);break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.FACETFILTER:n=a.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.FACETFILTER]);break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.SMARTFILTERBAR:n=a.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.SMARTFILTERBAR]);break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY:n=b.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY]);break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.STEP:n=d.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.STEP]);break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.REPRESENTATION:n=e.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.REPRESENTATION]);break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.NAVIGATIONTARGET:n=f.call(this,p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.NAVIGATIONTARGET]);break;default:break;}return n;},_retainNodeState:function(p,t){var c=this._getNodeData(p,sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION).index;if(!this.oModel.getData().aConfigDetails[c].bIsLoaded){return{};}var n=this._getNodeData(p,t);if(!n.data){return{};}return{expanded:n.data.expanded,isSelected:n.data.isSelected};},updateTree:function(){var s=this;var c=[],f=[],F=[],S={},n=[],C=[],a=[],b=[],d,e;this.oTextPool=this.configurationHandler.getTextPool();var p={};p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION]=this.configId;var g=s._getNodeData(p,sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION).index;var h=this.configId;var k=false;var l=false;var m=false;var q=Object.keys(this.configEditor.getFilterOption())[0];c=this.configEditor.getCategories();function r(){if(s.oModel.getData().aConfigDetails[g].bIsLoaded){e=s._getNodeData(p,q);}d=s._retainNodeState(p,q);}function t(i,o){var j=s.oCoreApi.getText("smartFilterBar");if(q===sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.FACETFILTER){j=s.oTextPool.get(o.getLabelKey())?s.oTextPool.get(o.getLabelKey()).TextElementDescription:o.getLabelKey();}p[q]=o.getId();r();F.push({id:o.getId(),name:j,type:q,isSelected:d.isSelected||false,expanded:d.expanded||false,selectable:true,icon:i});}if(q===sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.SMARTFILTERBAR){S=this.configEditor.getSmartFilterBar();t("sap-icon://filter",S);}else if(q===sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.FACETFILTER){f=this.configEditor.getFacetFilters();f.forEach(function(o){var i=o.isVisible()?"sap-icon://filter":"sap-icon://hide";t(i,o);});}if(e&&e.filterNodeExpansion){k=true;}n=this.configEditor.getNavigationTargets();var R=this.oCoreApi.getRepresentationTypes();var u={};R.forEach(function(o){var i=o.id;u[i]=o.picture;});c.forEach(function(i){p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY]=i.getId();var o=i;var j=o.getId();b=[];s.configEditor.getCategoryStepAssignments(j).forEach(function(A){var B=s.configEditor.getStep(A);p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY]=j;p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.STEP]=B.getId();var D=s._retainNodeState(p,sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.STEP);var E=B.getRepresentations();var G=E.map(function(H){p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.REPRESENTATION]=H.getId();var I=s._retainNodeState(p,sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.REPRESENTATION);return{id:H.getId(),name:s.oCoreApi.getText(H.getRepresentationType()),type:"representation",isSelected:I.isSelected||false,expanded:I.expanded||false,selectable:true,icon:u[H.getRepresentationType()]};});b.push({id:B.getId(),name:s.oTextPool.get(B.getTitleId())?s.oTextPool.get(B.getTitleId()).TextElementDescription:B.getTitleId(),type:"step",representations:G,isSelected:D.isSelected||false,expanded:D.expanded||false,selectable:true,icon:B.getType()==="hierarchicalStep"?"sap-icon://drill-down":"sap-icon://step"});});var y=s._retainNodeState(p,sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY);if(s.oModel.getData().aConfigDetails[g].bIsLoaded){var z=s._getNodeData(p,sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY);if(z.categoryExpansion){m=true;}}C.push({id:i.getId(),name:s.oTextPool.get(i.labelKey)?s.oTextPool.get(i.labelKey).TextElementDescription:i.labelKey,type:"category",steps:b,isSelected:y.isSelected||false,expanded:y.expanded||false,selectable:true,icon:"sap-icon://open-folder"});});a.push({filters:F,name:s.oCoreApi.getText("facetFilters"),expanded:k,selectable:false});a.push({categories:C,name:s.oCoreApi.getText("categories"),expanded:m,selectable:false});var N=[];var v=function(j,o){p[sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.NAVIGATIONTARGET]=o.getId();var y=s._retainNodeState(p,sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.NAVIGATIONTARGET);if(s.oModel.getData().aConfigDetails[g].bIsLoaded){var z=s._getNodeData(p,sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.NAVIGATIONTARGET);if(z.nTExpansion){l=true;}}var i,A;for(i=0;i<j.length;i++){if(j[i].id===o.getAction()){A=j[i].text;break;}}if(o.getTitleKey()){A=s.configurationHandler.getTextPool().get(o.getTitleKey()).TextElementDescription;}N.push({id:o.getId(),name:A||o.getSemanticObject(),type:"navigationTarget",isSelected:y.isSelected||false,expanded:y.expanded||false,selectable:true,icon:o.isStepSpecific()?"sap-icon://pushpin-off":"sap-icon://overview-chart"});};var w=function(){var o=n.map(function(y){return y.getId();});var T=[];for(var i=0;i<o.length;i++){for(var j=0;j<N.length;j++){if(o[i]===N[j].id){T[i]=N[j];break;}}}N=T;};var x=function(){var o={};o.configData=a;s.oModel.getData().aConfigDetails[g].bIsLoaded=true;var T=s.oModel.getData().aConfigDetails[g];jQuery.extend(T,o);s.oModel.getData().aConfigDetails[g]=T;s.oModel.getData().aConfigDetails[g].name=s.configurationHandler.getConfiguration(h).AnalyticalConfigurationName;for(var i=0;i<s.oModel.getData().aConfigDetails.length;i++){if(s.modelUpdateDeferred[i]&&s.modelUpdateDeferred[i].state()==="pending"&&n.length===0){s.modelUpdateDeferred[i].resolve(s.oModel.getData());}}if(T.configData[2].navTargets.length>0){s._setNavigationTargetName({configIndexInTree:g});s.modelUpdateDeferred[g].resolve(s.oModel.getData());}s.oModel.updateBindings();};n.forEach(function(o){var P=s.oCoreApi.getSemanticActions(o.getSemanticObject());P.then(function(i){v(i.semanticActions,o);if(N.length===n.length){w();if(a[2]){a.splice(2,2);a.push({navTargets:N,name:s.oCoreApi.getText("navigationTargets"),expanded:l,selectable:false});x();var j=sap.apf.modeler.ui.utils.APFRouter.params;if(j.name==="navigationTarget"){sap.apf.modeler.ui.utils.APFRouter.setCurrentSelectionState(j,s);}}}});});a.push({navTargets:N,name:s.oCoreApi.getText("navigationTargets"),expanded:l,selectable:false});x();},_checkIfKeyExists:function(k,c){var i;if(this.navTargetTextsTable[c]){this.navTargetTextsTable[c].texts.forEach(function(n,a){if(n.key===k){i=a;}});}return i;},_getNavigationTargetName:function(k){var s=this;var v;var n=new jQuery.Deferred();var c=s.getSPathForConfig(s.configId).split('/')[2];if(this.modelUpdateDeferred[c]===undefined){this.modelUpdateDeferred[c]=new jQuery.Deferred();this.modelUpdateDeferred[c].resolve(this.oModel.getData());}jQuery.when(this.modelUpdateDeferred[c]).done(function(m){var i=s._checkIfKeyExists(k,c);if(i!==undefined){v=s.navTargetTextsTable[c].texts[i].value;n.resolve(v);}});return n.promise();},_setNavigationTargetName:function(p){var c=p.configIndexInTree!==undefined?p.configIndexInTree:this.getSPathForConfig(this.configId).split('/')[2];if(jQuery.isEmptyObject(this.navTargetTextsTable)){this.navTargetTextsTable={};}if(!this.navTargetTextsTable[c]){this.navTargetTextsTable[c]={texts:[]};}if(p.key&&p.value){var i=this._checkIfKeyExists(p.key,c);if(i===undefined){var n={};n.key=p.key;n.value=p.value;this.navTargetTextsTable[c].texts.push(n);}else{this.navTargetTextsTable[c].texts[i].value=p.value;}}else{var a=this.oModel.getData().aConfigDetails[c].configData[2].navTargets;for(var b=0;b<a.length;b++){var d={};d.key=a[b].id;d.value=a[b].name;this.navTargetTextsTable[p.configIndexInTree].texts.push(d);}}},_handleToggleTreeNode:function(e){var s=this;var c=e.getSource();var p=c.getBindingContext().sPath;var a=c.getBindingContext().getObject().type;if(a===sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION){var b=p.split('/')[2];if(s.oModel.getData().aConfigDetails[b].bIsLoaded===true){this.oModel.updateBindings();}else{this.configurationHandler.loadConfiguration(this.oModel.getData().aConfigDetails[b].AnalyticalConfiguration,function(d,m){if(m===undefined){s.configEditor=d;s.configId=s.oModel.getData().aConfigDetails[b].AnalyticalConfiguration;s.updateTree();}});}}},getSPathForConfig:function(c){var p;this.oModel.getData().aConfigDetails.forEach(function(a,i){if(a.AnalyticalConfiguration===c){p="/aConfigDetails/"+i;}});return p;},getSPathFromURL:function(p){var v={sPath:undefined,objectType:undefined};var s=this;this.oModel.getData().aConfigDetails.forEach(function(c,i){if(c.AnalyticalConfiguration===p.arguments.configId){v.sPath="/aConfigDetails/"+i;v.objectType=sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION;s.oModel.getData().aConfigDetails[i].expanded=true;if(p.arguments.categoryId!==undefined){s.oModel.getData().aConfigDetails[i].configData[1].categories.forEach(function(a,b){if(a.id===p.arguments.categoryId){v.sPath=v.sPath.concat("/configData/1/categories/"+b);v.objectType=sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY;s.oModel.getData().aConfigDetails[i].configData[1].expanded=true;if(p.arguments.stepId!==undefined){s.oModel.getData().aConfigDetails[i].configData[1].categories[b].steps.forEach(function(d,e){if(d.id===p.arguments.stepId){v.sPath=v.sPath.concat("/steps/"+e);v.objectType=sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.STEP;s.oModel.getData().aConfigDetails[i].configData[1].categories[b].expanded=true;if(p.arguments.representationId!==undefined){s.oModel.getData().aConfigDetails[i].configData[1].categories[b].steps[e].representations.forEach(function(r,f){if(r.id===p.arguments.representationId){s.oModel.getData().aConfigDetails[i].configData[1].categories[b].steps[e].expanded=true;v.sPath=v.sPath.concat("/representations/"+f);v.objectType=sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.REPRESENTATION;}});}}});}}});}if(p.arguments.facetFilterId!==undefined){s.oModel.getData().aConfigDetails[i].configData[0].filters.forEach(function(f,a){if(f.id===p.arguments.facetFilterId){v.sPath=v.sPath.concat("/configData/0/filters/"+a);v.objectType=sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.FACETFILTER;s.oModel.getData().aConfigDetails[i].configData[0].expanded=true;}});}if(p.arguments.smartFilterId!==undefined){v.sPath=v.sPath.concat("/configData/0/filters/0");v.objectType=sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.SMARTFILTERBAR;s.oModel.getData().aConfigDetails[i].configData[0].expanded=true;}if(p.arguments.navTargetId!==undefined){s.oModel.getData().aConfigDetails[i].configData[2].navTargets.forEach(function(n,a){if(n.id===p.arguments.navTargetId){v.sPath=v.sPath.concat("/configData/2/navTargets/"+a);v.objectType=sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.NAVIGATIONTARGET;s.oModel.getData().aConfigDetails[i].configData[2].expanded=true;}});}}});return v;},_navHandleExpandDelete:function(n,p,a){var s=this;this.selectedNode=this.oTreeInstance.getSelection();var c=this.oModel.getData().aConfigDetails;var I=a||this.oTreeInstance.isConfigurationSwitched(this.oPreviousSelectedNode,this.selectedNode);var g=function(j){var r;for(var i=0;i<c.length;i++){if(c[i].AnalyticalConfiguration===j){r=i;break;}}return r;};var b=function(r){var h=g.call(this,p.configId);var t,u;for(var i=0;i<c[h].configData.length;i++){if(c[h].configData[i].filters instanceof Array){t=i;for(var j=0;j<c[h].configData[i].filters.length;j++){if(c[h].configData[i].filters[j].id===r){u=j;break;}else{u=j;}}}}return{indexConfig:t,indexFilter:u};};var d=function(r){var h=g.call(this,p.configId);var t,u;for(var i=0;i<c[h].configData.length;i++){if(c[h].configData[i].navTargets instanceof Array){t=i;for(var j=0;j<c[h].configData[i].navTargets.length;j++){if(c[h].configData[i].navTargets[j].id===r){u=j;break;}else{u=j;}}}}return{indexConfig:t,indexNavTarget:u};};var e=function(r){var h=g.call(this,p.configId);var t,u;for(var i=0;i<c[h].configData.length;i++){if(c[h].configData[i].categories instanceof Array){t=i;for(var j=0;j<c[h].configData[i].categories.length;j++){if(c[h].configData[i].categories[j].id===r){u=j;break;}else{u=j;}}}}return{indexConfig:t,indexCategory:u};};var f=function(j){var h=g.call(this,p.configId);var k=e.call(this,p.categoryId).indexConfig;var m=e.call(this,p.categoryId).indexCategory;var r;for(var i=0;i<c[h].configData[k].categories[m].steps.length;i++){if(c[h].configData[k].categories[m].steps[i].id===j){r=i;break;}else{r=i;}}return r;};if(p.configId.indexOf(sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.ISNEWCONFIG)===0&&I){this.configurationHandler.removeConfiguration(p.configId,function(i){var C=s.oModel.getData().aConfigDetails;var h=g.call(s,p.configId);s._deleteConfigNavTargetTexts(h,C.length);C.splice(h,1);s.oModel.getData().aConfigDetails=C;});}else{var h,k,l,m,o,q;switch(n.nodeObjectType){case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION:h=g.call(this,p.configId);this.oModel.getData().aConfigDetails[h].isSelected=true;this.oModel.getData().aConfigDetails[h].expanded=true;break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.FACETFILTER:h=g.call(this,p.configId);k=b.call(this,p.facetFilterId).indexConfig;l=b.call(this,p.facetFilterId).indexFilter;this.oModel.getData().aConfigDetails[h].expanded=true;this.oModel.getData().aConfigDetails[h].configData[k].expanded=true;this.oModel.getData().aConfigDetails[h].configData[k].filters[l].expanded=true;break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY:h=g.call(this,p.configId);k=e.call(this,p.categoryId).indexConfig;m=e.call(this,p.categoryId).indexCategory;this.oModel.getData().aConfigDetails[h].expanded=true;this.oModel.getData().aConfigDetails[h].configData[k].expanded=true;break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.STEP:h=g.call(this,p.configId);k=e.call(this,p.categoryId).indexConfig;m=e.call(this,p.categoryId).indexCategory;o=f.call(this,p.stepId);this.oModel.getData().aConfigDetails[h].expanded=true;this.oModel.getData().aConfigDetails[h].configData[k].expanded=true;this.oModel.getData().aConfigDetails[h].configData[k].categories[m].expanded=true;break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.REPRESENTATION:h=g.call(this,p.configId);k=e.call(this,p.categoryId).indexConfig;m=e.call(this,p.categoryId).indexCategory;o=f.call(this,p.stepId);this.oModel.getData().aConfigDetails[h].expanded=true;this.oModel.getData().aConfigDetails[h].configData[k].expanded=true;this.oModel.getData().aConfigDetails[h].configData[k].categories[m].expanded=true;this.oModel.getData().aConfigDetails[h].configData[k].categories[m].steps[o].expanded=true;break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.NAVIGATIONTARGET:h=g.call(this,p.configId);k=d.call(this,p.navTargetId).indexConfig;q=d.call(this,p.navTargetId).indexNavTarget;this.oModel.getData().aConfigDetails[h].expanded=true;this.oModel.getData().aConfigDetails[h].configData[k].expanded=true;this.oModel.getData().aConfigDetails[h].configData[k].navTargets[q].expanded=true;break;default:break;}}this.oModel.updateBindings();},_isNewSubView:function(p){var i=false;if(p.arguments.configId.indexOf(sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.ISNEWCONFIG)===0){i=true;}else{if(p.name===sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION){i=(this.configurationHandler.getConfiguration(p.arguments.configId)!==undefined)?false:true;}else if(p.name===sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY){i=(this.configEditor.getCategory(p.arguments.categoryId)!==undefined)?false:true;}else if(p.name===sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.FACETFILTER){i=(this.configEditor.getFacetFilter(p.arguments.facetFilterId)!==undefined)?false:true;}else if(p.name===sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.STEP){i=(this.configEditor.getStep(p.arguments.stepId)!==undefined)?false:true;}else if(p.name===sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.REPRESENTATION){i=(this.configEditor.getStep(p.arguments.stepId).getRepresentation(p.arguments.representationId)!==undefined)?false:true;}else if(p.name===sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.NAVIGATIONTARGET){i=(this.configEditor.getNavigationTarget(p.arguments.navTargetId)!==undefined)?false:true;}}return i;},_getCurrentConfigurationNode:function(){var p=this.oTreeInstance.getNodes();var c=this.configId;for(var i=0;i<p.length;i++){if(c===p[i].getBindingContext().getObject().AnalyticalConfiguration){return p[i];}}return undefined;},_navMandatoryResetState:function(c,a){var s=c;c.selectedNode=c.oTreeInstance.getSelection();s.bIsSaved=s.configEditor?s.configEditor.isSaved():undefined;var b=(typeof s.byId("idConfigDetailData").getContent()[0].getController==="function")?s.byId("idConfigDetailData").getContent()[0].getController():undefined;c.configurationHandler.memorizeConfiguration(b.getView().getViewData().oParams.arguments.configId);var i=this._isNewSubView(b.getView().getViewData().oParams);if(!i){s.updateTree();var d=s.selectedNode.getBindingContext().getObject();if(d){d.isSelected=true;var e=b.getView().getViewData().oParams.name;var f=sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes;if(e!==f.REPRESENTATION){b.updateSubViewInstancesOnReset(s.configEditor);}else{b.oConfigurationEditor=s.configEditor;}b.setDetailData.call(b);s.updateTitleAndBreadCrumb();}else{s.oTreeInstance.setSelection(s._getCurrentConfigurationNode());}if(typeof a==="function"){a();}}else{s.handleConfirmDeletion();}return{bIsSaved:s.bIsSaved,isNewView:i};},_navSaveState:function(s){s();},_navConfigResetState:function(c,a){var s=c;var b=(typeof s.byId("idConfigDetailData").getContent()[0].getController==="function")?s.byId("idConfigDetailData").getContent()[0].getController():undefined;var i=this._isNewSubView(b.getView().getViewData().oParams);if(!i){s.configurationHandler.loadConfiguration(s.configId,function(d,m){if(m===undefined){var b=(typeof s.byId("idConfigDetailData").getContent()[0].getController==="function")?s.byId("idConfigDetailData").getContent()[0].getController():undefined;s.configEditor=d;s.updateTree();var e=s.selectedNode.getBindingContext().getObject();if(e){e.isSelected=true;var f=b.getView().getViewData().oParams.name;var g=sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes;if(f!==g.REPRESENTATION){b.updateSubViewInstancesOnReset(s.configEditor);}else{b.oConfigurationEditor=s.configEditor;}b.setDetailData.call(b);s.updateTitleAndBreadCrumb();}else{s.oTreeInstance.setSelection(s._getCurrentConfigurationNode());}if(typeof a==="function"){a();}}});}else{s.handleConfirmDeletion();}},_onTreeNodeSelection:function(e){this.selectedNode=e.getParameter("node");var s=this;var p,P,r;if(!this.bProgramaticSelection){this.oPreviousSelectedNode=this.oTreeInstance.getSelection();this.bIsDifferntConfig=this.oTreeInstance.isConfigurationSwitched(this.oPreviousSelectedNode,this.selectedNode);this.oSelectedNodeDetails=this.oTreeInstance.getAPFTreeNodeContext(this.selectedNode);this.oParentNodeDetails=this.oTreeInstance.getParentNodeContext(this.oSelectedNodeDetails);this._enableDisableExportAndExecuteButton(true);var a;if(this.byId("idConfigDetailData").getContent().length>=1){a=(typeof this.byId("idConfigDetailData").getContent()[0].getController==="function")?this.byId("idConfigDetailData").getContent()[0].getController():undefined;}var c=this.selectedNode?this.selectedNode.getId():null;var b=this.oPreviousSelectedNode?this.oPreviousSelectedNode.getId():null;var d=function(){var k=s.oPreviousSelectedNode.getBindingContext().getObject();var l=s.selectedNode.getBindingContext().getObject();k.isSelected=true;l.isSelected=false;s.oModel.updateBindings();};if(c!==b||this.bNavDeletionMode){var n=sap.apf.modeler.ui.utils.navigationHandler.getInstance();var i;if(a!==undefined){i=typeof a.getValidationState==="function"?a.getValidationState.call(a):true;}else{i=true;}var f=this.configEditor?jQuery.extend(true,{},this.configEditor):undefined;this.bIsSaved=f?f.isSaved():undefined;var o;var g=false;var h=this.configurationHandler.getList();if(!i&&(h.length>0)){n.throwMandatoryPopup(this,{yes:function(){var a=(typeof s.byId("idConfigDetailData").getContent()[0].getController==="function")?s.byId("idConfigDetailData").getContent()[0].getController():undefined;var k=s._isNewSubView(a.getView().getViewData().oParams);if(!k){var y=function(q){s.configEditor=s.configurationHandler.restoreMemorizedConfiguration(s.oParentNodeDetails.configId);if(s.bIsSaved===false&&s.configEditor){s.configEditor.setIsUnsaved();}if(typeof q==="function"){q();}s.updateTree();var t=s.selectedNode.getBindingContext().getObject();s.navigateToDifferntView(s.oParentNodeDetails,s.oSelectedNodeDetails);t.isSelected=true;s.oModel.updateBindings();};if(s.bIsSaved===false&&s.bIsDifferntConfig){o(false,function(){y.call(s);});}else{y.call(s);}}else{if(s.bIsSaved===false&&s.bIsDifferntConfig){o(false,function(){var l=s.selectedNode.getBindingContext().sPath;var m=s.oPreviousSelectedNode;s.handleConfirmDeletion(m,l);});}else{var l=s.selectedNode.getBindingContext().sPath;var m=s.oPreviousSelectedNode;s.handleConfirmDeletion(m,l);}}s._navHandleExpandDelete.call(s,s.oSelectedNodeDetails,s.oParentNodeDetails);},no:function(){d();}});g=true;}o=function(k){s.configurationHandler.memorizeConfiguration(a.getView().getViewData().oParams.arguments.configId);n.throwLossOfDataPopup(s,{yes:function(l){if(typeof k==="function"){k(function(){l(function(){var m;if(s.oPreviousSelectedNode){var B=s.oPreviousSelectedNode.getBindingContext().sPath;var C=B.split("/");m=C[2];}s.oModel.getData().aConfigDetails[m].AnalyticalConfiguration=s.configId;});});}else{if(s.oPreviousSelectedNode){p=s.oTreeInstance.getAPFTreeNodeContext(s.oPreviousSelectedNode);P=s.oTreeInstance.getParentNodeContext(p);r=s.configurationHandler.restoreMemorizedConfiguration(P.configId);if(r){s.configEditor=r;}}l(function(){var m;if(s.oPreviousSelectedNode){var B=s.oPreviousSelectedNode.getBindingContext().sPath;var C=B.split("/");m=C[2];}s.oModel.getData().aConfigDetails[m].AnalyticalConfiguration=s.configId;var q=s.selectedNode.getBindingContext().getObject();s.navigateToDifferntView(s.oParentNodeDetails,s.oSelectedNodeDetails);q.isSelected=true;s.oModel.updateBindings();});}},no:function(){s.configurationHandler.loadConfiguration(s.configId,function(l,m){if(m===undefined){s.configEditor=l;if(s.configId.indexOf(sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.ISNEWCONFIG)===0){s._navHandleExpandDelete.call(s,{},{configId:s.configId},s.oParentNodeDetails);}else{s.updateTree();}s.navigateToDifferntView(s.oParentNodeDetails,s.oSelectedNodeDetails);s._navHandleExpandDelete.call(s,s.oSelectedNodeDetails,s.oParentNodeDetails);}});},cancel:function(){d();}});};if(s.bIsSaved===false&&s.bIsDifferntConfig&&i){o();g=true;}if(!g){if(this.oPreviousSelectedNode&&this.oPreviousSelectedNode.getId()!==this.selectedNode.getId()){var j=this.oPreviousSelectedNode.getBindingContext().getObject();if(j){this.oPreviousSelectedNode.getBindingContext().getObject().isSelected=false;this.oPreviousSelectedNode.setIsSelected(false);}}else{this.selectedNode.getBindingContext().getObject().isSelected=true;}this.navigateToDifferntView(this.oParentNodeDetails,this.oSelectedNodeDetails,this.bIsSaved,this.bIsDifferntConfig);}}}this.bProgramaticSelection=false;this.bNavDeletionMode=false;},navigateToDifferntView:function(p,s,i,I){if((!jQuery.isEmptyObject(p)&&(i===undefined||i))||(!I)){sap.ui.core.UIComponent.getRouterFor(this).navTo(s.nodeObjectType,p,true);}},_deleteConfigNavTargetTexts:function(a,n){var s=this;var b;for(var i=a;i<n-1;i++){this.modelUpdateDeferred[i]=this.modelUpdateDeferred[i+1];}delete this.modelUpdateDeferred[n-1];if(this.navTargetTextsTable){if(this.navTargetTextsTable[a]){delete this.navTargetTextsTable[a];}if(a!==(n-1)){Object.keys(this.navTargetTextsTable).forEach(function(k){k=parseInt(k,10);if(k>a){s.navTargetTextsTable[k-1]=s.navTargetTextsTable[k];b=k;}});if(b!==undefined){delete this.navTargetTextsTable[b];}}}},handleConfirmDeletion:function(s,a){var b=((s===undefined)||(typeof s.preventDefault==="function"))?this.oTreeInstance.getAPFTreeNodeContext(this.oTreeInstance.getSelection()):this.oTreeInstance.getAPFTreeNodeContext(s);var c=this;this.selectedNode=this.oTreeInstance.getSelection();var C,n,N,o,d,i,e,f,g,h;d=b.nodeContext;o=d.split("/");i=o[2];switch(b.nodeObjectType){case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.FACETFILTER:this.configEditor.removeFacetFilter(b.nodeAPFId);e=o[6];var F=this.oModel.getData().aConfigDetails[i].configData[0].filters;F.splice(e,1);this.oModel.getData().aConfigDetails[i].configData[0].filters=F;N=o.slice(0,3);n=N.join("/");break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CATEGORY:this.configEditor.removeCategory(b.nodeAPFId);f=o[6];var j=this.oModel.getData().aConfigDetails[i].configData[1].categories;j.splice(f,1);this.oModel.getData().aConfigDetails[i].configData[1].categories=j;N=o.slice(0,3);n=N.join("/");break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.NAVIGATIONTARGET:this.configEditor.removeNavigationTarget(b.nodeAPFId);g=o[6];var k=this.oModel.getData().aConfigDetails[i].configData[2].navTargets;k.splice(g,1);this.oModel.getData().aConfigDetails[i].configData[2].navTargets=k;N=o.slice(0,3);n=N.join("/");break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.STEP:var S=this.configEditor.getCategoriesForStep(b.nodeAPFId);var l=b.nodeContext.split("/");i=l[2];S.forEach(function(x){c.configEditor.removeCategoryStepAssignment(x,b.nodeAPFId);c.oModel.getData().aConfigDetails[i].configData[1].categories.forEach(function(y,z){if(y.id===x){c.oModel.getData().aConfigDetails[i].configData[1].categories[z].steps.forEach(function(A,B){if(A.id===b.nodeAPFId){var D=c.oModel.getData().aConfigDetails[i].configData[1].categories[z].steps;D.splice(B,1);c.oModel.getData().aConfigDetails[i].configData[1].categories[z].steps=D;}});}});});N=o.slice(0,7);n=N.join("/");break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.REPRESENTATION:f=o[6];h=o[8];var p=this.oModel.getData().aConfigDetails[i].configData[1].categories[f].steps[h].id;var P=this.configEditor.getStep(p);var m=this.configEditor.getCategoriesForStep(p);P.removeRepresentation(b.nodeAPFId);m.forEach(function(x){c.oModel.getData().aConfigDetails[i].configData[1].categories.forEach(function(y,z){if(y.id===x){c.oModel.getData().aConfigDetails[i].configData[1].categories[z].steps.forEach(function(A,B){if(A.id===p){c.oModel.getData().aConfigDetails[i].configData[1].categories[z].steps[B].representations.forEach(function(D,E){if(D.id===b.nodeAPFId){var R=c.oModel.getData().aConfigDetails[i].configData[1].categories[z].steps[B].representations;R.splice(E,1);c.oModel.getData().aConfigDetails[i].configData[1].categories[z].steps[B].representations=R;}});}});}});});N=o.slice(0,9);n=N.join("/");break;case sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION:var q=false;if(b.nodeAPFId.indexOf("newConfig")===0){q=true;}if(!q){this.configurationHandler.removeConfiguration(b.nodeAPFId,function(x){var r;var t=c.oModel.getData().aConfigDetails;c._deleteConfigNavTargetTexts(parseInt(i,10),t.length);var v=(c.configurationHandler.getList().length>0)?true:false;t.splice(i,1);c.oModel.getData().aConfigDetails=t;c.oModel.updateBindings();if(a){var u=c.oTreeInstance.getParentNodeContext(c.oTreeInstance.getAPFTreeNodeContext(c.selectedNode));sap.ui.core.UIComponent.getRouterFor(c).navTo(c.selectedNode.getBindingContext().getObject().type,u,true);}else{c.clearTitleAndBreadCrumb();c.byId("idConfigDetailData").removeAllContent();if(v){r=new sap.m.Label().addStyleClass("noConfigSelected");r.setText(c.oCoreApi.getText("noConfigSelected"));r.placeAt(c.byId("idConfigDetailData"));c.toolbarController.disableCopyDeleteButton();c._enableDisableExportAndExecuteButton(false);}else{r=new sap.m.Label().addStyleClass("addNewConfig");r.setText(c.oCoreApi.getText("addNewConfig"));r.placeAt(c.byId("idConfigDetailData"));c.toolbarController.disableCopyDeleteButton();c._enableDisableExportAndExecuteButton(false);}}});}else{var r;var t=c.oModel.getData().aConfigDetails;t.splice(i,1);c.oModel.getData().aConfigDetails=t;c.oModel.updateBindings();if(a){var u=c.oTreeInstance.getParentNodeContext(c.oTreeInstance.getAPFTreeNodeContext(c.selectedNode));sap.ui.core.UIComponent.getRouterFor(c).navTo(c.selectedNode.getBindingContext().getObject().type,u,true);}else{c.clearTitleAndBreadCrumb();c.byId("idConfigDetailData").removeAllContent();var v=(this.configurationHandler.getList().length>0)?true:false;if(v){r=new sap.m.Label().addStyleClass("noConfigSelected");r.setText(c.oCoreApi.getText("noConfigSelected"));r.placeAt(c.byId("idConfigDetailData"));c.toolbarController.disableCopyDeleteButton();c._enableDisableExportAndExecuteButton(false);}else{r=new sap.m.Label().addStyleClass("addNewConfig");r.setText(c.oCoreApi.getText("addNewConfig"));r.placeAt(c.byId("idConfigDetailData"));c.toolbarController.disableCopyDeleteButton();c._enableDisableExportAndExecuteButton(false);}}}break;default:break;}if(a){this.bNavDeletionMode=true;}if(b.nodeObjectType!==sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.CONFIGURATION){this.configEditor.setIsUnsaved();this.clearTitleAndBreadCrumb();this.byId("idConfigDetailData").removeAllContent();n=a||n;C=this.oTreeInstance.getModel().getContext(n);this.oModel.updateBindings();this.selectedNode=this.oTreeInstance.getNodeByContext(C);this.bProgramaticSelection=false;this.oTreeInstance.setSelection(this.selectedNode);if(a){this.selectedNode.getBindingContext().getObject().isSelected=true;this.oModel.updateBindings();}}var w=(this.toolbarController.confirmationDialog===undefined)?false:this.toolbarController.confirmationDialog.isOpen;if(w&&!a){this.toolbarController.confirmationDialog.close();}},handleNavBack:function(){var s;var a=this;if(this.byId("idConfigDetailData").getContent().length>=1){s=(typeof this.byId("idConfigDetailData").getContent()[0].getController==="function")?this.byId("idConfigDetailData").getContent()[0].getController():undefined;}this.selectedNode=this.oTreeInstance.getSelection();this.oSelectedNodeDetails=this.oTreeInstance.getAPFTreeNodeContext(this.selectedNode);this.oParentNodeDetails=this.oTreeInstance.getParentNodeContext(this.oSelectedNodeDetails);var n=sap.apf.modeler.ui.utils.navigationHandler.getInstance();var i;if(s!==undefined){i=typeof s.getValidationState==="function"?s.getValidationState.call(s):true;}else{i=true;}this.bIsSaved=this.configEditor?this.configEditor.isSaved():undefined;var c=(a.configurationHandler.getList().length>0)?true:false;var b=function(d){if(this.selectedNode){this.selectedNode=null;}this.oModel=new sap.ui.model.json.JSONModel({aConfigDetails:[]});this.getView().setModel(this.oModel);this.configEditor=undefined;this.navTargetTextsTable={};window.history.go(-1);};if(c){var S=(a.bIsSaved===undefined)?true:a.bIsSaved;if(!i){n.throwMandatoryPopup(a,{yes:function(){a.configEditor=a.configurationHandler.restoreMemorizedConfiguration(s.getView().getViewData().oParams.arguments.configId);if(a.bIsSaved===false&&a.configEditor){a.configEditor.setIsUnsaved();}var d=a._navMandatoryResetState(a);var e=a.configurationHandler.getList();if(d.bIsSaved===false&&e.length>0){n.throwLossOfDataPopup(a,{yes:function(f){f();b.call(a);},no:function(){if(a.configId.indexOf(sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.ISNEWCONFIG)===0){a._navHandleExpandDelete.call(a,{},{configId:a.configId},a.oParentNodeDetails);}b.call(a);}});}else{b.call(a);}}});return;}else if(!S&&i){n.throwLossOfDataPopup(a,{yes:function(d){d();b.call(a);},no:function(){a.configurationHandler.resetConfiguration(a.configId);if(a.configId.indexOf(sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.ISNEWCONFIG)===0){a._navHandleExpandDelete.call(a,{},{configId:a.configId},a.oParentNodeDetails);}b.call(a);}});return;}}b.call(a);},handleSavePress:function(){var s,i;var a=this;this.selectedNode=this.oTreeInstance.getSelection();if(this.selectedNode){var b=this.selectedNode.getBindingContext().sPath;var c=b.split("/");i=c[2];}if(this.byId("idConfigDetailData").getContent().length>=1){s=(typeof this.byId("idConfigDetailData").getContent()[0].getController==="function")?this.byId("idConfigDetailData").getContent()[0].getController():undefined;}var d=function(){var a=this;var m;a.configEditor.save(function(h,j,k){if(k===undefined){a.configurationHandler.memorizeConfiguration(s.getView().getViewData().oParams.arguments.configId);a.oModel.getData().aConfigDetails[i].AnalyticalConfiguration=h;a.oModel.updateBindings();a.oSelectedNodeDetails=a.oTreeInstance.getAPFTreeNodeContext(a.selectedNode);a.oParentNodeDetails=a.oTreeInstance.getParentNodeContext(a.oSelectedNodeDetails);a.navigateToDifferntView(a.oParentNodeDetails,a.oSelectedNodeDetails,true,false);m=a.oCoreApi.createMessageObject({code:"11513"});a.oCoreApi.putMessage(m);}else{m=a.oCoreApi.createMessageObject({code:"11514"});a.oCoreApi.putMessage(m);}});};var n=sap.apf.modeler.ui.utils.navigationHandler.getInstance();var e;if(s!==undefined){e=typeof s.getValidationState==="function"?s.getValidationState.call(s):true;}else{e=true;}var f=this.configEditor?jQuery.extend(true,{},this.configEditor):undefined;this.bIsSaved=f?f.isSaved():undefined;var g=false;if(!e){n.throwMandatoryPopup(a,{yes:function(){a.configEditor=a.configurationHandler.restoreMemorizedConfiguration(s.getView().getViewData().oParams.arguments.configId);if(a.bIsSaved===false&&a.configEditor){a.configEditor.setIsUnsaved();}a._navMandatoryResetState(a);d.call(a);}});g=true;}if(!g){d.call(this);this.toolbarController.closeDialog();}},_handleExportButtonPress:function(){var s;if(this.byId("idConfigDetailData").getContent().length>=1){s=(typeof this.byId("idConfigDetailData").getContent()[0].getController==="function")?this.byId("idConfigDetailData").getContent()[0].getController():undefined;}var e=function(){if(!this.exportConfigurationDialog){this.exportConfigurationDialog=sap.ui.xmlfragment("idExportConfigurationFragment","sap.apf.modeler.ui.fragment.exportConfiguration",this);this.getView().addDependent(this.exportConfigurationDialog);this._setExportConfigDialogText();this._addStyleClassForExportDialog();this.configurationHandler.memorizeConfiguration(s.getView().getViewData().oParams.arguments.configId);}jQuery.sap.syncStyleClass("sapUiSizeCompact",this.getView(),this.exportConfigurationDialog);this.exportConfigurationDialog.open();};this._performExportOrExecute(e.bind(this));},handlePublishPress:function(){var p;if(this.oCoreApi&&this.oCoreApi.isUsingCloudFoundryProxy()&&(p=this.oCoreApi.getGenericExit("publishTileDialog"))){p(this.oCoreApi,this);}},_enableDisableExportAndExecuteButton:function(e){this.byId("idExportbutton").setEnabled(e);this.byId("idExecuteButton").setEnabled(e);this.byId("idPublishbutton").setEnabled(e);},_setExportConfigDialogText:function(){sap.ui.core.Fragment.byId("idExportConfigurationFragment","idExportConfigDialog").setTitle(this.oCoreApi.getText("exportConfig"));sap.ui.core.Fragment.byId("idExportConfigurationFragment","idDownloadConfig").setText(this.oCoreApi.getText("downloadConfig"));sap.ui.core.Fragment.byId("idExportConfigurationFragment","idDownloadTextProperty").setText(this.oCoreApi.getText("downloadTextProperty"));sap.ui.core.Fragment.byId("idExportConfigurationFragment","idCloseButton").setText(this.oCoreApi.getText("close"));},_addStyleClassForExportDialog:function(){sap.ui.core.Fragment.byId("idExportConfigurationFragment","idDownloadConfig").addStyleClass("configLink");sap.ui.core.Fragment.byId("idExportConfigurationFragment","idDownloadTextProperty").addStyleClass("textPropertyLink");},_handleCloseOfExportDialog:function(){if(this.exportConfigurationDialog.isOpen()){this.exportConfigurationDialog.close();}},_handleOpenConfigLinkPress:function(){this.configurationHandler.exportConfiguration(this.configId,function(c,a){sap.ui.core.util.File.save(c,a,'json','application/json','utf-8');});},_handleOpenTextsLinkPress:function(){var c=this.configurationHandler.getConfiguration(this.configId).AnalyticalConfigurationName;var e=this.configurationHandler.exportTexts(this.configId);sap.ui.core.util.File.save(e,c,'properties','text/plain','utf-8');},_performExportOrExecute:function(r){var s,o,n,c,b,i,a,C;var d=false;var e=true;var f=this;f.selectedNode=f.oTreeInstance.getSelection();f.oSelectedNodeDetails=f.oTreeInstance.getAPFTreeNodeContext(f.selectedNode);f.oParentNodeDetails=f.oTreeInstance.getParentNodeContext(f.oSelectedNodeDetails);var g=sap.apf.modeler.ui.utils.navigationHandler.getInstance();if(this.byId("idConfigDetailData").getContent().length>=1){s=(typeof this.byId("idConfigDetailData").getContent()[0].getController==="function")?this.byId("idConfigDetailData").getContent()[0].getController():undefined;}if(s!==undefined){e=typeof s.getValidationState==="function"?s.getValidationState.call(s):true;}var h=this.configEditor?jQuery.extend(true,{},this.configEditor):undefined;this.bIsSaved=h?h.isSaved():undefined;var j=function(c){f.byId("idConfigDetailData").removeAllContent();if(c){a=new sap.m.Label().addStyleClass("noConfigSelected");a.setText(f.oCoreApi.getText("noConfigSelected"));}else{a=new sap.m.Label().addStyleClass("addNewConfig");a.setText(f.oCoreApi.getText("addNewConfig"));}a.placeAt(f.byId("idConfigDetailData"));f.toolbarController.disableCopyDeleteButton();f._enableDisableExportAndExecuteButton(false);};if(!e){g.throwMandatoryPopup(f,{yes:function(){f.configEditor=f.configurationHandler.restoreMemorizedConfiguration(s.getView().getViewData().oParams.arguments.configId);if(f.bIsSaved===false&&f.configEditor){f.configEditor.setIsUnsaved();}n=f._navMandatoryResetState(f);c=(f.configurationHandler.getList().length>0)?true:false;if(c){if(n.bIsSaved===false){o();}else{if(f.oParentNodeDetails.configId.indexOf("newConfig")!==0){r();}}}else{j(c);}}});d=true;}o=function(){g.throwLossOfDataPopup(f,{yes:function(k){f._navSaveState(function(){k(function(l){if(f.selectedNode){b=f.selectedNode.getBindingContext().sPath;C=b.split("/");i=C[2];}f.oModel.getData().aConfigDetails[i].AnalyticalConfiguration=f.configId;f.oModel.updateBindings();r();});});},no:function(){if(f.configId.indexOf(sap.apf.modeler.ui.utils.CONSTANTS.configurationObjectTypes.ISNEWCONFIG)===0){f._navHandleExpandDelete.call(f,{},{configId:f.configId},f.oParentNodeDetails);f.clearTitleAndBreadCrumb();f.byId("idConfigDetailData").removeAllContent();c=(f.configurationHandler.getList().length>0)?true:false;j(c);}else{f._navConfigResetState(f,function(){f._navHandleExpandDelete.call(f,f.oSelectedNodeDetails,f.oParentNodeDetails);r();});}}});};if(f.bIsSaved===false&&e){o();d=true;}if(!d){r();}},handleExecuteButtonPress:function(){var s=this.oTreeInstance.getSelection();var e=function(){var S=this.oTreeInstance.getAPFTreeNodeContext(s);var p=this.oTreeInstance.getParentNodeContext(S);this.oCoreApi.navigateToGenericRuntime(p.appId,p.configId,window.open);this.configurationHandler.memorizeConfiguration(p.configId);};this._performExportOrExecute(e.bind(this));},getStepConfigDataBysPath:function(p){var c=p.split("/");var i=c[2],a=c[4],b=c[6],d=c[8];var s=this.oModel.getData().aConfigDetails[i].configData[a].categories[b].steps[d];return s;}});}());
