/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2018 SAP SE. All rights reserved
 */
sap.ui.define(['sap/apf/modeler/ui/utils/constants'],function(M){'use strict';function P(){var p=[];this._getPropertyTypeRows=function(){return p;};this.getPropertyTypeRow=function(v){return p.filter(function(s){return(s.controlId===v);})[0];};this.getPropertyTypeRowByPropertyName=function(s){return p.filter(function(a){return(a.propertyRowInformation.sProperty===s);})[0];};this.getSelectedProperties=function(){var s=[];this._getPropertyTypeRows().forEach(function(a){s.push(a.propertyRowInformation.sProperty);});return s;};this.updatePropertyTypeRow=function(v,s){this.getPropertyTypeRow(v).propertyRowInformation.sProperty=s;};this.getAggregationRole=function(){if(p.length===0){return null;}return m._mapPropertyType2AggregationRole(p[0].sPropertyType);};this.getPropertyInformationList=function(){var t=this;var a=[];this._getPropertyTypeRows().forEach(function(r){var s=r.propertyRowInformation.sProperty;var T;switch(t._getPropertyTypeRows()[0].sPropertyType){case M.propertyTypes.DIMENSION:case M.propertyTypes.LEGEND:T=r.oView.oViewData.oRepresentationHandler.oRepresentation.getDimensionTextLabelKey(s);break;case M.propertyTypes.MEASURE:T=r.oView.oViewData.oRepresentationHandler.oRepresentation.getMeasureTextLabelKey(s);break;case M.propertyTypes.PROPERTY:T=r.oView.oViewData.oRepresentationHandler.oRepresentation.getPropertyTextLabelKey(s);break;case M.propertyTypes.HIERARCHIALCOLUMN:T=r.oView.oViewData.oRepresentationHandler.oRepresentation.getHierarchyPropertyTextLabelKey(s);break;default:T=null;break;}if(s!==r.oView.getController().oTextReader("none")){a.push({sProperty:s,sKind:r.propertyRowInformation.sContext,sTextLabelKey:T,sLabelDisplayOption:r.oView.oViewData.oRepresentationHandler.oRepresentation.getLabelDisplayOption(s),sMeasureDisplayOption:r.oView.oViewData.oRepresentationHandler.oRepresentation.getMeasureDisplayOption(s)});}});return a;};this.getSortPropertyInformationList=function(s){return this._getPropertyTypeRows().filter(function(r){var a=r.propertyRowInformation.sProperty;return(a!==r.oView.getController().oTextReader("none"));}).map(function(r){return{property:r.propertyRowInformation.sProperty,ascending:r.oView.getController().byId(s).getSelectedKey()==="true"?true:false};});};this.addPropertyTypeReference=function(c,a,s,v){p.push({controlId:c,propertyRowInformation:a,sPropertyType:s,oView:v});};this.removePropertyTypeReference=function(c){p.forEach(function(s,i){if(s.controlId===c){p.splice(i,1);}});};this.updateAllDropDownsAsPromise=function(){return new Promise(function(r){_(r);});};function _(r){var l=[];p.forEach(function(R){l.push(m._updateDropDownOfAControl(R));});Promise.all(l).then(function(){r();});}this.updateAllSelectControlsForPropertyType=function(v,s){var t=this;return new Promise(function(r){if(v&&s){if(t.isSwapCase(v,s)){t._swapPropertiesBetweenControls(v,s).then(function(){_(r);});}else{t.updatePropertyTypeRow(v,s);_(r);}}else{_(r);}});};this.isSwapCase=function(v,s){return(m._mapPropertyType2AggregationRole(this.getPropertyTypeRow(v).sPropertyType)===M.aggregationRoles.MEASURE&&m._isPropertyAlreadySelected(this.getSelectedProperties(),s));};this._swapPropertiesBetweenControls=function(v,n){var c=this;return new Promise(function(r){var a=c.getPropertyTypeRow(v);var b;var o=a.propertyRowInformation.sProperty;c._getPropertyTypeRows().forEach(function(d){if(d.propertyRowInformation.sProperty===n){b=c.getPropertyTypeRow(d.controlId);}});b.propertyRowInformation.sProperty=o;a.propertyRowInformation.sProperty=n;c.updateAllDropDownsAsPromise().then(function(){b.oView.getController().setDetailData();r();});});};}var m={_updateDropDownOfAControl:function(p){var a=new Promise(function(r){var b=m._mapPropertyType2AggregationRole(p.sPropertyType);var v=p.oView.getViewData();var o=p.oView.getViewData().oPropertyOrchestration;var s=v.oStepPropertyMetadataHandler;var c=v.oParentObject.getId();var d=p.propertyRowInformation.sProperty;var i=p.propertyRowInformation.bMandatory;var S=s.oStep;var e=S.getType()==="hierarchicalStep";if(e&&p.sPropertyType===M.propertyTypes.REPRESENTATIONSORT){b=M.aggregationRoles.MEASURE;}m.getConsumableAndAvailablePropertiesAsPromise(c,b,s).then(function(u){var C=p.oView.getController();C.removeAllItemsFromDropDownList();var f=o.getSelectedProperties();var g=m._relativeComplement(u.available,f);C.setItemsOfDropDownList(g,u.available,d,i,b);r();});});return a;},getPropertyListAndSelectedKey:function(p,s,c,a,b){function d(l,i){return l.indexOf(i)!==-1;}function e(s,a){return d(a.available,s)?s:b([s],c.oTextReader)[0];}function g(s){return s!==c.oTextReader("none")&&s!==undefined;}var S=JSON.parse(JSON.stringify(p));var f=e(s,a);if(g(s)&&!d(p,s)){S=p.concat(f);}if(!c.oView.oViewData.oPropertyTypeData.bMandatory){S.splice(0,0,c.oTextReader("none"));}return{aAllProperties:S,sSelectedKey:f};},_mapPropertyType2AggregationRole:function(p){switch(p){case M.propertyTypes.DIMENSION:case M.propertyTypes.LEGEND:return M.aggregationRoles.DIMENSION;case M.propertyTypes.MEASURE:return M.aggregationRoles.MEASURE;default:return null;}},getConsumableAndAvailablePropertiesAsPromise:function(p,d,s){var a=new Promise(function(r){s.getEntityTypeMetadataAsPromise().then(function(e){var S=s.oStep;S.getConsumablePropertiesForRepresentation(p).then(function(c){var f=c.consumable.filter(function(b){var o=s.getPropertyMetadata(e,b);return(!d||o&&o["aggregation-role"]===d);});var F=c.available.filter(function(b){var o=s.getPropertyMetadata(e,b);return(!d||o&&o["aggregation-role"]===d);});r({available:F,consumable:f});});});});return a;},_relativeComplement:function(a,b){var f=JSON.parse(JSON.stringify(a));b.forEach(function(v){f=f.filter(function(c){return c!==v;});});return f;},_isPropertyAlreadySelected:function(s,p){function c(l,i){return l.indexOf(i)!==-1;}return c(s,p);},PropertyTypeOrchestration:P};return m;});
