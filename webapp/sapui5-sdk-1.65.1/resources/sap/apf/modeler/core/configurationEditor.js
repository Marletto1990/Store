/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.apf.modeler.core.configurationEditor");jQuery.sap.require("sap.apf.utils.utils");(function(){'use strict';sap.apf.modeler.core.ConfigurationEditor=function(c,a,b,d){var t=this;var f;var e;var g=a.instances.configurationHandler;var p=a.instances.persistenceProxy;var m=a.instances.messageHandler;var h=a.instances.metadataFactory;var j=true;var s,k,l,n,o,q;var r;var u=new a.constructors.ConfigurationObjects(a);var v=new a.constructors.ConfigurationFactory({instances:{messageHandler:m},constructors:{RegistryProbe:a.constructors.RegistryProbe}});if(!d){s=new a.constructors.ElementContainer("Step",a.constructors.Step,a);k=new a.constructors.ElementContainer("Category",undefined,a);l=new a.constructors.ElementContainer("FacetFilter",a.constructors.FacetFilter,a);n=new a.constructors.ElementContainer("NavigationTarget",a.constructors.NavigationTarget,a);o=new a.constructors.ElementContainer("CategoryStepAssignment",a.constructors.ElementContainer,a);q=[];f={smartFilterBar:true};}else{s=d.stepContainer;k=d.categoryContainer;r=d.smartFilterBar;l=d.facetFilterContainer;n=d.navigationTargetContainer;o=d.categoryStepAssignmentContainer;q=d.serviceList;e=d.applicationTitle;f=d.filterOption;}this.registerServiceAsPromise=function(i){var y=jQuery.Deferred();var z;if(q.indexOf(i)===-1){z=h.getMetadata(i);z.done(function(){if(q.indexOf(i)===-1){q.push(i);}y.resolve(true);});z.fail(function(){y.resolve(false);});}else{y.resolve(true);}return y.promise();};this.getAllServices=function(){return q;};this.getAllEntitySetsOfServiceAsPromise=function(i){return h.getEntitySets(i);};this.getAllHierarchicalEntitySetsOfServiceAsPromise=function(i){var y=jQuery.Deferred();h.getMetadata(i).done(function(z){if(z){y.resolve(z.getHierarchicalEntitySets());}y.resolve([]);}).fail(function(){y.resolve([]);});return y.promise();};this.checkIfHierarchicalEntitySetIsAvailableAsPromise=function(i){var y=jQuery.Deferred();this.getAllHierarchicalEntitySetsOfServiceAsPromise(i).done(function(z){if(z.length>0){y.resolve(true);}else{y.resolve(false);}});return y;};this.getHierarchicalPropertiesOfEntitySetAsPromise=function(i,y){var z=jQuery.Deferred();h.getMetadata(i).done(function(A){if(A){z.resolve(A.getHierarchicalPropertiesOfEntitySet(y));}else{z.resolve([]);}}).fail(function(){z.resolve([]);});return z;};this.getHierarchyNodeIdAsPromise=function(i,y,z){var A;var B=jQuery.Deferred();h.getMetadata(i).done(function(C){if(C){A=C.getHierarchyAnnotationsForProperty(y,z);if(A&&A.hierarchyNodeFor){B.resolve(A.hierarchyNodeFor);}else{B.resolve(null);}}else{B.resolve(null);}}).fail(function(){B.resolve(null);});return B;};this.getNonHierarchicalPropertiesOfEntitySet=function(i,y){var z;var A=jQuery.Deferred();h.getMetadata(i).then(function(B){z=B.getNonHierarchicalPropertiesOfEntitySet(y);A.resolve(z);},function(){A.resolve([]);});return A;};this.getAllEntitySetsExceptParameterEntitySets=function(i){return h.getAllEntitySetsExceptParameterEntitySets(i);};this.getAllEntitySetsOfServiceWithGivenPropertiesAsPromise=function(y,z){var A=[];var B=jQuery.Deferred();this.getAllEntitySetsOfServiceAsPromise(y).done(function(C){if(!z||z.length===0){B.resolve(C);return;}h.getMetadata(y).done(function(D){C.forEach(function(E){var F=D.getFilterableProperties(E);var G=true;for(var i=0;i<z.length;i++){if(F.indexOf(z[i])<=-1){G=false;break;}}if(G){A.push(E);}});B.resolve(A);});});return B.promise();};this.getAllPropertiesOfEntitySetAsPromise=function(i,y){var z=jQuery.Deferred();h.getMetadata(i).done(function(A){z.resolve(A.getAllPropertiesOfEntitySet(y));}).fail(function(){z.resolve([]);});return z.promise();};this.getAllKnownPropertiesAsPromise=function(){var i=jQuery.Deferred();var y=[];var z=q.length;q.forEach(function(A){h.getMetadata(A).done(function(B){y=y.concat(B.getAllProperties());z--;if(z===0){y=sap.apf.utils.eliminateDuplicatesInArray(m,y);i.resolve(y);}});});return i.promise();};this.getFilterablePropertiesAndParametersAsPromise=function(){var i=jQuery.Deferred();var y=[];var z=q.length;q.forEach(function(A){h.getMetadata(A).done(function(B){y=y.concat(B.getFilterablePropertiesAndParameters());if(--z===0){i.resolve(sap.apf.utils.eliminateDuplicatesInArray(m,y));}});});if(z===0){i.resolve([]);}return i.promise();};this.setApplicationTitle=function(i){j=false;e=i;};this.getApplicationTitle=function(){return e;};this.getConfigurationName=function(){return g.getConfiguration(c.id||c).AnalyticalConfigurationName;};this.getCategoryStepAssignments=function(i){var y=[];if(!this.getCategory(i)){return false;}var z=o.getElement(i);if(z){z.getElements().forEach(function(A){y.push(A.stepId);});}return y;};this.addCategoryStepAssignment=function(i,y){if(!this.getCategory(i)||!this.getStep(y)){return false;}var z=o.getElement(i);if(!z){o.createElementWithProposedId({},i);z=o.getElement(i);}if(!z.getElement(y)){z.createElementWithProposedId({stepId:y},y);return true;}return false;};this.removeCategoryStepAssignment=function(i,y){var z;if(!y){var A=this.getCategoryStepAssignments(i);z=o.removeElement(i);if(z){w(A);}return!!z;}var B=o.getElement(i);if(!B){return false;}z=B.removeElement(y);if(B.getElements().length===0){o.removeElement(i);}if(z){w([y]);}return!!z;};function w(i){if(!i){return;}i.forEach(function(y){if(t.getCategoriesForStep(y).length===0){s.removeElement(y);}});}this.moveCategoryStepAssignmentBefore=function(i,y,z){var A=o.getElement(i);if(!A){return null;}return A.moveBefore(y,z);};this.moveCategoryStepAssignmentToEnd=function(i,y){var z=o.getElement(i);if(!z){return null;}return z.moveToEnd(y);};this.moveCategoryStepAssignmentUpOrDown=function(i,y,z){var A=o.getElement(i);if(!A){return null;}return A.moveUpOrDown(y,z);};this.getCategory=k.getElement;this.setCategory=function(i,y){j=false;return k.setElement(i,y);};this.createCategoryWithId=function(i,y){j=false;return k.createElementWithProposedId(i,y).getId();};this.removeCategory=function(i){var y=t.getCategoryStepAssignments(i);if(y){y.forEach(function(z){var A=t.getCategoriesForStep(z);if(!A||A.length<2){s.removeElement(z);}});}k.removeElement(i);};this.getCategories=k.getElements;this.copyCategory=function(i){var y=k.copyElement(i);if(!y){return;}t.getCategoryStepAssignments(i).forEach(function(z){_(z,y);});return y;};this.moveCategoryBefore=function(i,y){return k.moveBefore(i,y);};this.moveCategoryToEnd=function(i){return k.moveToEnd(i);};this.moveCategoryUpOrDown=function(i,y){return k.moveUpOrDown(i,y);};this.serialize=function(){return u.serializeConfiguration(t);};this.isSaved=function(){return j;};this.setIsUnsaved=function(){j=false;};this.save=function(i){var y;function z(C,D,E){if(!E){j=true;g.replaceConfigurationId(c.id||c,C.AnalyticalConfiguration);g.updateConfigurationName(c.id||c,y);c=C.AnalyticalConfiguration;}i(c,D,E);}function A(C,D){if(!D){j=true;}g.updateConfigurationName(c.id||c,y);i(c.id||c,C,D);}y=g.getConfiguration(c.id||c).AnalyticalConfigurationName;var B={AnalyticalConfiguration:"",AnalyticalConfigurationName:y,Application:g.getApplicationId(),SerializedAnalyticalConfiguration:JSON.stringify(this.serialize()),CreatedByUser:"",CreationUTCDateTime:null,LastChangeUTCDateTime:null,LastChangedByUser:""};if(typeof c==='string'){if(c.indexOf("apf1972-")===0){p.create("configuration",B,z);}else{B.AnalyticalConfiguration=c;p.update("configuration",B,A,[{name:"AnalyticalConfiguration",value:c}]);}}else{if(c.id.indexOf("apf1972-")===0){B.AnalyticalConfiguration="";B.CreationUTCDateTime=null;B.LastChangeUTCDateTime=null;}else{B.AnalyticalConfiguration=c.id;B.CreationUTCDateTime=c.creationDate;B.LastChangeUTCDateTime=c.lastChangeDate;}if(c.updateExisting){p.update("configuration",B,A,[{name:"AnalyticalConfiguration",value:c.id}]);}else{p.create("configuration",B,z);}}};this.getFilterOption=function(){return jQuery.sap.extend({},f);};this.setFilterOption=function(i){if(i.none===true){r=null;y.call(this);z();}if(i.smartFilterBar===true){y.call(this);A();}if(i.facetFilter===true){r=null;B();}function y(){this.getFacetFilters().forEach(function(C){this.removeFacetFilter(C.getId());}.bind(this));}function z(){delete f.smartFilterBar;delete f.facetFilter;f.none=true;}function A(){f.smartFilterBar=true;delete f.facetFilter;delete f.none;}function B(){delete f.smartFilterBar;f.facetFilter=true;delete f.none;}};this.isDataLostByFilterOptionChange=function(){if(f.smartFilterBar===true){if(r&&(r.getService()||r.getEntitySet())){return true;}}if(f.facetFilter===true){if(l.getElements().length>0){return true;}}return false;};this.getSmartFilterBar=function(){if(f.smartFilterBar===true){if(!r){r=new a.constructors.SmartFilterBar("SmartFilterBar-1");}return r;}return null;};this.createFacetFilterWithId=function(i){if(f.facetFilter===true){return l.createElementWithProposedId(undefined,i).getId();}return null;};this.createFacetFilter=function(){if(f.facetFilter===true){return l.createElement().getId();}return null;};this.removeFacetFilter=l.removeElement;this.getFacetFilter=l.getElement;this.getFacetFilters=l.getElements;this.copyFacetFilter=l.copyElement;this.moveFacetFilterBefore=function(i,y){return l.moveBefore(i,y);};this.moveFacetFilterToEnd=function(i){return l.moveToEnd(i);};this.moveFacetFilterUpOrDown=function(i,y){return l.moveUpOrDown(i,y);};this.createNavigationTargetWithId=function(i){return n.createElementWithProposedId(undefined,i).getId();};this.createNavigationTarget=function(){return n.createElement().getId();};this.removeNavigationTarget=function(i){var y=n.getElement(i);if(!y){return;}n.removeElement(i);if(y.isStepSpecific()){var z=this.getStepsAssignedToNavigationTarget(i);var A,S;for(A=0;A<z.length;A++){S=this.getStep(z[A]);S.removeNavigationTarget(i);}}};this.getNavigationTarget=n.getElement;this.getNavigationTargets=n.getElements;this.copyNavigationTarget=function(i){var y=n.copyElement(i);var z=n.getElement(y);if(z.isStepSpecific()){var A=this.getStepsAssignedToNavigationTarget(i);var B,S;for(B=0;B<A.length;B++){S=this.getStep(A[B]);S.addNavigationTarget(y);}}return y;};this.moveNavigationTargetBefore=function(i,y){return n.moveBefore(i,y);};this.moveNavigationTargetToEnd=function(i){return n.moveToEnd(i);};this.moveNavigationTargetUpOrDown=function(i,y){return n.moveUpOrDown(i,y);};this.createStepWithId=function(i){return s.createElementWithProposedId(undefined,i).getId();};this.createStep=function(i){if(!this.getCategory(i)){return;}var y=s.createElement().getId();this.addCategoryStepAssignment(i,y);return y;};this.createHierarchicalStepWithId=function(i){return s.createElementWithProposedId(undefined,i,a.constructors.HierarchicalStep).getId();};this.createHierarchicalStep=function(i){if(!this.getCategory(i)){return;}var y=s.createElement(undefined,a.constructors.HierarchicalStep).getId();this.addCategoryStepAssignment(i,y);return y;};this.getStep=s.getElement;this.getSteps=s.getElements;this.getStepsNotAssignedToCategory=function(i){var y=this.getCategoryStepAssignments(i);var z=[];t.getSteps().forEach(function(A){var B=A.getId();if(y.indexOf(B)===-1){z.push(B);}});return z;};this.copyStep=function(i){var y=_(i);var z=this.getCategoriesForStep(i);if(!y){return false;}if(z){z.forEach(function(A){t.addCategoryStepAssignment(A,y);});}return y;};function _(i,y){if(y&&!t.getCategory(y)){return false;}var z=s.copyElement(i);if(!z){return false;}if(y){t.addCategoryStepAssignment(y,z);}return z;}this.getCategoriesForStep=function getCategoriesForStep(i){var y=[];var z=t.getCategories();if(z){z.forEach(function(A){var B=A.getId();var C=t.getCategoryStepAssignments(B);if(C&&C.indexOf(i)>-1){y.push(B);}});}return y;};this.getAssignableStepsForNavigationTarget=function(i){var y=[];t.getSteps().forEach(function(z){var A=false;z.getNavigationTargets().forEach(function(B){if(i===B){A=true;}});if(!A){y.push(z.getId());}});return y;};this.getStepsAssignedToNavigationTarget=function(i){var y=[];t.getSteps().forEach(function(z){var A=false;z.getNavigationTargets().forEach(function(B){if(i===B){A=true;}});if(A){y.push(z.getId());}});return y;};this.copy=function(i){var y={stepContainer:s,categoryContainer:k,facetFilterContainer:l,navigationTargetContainer:n,categoryStepAssignmentContainer:o,applicationTitle:e,serviceList:q,filterOption:f};var d=sap.apf.modeler.core.ConfigurationObjects.deepDataCopy(y);if(f.smartFilterBar===true&&r){d.smartFilterBar=z();}return new sap.apf.modeler.core.ConfigurationEditor(i,a,undefined,d);function z(){var A=new a.constructors.SmartFilterBar(r.getId());A.setService(r.getService());A.setEntitySet(r.getEntitySet(),!r.isEntityTypeConverted());return A;}};if(typeof c==='string'){if(c.indexOf("apf1972-")===0){j=false;if(b){b(t,undefined);}}else if(!d){x(c,p,function(i,y){if(!y){var z=JSON.parse(i.SerializedAnalyticalConfiguration);t.setApplicationTitle(z.applicationTitle);v.loadConfig(z,true);u.mapToDesignTimeAsPromise(v.getRegistry(),t).then(function(){j=true;b(t,undefined);});}else{b(undefined,y);}});}}else{v.loadConfig(c.content,true);u.mapToDesignTimeAsPromise(v.getRegistry(),this).then(function(){if(b){b(t,undefined);}});}function x(i,y,b){y.readEntity("configuration",function(z,A,B){b(z,B);},[{name:"AnalyticalConfiguration",value:i}],undefined,g.getApplicationId());}};}());
