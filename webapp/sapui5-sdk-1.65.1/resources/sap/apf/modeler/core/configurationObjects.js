/*!
 * SAP APF Analysis Path Framework
 *
 * (c) Copyright 2012-2014 SAP SE. All rights reserved
 */
jQuery.sap.declare("sap.apf.modeler.core.configurationObjects");(function(){'use strict';sap.apf.modeler.core.ConfigurationObjects=function(i){var t=this;var H,a,p,m;var b=i.instances.metadataFactory;if(i.constructors&&i.constructors.Hashtable){H=i.constructors.Hashtable;}if(i.instances.textPool){a=i.instances.textPool;}if(i.instances.persistenceProxy){p=i.instances.persistenceProxy;}if(i.instances.messageHandler){m=i.instances.messageHandler;}function c(l,n){var P=[];if(n){P.push(n);}m.putMessage(m.createMessageObject({code:l,aParameters:P}));}function d(l){var r=l&&l.type&&l.type==="label"&&l.kind&&l.kind==="text"&&l.key&&typeof l.key==="string";if(!r){c(11030,l.key);}return r;}this.serializeLabelKey=function(l){return{type:"label",kind:"text",key:a.getPersistentKey(l)};};this.serializeAndAddThumbnail=function(l,n){var o=l.getLeftLowerCornerTextKey();var q=l.getLeftUpperCornerTextKey();var r=l.getRightUpperCornerTextKey();var u=l.getRightLowerCornerTextKey();var v={type:"thumbnail"};if(q){v.leftUpper=this.serializeLabelKey(q);}if(o){v.leftLower=this.serializeLabelKey(o);}if(r){v.rightUpper=this.serializeLabelKey(r);}if(u){v.rightLower=this.serializeLabelKey(u);}if(v.leftLower||v.leftUpper||v.rightLower||v.rightUpper){n.thumbnail=v;}};this.serializeCategory=function(l,n){var T=a.get(l.labelKey);var o=[];if(n){n.forEach(function(r){o.push({type:"step",id:r});});}var q=(T&&T.TextElementDescription)||"";return{type:"category",description:q,id:l.getId(),label:t.serializeLabelKey(l.labelKey),steps:o};};this.validateCategory=function(l){var r=l&&l.type&&l.type==="category"&&l.id&&l.steps&&d(l.label);if(r){l.steps.forEach(function(o){if(!o.type||o.type!=="step"||!o.id){r=false;}});}if(!r){c(11031,l.id);}return r;};this.validateRequest=function(r){var l=r&&r.id&&r.type==="request"&&r.service&&typeof r.service==="string"&&((r.entityType&&typeof r.entityType==="string")||(r.entitySet&&typeof r.entitySet==="string"))&&r.selectProperties&&r.selectProperties&&r.selectProperties instanceof Array&&r.selectProperties.length>=0;if(!l){c(11032,r.id);}return l;};this.validateBinding=function(l){var r=l&&l.id&&l.type==="binding"&&l.requiredFilters&&l.requiredFilters instanceof Array&&l.requiredFilters.length>=0&&l.representations&&l.representations instanceof Array;if(!r){c(11033,l.id);}return r;};this.validateFacetFilter=function(l){var r=l&&l.id&&l.property&&l.type==="facetFilter";if(!r){c(11034,l.id);}return r;};this.validateNavigationTarget=function(n){var r=n&&n.id&&n.semanticObject&&n.action&&n.type==="navigationTarget"&&n.hasOwnProperty("isStepSpecific");if(!r){c(11040,n.id);}return r;};this.validateStep=function(l){var r=l&&l.id&&l.type==="step"&&d(l.title)&&d(l.longTitle)&&l.hasOwnProperty("navigationTargets");if(!r){c(11035,l.id);}return r;};this.validateConfiguration=function(l){var r=l&&l.applicationTitle&&l.applicationTitle.key&&typeof l.applicationTitle.key==='string'&&l.steps&&l.steps instanceof Array&&l.steps.length>=0&&l.requests&&l.requests instanceof Array&&l.requests.length>=0&&l.bindings&&l.bindings instanceof Array&&l.bindings.length>=0&&l.representationTypes&&l.representationTypes instanceof Array&&l.representationTypes.length>=0&&l.categories&&l.categories instanceof Array&&l.categories.length>=0;if(!r){c(11036);}return r;};function s(l){var r=[];var n,o;var q,u;var v;var w;var x;var y;var z=l.getRepresentations();z.forEach(function(A){n=[];o=A.getDimensions();o.forEach(function(C){var D={fieldName:C};if(A.getDimensionKind(C)){D.kind=A.getDimensionKind(C);}if(A.getDimensionTextLabelKey(C)){D.fieldDesc={type:'label',kind:'text',key:A.getDimensionTextLabelKey(C)};}if(A.getLabelDisplayOption(C)){D.labelDisplayOption=A.getLabelDisplayOption(C);}n.push(D);});q=[];u=A.getMeasures();u.forEach(function(C){var D={fieldName:C};if(A.getMeasureKind(C)){D.kind=A.getMeasureKind(C);}if(A.getMeasureTextLabelKey(C)){D.fieldDesc={type:'label',kind:'text',key:A.getMeasureTextLabelKey(C)};}if(A.getMeasureDisplayOption(C)){D.measureDisplayOption=A.getMeasureDisplayOption(C);}q.push(D);});v=[];A.getProperties().forEach(function(C){var D={fieldName:C};if(A.getPropertyKind(C)){D.kind=A.getPropertyKind(C);}if(A.getPropertyTextLabelKey(C)){D.fieldDesc={type:'label',kind:'text',key:A.getPropertyTextLabelKey(C)};}v.push(D);});var B=[{}];if(A.getHierarchyProperty()){B[0].fieldName=A.getHierarchyProperty();B[0].kind="hierarchicalColumn";if(A.getHierarchyPropertyTextLabelKey()){B[0].fieldDesc={type:'label',kind:'text',key:A.getHierarchyPropertyTextLabelKey()};}B[0].labelDisplayOption=A.getHierarchyPropertyLabelDisplayOption();}w=[];A.getOrderbySpecifications().forEach(function(C){w.push({property:C.property,ascending:C.ascending});});x={id:A.getId(),representationTypeId:A.getRepresentationType(),parameter:{dimensions:n,measures:q,properties:v,hierarchicalProperty:B,alternateRepresentationTypeId:A.getAlternateRepresentationType()}};if(A.getWidthProperties()){x.parameter.width=A.getWidthProperties();}if(w.length>0){x.parameter.orderby=w;}y=A.getTopN();if(y&&y>0){x.parameter.top=y;}t.serializeAndAddThumbnail(A,x);r.push(x);});return r;}this.serializeBinding=function(l,n){var o="binding-for-"+l.getId();var T=a.get(l.getTitleId());var q=(T&&T.TextElementDescription)||"";if(l.getFilterPropertyLabelKey()||l.getFilterPropertyLabelDisplayOption()){var r={labelDisplayOption:l.getFilterPropertyLabelDisplayOption()};if(l.getFilterPropertyLabelKey()){r.fieldDesc=this.serializeLabelKey(l.getFilterPropertyLabelKey());}}n.bindings.push({type:"binding",id:o,stepDescription:q,requiredFilters:l.getFilterProperties(),requiredFilterOptions:r,representations:s(l)});return o;};this.serializeRequest=function(l,n){var r;var o="request-for-"+l.getId();r={type:"request",id:o,service:l.getService(),entitySet:l.getEntitySet(),selectProperties:l.getSelectProperties()};n.requests.push(r);return o;};this.serializeFilterMappingRequest=function(o,l){var r="request-for-FilterMapping"+o.getId();var n={type:"request",id:r,service:o.getFilterMappingService(),entitySet:o.getFilterMappingEntitySet(),selectProperties:o.getFilterMappingTargetProperties()};l.requests.push(n);return r;};this.serializeStep=function(l,n){var r=t.serializeRequest(l,n);var o=t.serializeBinding(l,n);var T=a.get(l.getTitleId());var q=(T&&T.TextElementDescription)||"";var u=l.getLongTitleId();var v;var w={type:l.getType(),description:q,request:r,binding:o,id:l.getId(),title:t.serializeLabelKey(l.getTitleId()),navigationTargets:[]};if(l.getHierarchyProperty&&l.getHierarchyProperty()){w.hierarchyProperty=l.getHierarchyProperty();}if(l.getFilterMappingService()){w.filterMapping={requestForMappedFilter:t.serializeFilterMappingRequest(l,n),target:l.getFilterMappingTargetProperties(),targetPropertyLabelKey:l.getFilterMappingTargetPropertyLabelKey(),targetPropertyDisplayOption:l.getFilterMappingTargetPropertyLabelDisplayOption(),keepSource:l.getFilterMappingKeepSource()?"true":"false"};}v=l.getTopN();if(v){w.topNSettings=v;}if(u!==""&&u!==undefined){w.longTitle=t.serializeLabelKey(l.getLongTitleId());}this.serializeAndAddThumbnail(l,w);l.getNavigationTargets().forEach(function(x){w.navigationTargets.push({type:"navigationTarget",id:x});});return w;};this.serializeFacetFilter=function(l,n){var r,o,v;if(l.getServiceOfFilterResolution()){r=u("FilterResolution",l,n);}if(l.getUseSameRequestForValueHelpAndFilterResolution()){o=r;}else if(l.getServiceOfValueHelp()){o=u("ValueHelp",l,n);}var T=a.get(l.getLabelKey());var q=(T&&T.TextElementDescription)||"";if(l.getValueList().length>0){v=l.getValueList();}return{type:"facetFilter",description:q,id:l.getId(),alias:l.getAlias(),property:l.getProperty(),multiSelection:l.isMultiSelection()+"",preselectionFunction:l.getPreselectionFunction(),preselectionDefaults:w(),valueList:v,label:t.serializeLabelKey(l.getLabelKey()),invisible:!l.isVisible(),filterResolutionRequest:r,valueHelpRequest:o,hasAutomaticSelection:l.getAutomaticSelection()+"",useSameRequestForValueHelpAndFilterResolution:l.getUseSameRequestForValueHelpAndFilterResolution()+""};function u(x,l,n){var y;var z;var A;var B;switch(x){case"ValueHelp":z=l.getServiceOfValueHelp();A=l.getEntitySetOfValueHelp();B=l.getSelectPropertiesOfValueHelp();break;case"FilterResolution":z=l.getServiceOfFilterResolution();A=l.getEntitySetOfFilterResolution();B=l.getSelectPropertiesOfFilterResolution();break;}var C=x+"-request-for-"+l.getId();y={type:"request",id:C,service:z,entitySet:A,selectProperties:B};n.requests.push(y);return C;}function w(){if(l.getNoneSelection()===true){return null;}return l.getPreselectionDefaults();}};this.serializeNavigationTarget=function(n,l){var r={type:"navigationTarget",id:n.getId(),semanticObject:n.getSemanticObject(),action:n.getAction(),isStepSpecific:n.isStepSpecific(),useDynamicParameters:n.getUseDynamicParameters(),parameters:n.getAllNavigationParameters()};if(n.getFilterMappingService()){r.filterMapping={requestForMappedFilter:t.serializeFilterMappingRequest(n,l),target:n.getFilterMappingTargetProperties()};}if(n.getTitleKey()){r.title={key:n.getTitleKey(),type:"label",kind:"text"};}return r;};this.serializeSmartFilterBar=function(l){if(l){if(!l.isEntityTypeConverted()){return{id:l.getId(),type:'smartFilterBar',service:l.getService(),entityType:l.getEntitySet()};}return{id:l.getId(),type:'smartFilterBar',service:l.getService(),entitySet:l.getEntitySet()};}};this.serializeConfiguration=function(l){var n={analyticalConfigurationName:l.getConfigurationName(),applicationTitle:t.serializeLabelKey(l.getApplicationTitle()),steps:[],requests:[],bindings:[],representationTypes:[],categories:[],navigationTargets:[]};var o={requests:n.requests,bindings:n.bindings};l.getCategories().forEach(function(q){var r=l.getCategoryStepAssignments(q.getId());n.categories.push(t.serializeCategory(q,r));});l.getSteps().forEach(function(q){var r=t.serializeStep(q,o);n.steps.push(r);});l.getFacetFilters().forEach(function(q){var r=t.serializeFacetFilter(q,o);if(n.facetFilters===undefined){n.facetFilters=[];}n.facetFilters.push(r);});if(l.getFilterOption().facetFilter===true&&n.facetFilters===undefined){n.facetFilters=[];}l.getNavigationTargets().forEach(function(q){var r=t.serializeNavigationTarget(q,o);n.navigationTargets.push(r);});var S=this.serializeSmartFilterBar(l.getSmartFilterBar());if(S!==undefined){n.smartFilterBar=S;}return n;};function e(l,n){var o=l.thumbnail;if(!o){return;}if(o.leftLower){n.setLeftLowerCornerTextKey(o.leftLower.key);}if(o.leftUpper){n.setLeftUpperCornerTextKey(o.leftUpper.key);}if(o.rightLower){n.setRightLowerCornerTextKey(o.rightLower.key);}if(o.rightUpper){n.setRightUpperCornerTextKey(o.rightUpper.key);}}function f(l,r,n){var o=[];var q;var u;if(l.type==="hierarchicalStep"){q=n.createHierarchicalStepWithId(l.id);u=n.getStep(q);u.setHierarchyProperty(l.hierarchyProperty);}else{q=n.createStepWithId(l.id);u=n.getStep(q);}var v=r.getItem(l.request);if(v.entityType){v.entitySet=v.entityType;delete v.entityType;}if(v.service){o.push(n.registerServiceAsPromise(v.service));}u.setService(v.service);u.setEntitySet(v.entitySet);u.setTitleId(l.title.key);if(l.longTitle&&l.longTitle.key){u.setLongTitleId(l.longTitle.key);}if(l.navigationTargets){l.navigationTargets.forEach(function(x){u.addNavigationTarget(x.id);});}e(l,u);v.selectProperties.forEach(function(x){u.addSelectProperty(x);});var w=r.getItem(l.binding);w.requiredFilters.forEach(function(x){u.addFilterProperty(x);});if(w.requiredFilterOptions){u.setFilterPropertyLabelDisplayOption(w.requiredFilterOptions.labelDisplayOption);if(w.requiredFilterOptions.fieldDesc){u.setFilterPropertyLabelKey(w.requiredFilterOptions.fieldDesc.key);}}w.representations.forEach(function(x){var y;var z=u.getRepresentation(u.createRepresentation({id:x&&x.id}).getId());z.setRepresentationType(x.representationTypeId);z.setAlternateRepresentationType(x.parameter.alternateRepresentationTypeId);if(x.parameter.hierarchicalProperty&&x.parameter.hierarchicalProperty[0]&&x.parameter.hierarchicalProperty[0].fieldDesc){z.setHierarchyPropertyTextLabelKey(x.parameter.hierarchicalProperty[0].fieldDesc.key);}if(x.parameter.hierarchicalProperty&&x.parameter.hierarchicalProperty[0]){z.setHierarchyPropertyLabelDisplayOption(x.parameter.hierarchicalProperty[0].labelDisplayOption);}x.parameter.dimensions.forEach(function(A){z.addDimension(A.fieldName);if(A.fieldDesc){z.setDimensionTextLabelKey(A.fieldName,A.fieldDesc.key);}if(A.kind){z.setDimensionKind(A.fieldName,A.kind);}if(A.labelDisplayOption){z.setLabelDisplayOption(A.fieldName,A.labelDisplayOption);}});x.parameter.measures.forEach(function(A){z.addMeasure(A.fieldName);if(A.fieldDesc){z.setMeasureTextLabelKey(A.fieldName,A.fieldDesc.key);}if(A.kind){z.setMeasureKind(A.fieldName,A.kind);}if(A.measureDisplayOption){z.setMeasureDisplayOption(A.fieldName,A.measureDisplayOption);}});if(x.parameter.properties){x.parameter.properties.forEach(function(A){z.addProperty(A.fieldName);if(A.fieldDesc){z.setPropertyTextLabelKey(A.fieldName,A.fieldDesc.key);}if(A.kind){z.setPropertyKind(A.fieldName,A.kind);}});}if(x.parameter.width){for(y in x.parameter.width){if(x.parameter.width.hasOwnProperty(y)){z.setWidthProperty(y,x.parameter.width[y]);}}}if(x.parameter.orderby&&!x.parameter.topN){x.parameter.orderby.forEach(function(A){z.addOrderbySpec(A.property,A.ascending);});}e(x,z);});if(l.filterMapping){o.push(j(l.filterMapping,u,r,n));}if(l.topNSettings){u.setTopN(l.topNSettings.top,l.topNSettings.orderby);}return Promise.all(o);}function g(l,r,n){var o=[];var q=n.createFacetFilterWithId(l.id);var u=n.getFacetFilter(q);u.setLabelKey(l.label.key);u.setAlias(l.alias);u.setProperty(l.property);if(l.preselectionFunction&&l.preselectionFunction!==""){u.setPreselectionFunction(l.preselectionFunction);}else if(l.preselectionDefaults===null){u.setNoneSelection(true);}else{u.setPreselectionDefaults(l.preselectionDefaults);}if(l.valueList){u.setValueList(l.valueList);}if(l.useSameRequestForValueHelpAndFilterResolution&&l.useSameRequestForValueHelpAndFilterResolution==="true"){u.setUseSameRequestForValueHelpAndFilterResolution(true);}else{u.setUseSameRequestForValueHelpAndFilterResolution(false);}if(l.multiSelection==="true"){u.setMultiSelection(true);}if(l.invisible===true){u.setInvisible();}if(l.hasAutomaticSelection==="true"){u.setAutomaticSelection(true);}else{u.setAutomaticSelection(false);}if(l.valueHelpRequest){var v=r.getItem(l.valueHelpRequest);if(v.entityType){v.entitySet=v.entityType;delete v.entityType;}if(v.service){o.push(n.registerServiceAsPromise(v.service));u.setServiceOfValueHelp(v.service);}if(v.entitySet){u.setEntitySetOfValueHelp(v.entitySet);}v.selectProperties.forEach(function(x){u.addSelectPropertyOfValueHelp(x);});}if(l.filterResolutionRequest){var w=r.getItem(l.filterResolutionRequest);if(w.entityType){w.entitySet=w.entityType;delete w.entityType;}if(w.service){o.push(n.registerServiceAsPromise(w.service));u.setServiceOfFilterResolution(w.service);}if(w.entitySet){u.setEntitySetOfFilterResolution(w.entitySet);}w.selectProperties.forEach(function(x){u.addSelectPropertyOfFilterResolution(x);});}return Promise.all(o);}function h(l,r,n){return new Promise(function(o,q){var u=n.createNavigationTargetWithId(l.id);var v=n.getNavigationTarget(u);v.setSemanticObject(l.semanticObject);v.setAction(l.action);if(l.parameters){l.parameters.forEach(function(w){v.addNavigationParameter(w.key,w.value);});}if(l.isStepSpecific===true){v.setStepSpecific();}else{v.setGlobal();}if(l.useDynamicParameters===true){v.setUseDynamicParameters(true);}if(l.filterMapping){j(l.filterMapping,v,r,n).then(function(){o();});}else{o();}if(l.title&&l.title.key){v.setTitleKey(l.title.key);}});}function j(l,n,r,o){return new Promise(function(q,u){var v=r.getItem(l.requestForMappedFilter);if(v.entityType){v.entitySet=v.entityType;delete v.entityType;}if(v.service){o.registerServiceAsPromise(v.service).done(function(){q();});}else{q();}n.setFilterMappingService(v.service);n.setFilterMappingEntitySet(v.entitySet);l.target.forEach(function(w){n.addFilterMappingTargetProperty(w);});if(l.targetPropertyLabelKey){n.setFilterMappingTargetPropertyLabelKey(l.targetPropertyLabelKey);}if(l.targetPropertyDisplayOption){n.setFilterMappingTargetPropertyLabelDisplayOption(l.targetPropertyDisplayOption);}if(l.hasOwnProperty("keepSource")){if(l.keepSource==="true"){n.setFilterMappingKeepSource(true);}else{n.setFilterMappingKeepSource(false);}}});}function k(r,l){var n=[];n.unshift(new Promise(function(o){var q=r.getItem("SmartFilterBar-1");if(q){l.setFilterOption({smartFilterBar:true});var u=l.getSmartFilterBar();u.setService(q.service);if(q.service){n.push(l.registerServiceAsPromise(q.service));}if(q.entitySet){u.setEntitySet(q.entitySet);o(true);}else if(q.entityType){b.getMetadata(q.service).done(function(v){if(v){var w=v.getEntitySetByEntityType(q.entityType);if(w){u.setEntitySet(w);}else{u.setEntitySet(q.entityType,true);c("11524",[q.entityType]);}}o(true);}).fail(function(){u.setEntitySet(q.entityType,true);c("11524",[q.entityType]);o(true);});}else{o(true);}}else{o(false);}}));return Promise.all(n);}this.mapToDesignTimeAsPromise=function(r,l){var n;var o=false;var q=[];l.setApplicationTitle(r.getItem('applicationTitle').key);r.getSteps().forEach(function(u){q.push(f(u,r,l));});r.getCategories().forEach(function(u){l.createCategoryWithId({labelKey:u.label.key},u.id);u.steps.forEach(function(v){l.addCategoryStepAssignment(u.id,v.id);});});n=r.getFacetFilters();if(n.emptyArray===true){o=true;l.setFilterOption({facetFilter:true});}else{n.forEach(function(u){o=true;l.setFilterOption({facetFilter:true});q.push(g(u,r,l));});}r.getNavigationTargets().forEach(function(u){q.push(h(u,r,l));});q.push(new Promise(function(u){k(r,l).then(function(v){var w=v[0];if(!o&&!w){l.setFilterOption({none:true});}u();});}));return Promise.all(q);};this.loadAllConfigurations=function(l,n){var o=new sap.apf.core.utils.Filter(m,'Application','eq',l);p.readCollection("configuration",function(r,q,u){n(r,q,u);},undefined,["AnalyticalConfiguration","SerializedAnalyticalConfiguration"],o);};this.getTextKeysFromAllConfigurations=function(l,n){this.loadAllConfigurations(l,function(o,q,r){var u=new H(m);if(r){n(undefined,r);return;}o.forEach(function(v){var w=JSON.parse(v.SerializedAnalyticalConfiguration);var x=sap.apf.modeler.core.ConfigurationObjects.getTextKeysFromConfiguration(w);x.forEach(function(y){u.setItem(y,y);});});n(u,undefined);});};};sap.apf.modeler.core.ConfigurationObjects.deepDataCopy=function deepDataCopy(i){var r;if(!i){r=i;}else if(i.copy&&typeof i.copy==="function"){r=i.copy();}else if(i&&typeof i==="object"){if(i instanceof Array){r=[];i.forEach(function(a){r.push(deepDataCopy(a));});}else{r={};for(var a in i){if(!i.hasOwnProperty(a)){continue;}r[a]=deepDataCopy(i[a]);}}}else{r=i;}return r;};sap.apf.modeler.core.ConfigurationObjects.getTextKeysFromConfiguration=function getTextKeysFromConfiguration(c){var r=[];if(!c){return undefined;}if(c.type==="label"&&c.kind==="text"&&c.key){return[c.key];}for(var i in c){if(typeof c[i]!=="object"||!c.hasOwnProperty(i)){continue;}Array.prototype.push.apply(r,getTextKeysFromConfiguration(c[i]));}return r;};}());
